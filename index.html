<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Munetios Calendar</title>
    <link rel="icon" href="icons/icon-192.png" type="image/x-icon">
<meta name="theme-color" content="#3c0a7b">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            margin: 0;
            padding: 0;
            
        }
        body.dark-mode {
            background-color: #2b0053;
            color: #e0e0e0;
        }
        body.dark-mode .topbar {
            background-color: #3c0a7b;
            color: #e0e0e0;
        }
        body.dark-mode .modal {
            background: #3c0a7b;
            color: #e0e0e0;
        }
        body.dark-mode .modal-content {
            background: #3c0a7b;
            color: #e0e0e0;
        }
        body.dark-mode .top-left .logo-text {
            color: #e0e0e0;
        }
        body.dark-mode .top-left .menu-btn svg {
            fill: #e0e0e0 !important;
        }
        body.dark-mode .search-bar {
            background-color: #1d1d1d;
            color: #e0e0e0;
        }
        body.dark-mode .sidebar {
            background-color: #280049;
            color: #e0e0e0;
        } 
        body.dark-mode .main-calendar-container {
            background: #280049 !important;
            color: #e0e0e0;
            }
            body.dark-mode #main-calendar-header span,
            body.dark-mode #main-calendar-month {
            color: #fff !important;
            }
            body.dark-mode #main-calendar-container table {
            color: #e0e0e0 !important;
            }
            body.dark-mode #main-calendar-container th {
            color: #e0e0e0 !important;
            }
            body.dark-mode #main-calendar-container td span {
            color: #fff !important;
            }
            body.dark-mode #main-calendar-container td span[style*="background:#8200fc"] {
            background: #8200fc !important;
            color: #fff !important;
            }
        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #fff;
            padding: 10px 25px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            gap: 20px; /* Add gap between left and right */
        }
        .topbar, .content {
             min-width: 1800px;
        }
        
       
    .apps-wrapper {
        max-width: 420px;
        margin: 0 auto;
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 4px 24px rgba(44,0,83,0.10);
        padding: 22px 18px 18px 18px;
        display: none; /* Hidden by default */
        flex-direction: column;
        align-items: stretch;
        position: absolute;
        top: 60px;
        right: 0;
        z-index: 3002;
        min-width: 260px;
    }
    .grid-apps {
        display: flex;
        flex-direction: column;
        gap: 0;
    }
    .apps-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    .app-item {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 12px 10px;
        border-radius: 10px;
        cursor: pointer;
        transition: background 0.15s, box-shadow 0.15s;
        background: #f7f7fa;
        box-shadow: 0 1px 4px rgba(44,0,83,0.04);
        position: relative;
    }
    .app-item:hover {
        background: #f0eaff;
        box-shadow: 0 2px 8px rgba(44,0,83,0.10);
    }
    .app-item svg,
    .app-item img {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        background: #fff;
        box-shadow: 0 1px 4px rgba(44,0,83,0.06);
        padding: 2px;
        object-fit: contain;
    }
    .app-name {
        font-size: 16px;
        font-weight: 500;
        color: #3c0a7b;
        letter-spacing: 0.01em;
    }
    @media (max-width: 600px) {
        .apps-wrapper {
            max-width: 98vw;
            min-width: 0;
            left: 1vw;
            right: 1vw;
            top: 56px;
            padding: 12px 4px 8px 4px;
        }
        .app-item {
            padding: 10px 6px;
        }
        .app-name {
            font-size: 15px;
        }
    }
    .announcement {
        background: #ffb347;
        color: #3c0a7b;
        font-weight: bold;
        padding: 12px 0;
        text-align: center;
        font-size: 16px;
        border-bottom: 2px solid #ff9800;
        letter-spacing: 0.01em;
        width: 100%;
        min-width: 0;
    }
    .announcement a {
        color: #3c0a7b;
        text-decoration: underline;
        font-weight: bold;
    }
    body.dark-mode .announcement {
        background: #3c0a7b;
        color: #ffb347;
        border-bottom: 2px solid #ffb347;
    }
    body.dark-mode .announcement a {
        color: #ffb347;
    }
    body.dark-mode .apps-wrapper {
        background: #3c0a7b;
        box-shadow: 0 4px 24px rgba(44,0,83,0.25);
    }
    body.dark-mode .app-item {
        background: #280049;
        box-shadow: 0 1px 4px rgba(44,0,83,0.12);
    }
    body.dark-mode .app-item:hover {
        background: #3c0a7b;
        box-shadow: 0 2px 8px rgba(44,0,83,0.18);
    }
    body.dark-mode .app-item svg,
    body.dark-mode .app-item img {
        background: #3c0a7b;
        box-shadow: 0 1px 4px rgba(44,0,83,0.18);
    }
    body.dark-mode .app-name {
        color: #fff;
    }

        .top-left {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .menu-btn {
            cursor: pointer;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .logo-text {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        .search-bar {
            display: flex;
            align-items: center;
            background-color: #f0f0f0;
            border-radius: 20px;
            padding: 12px 21px;
            width: 100%;
            max-width: 777px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin: 0 auto; /* Center horizontally */
        }

        .search-bar input {
            border: none;
            outline: none;
            background: transparent;
            color: #333;
            width: 100%;
            padding-left: 10px;
        }

        .btn {
            display: flex;
            align-items: center;
            background-color: #8200fc;
            color: #ffffff;
            border: none;
            font-size: 14px;
            gap: 10px;
            font-weight: 500;
            padding: 12px 21px;
            border-radius: 30px;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .btn:hover {
            background-color: #6f00d4;
        }

        .content {
            margin-left: 290px;
            padding: 20px;
        }

        .sidebar {
            width: 250px;
            background-color: #fff;
            height: calc(100vh - 60px);
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            position: fixed;
            top: 120px;
            left: 0;
            overflow-y: auto;
            padding: 20px;
        }

        .today-calendar {
            font-size: 16px;
            font-weight: bold;
            flex-wrap: nowrap;
            display: flex;
            white-space: nowrap;
        }
        /* Style the dropdown to hide border and background */
        #weekDropdown {
            background: transparent;
            border: none;
            color: #fff;
            font-size: 14px;
            font-weight: 500;
            outline: none;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            padding-right: 28px; /* space for custom arrow */
            cursor: pointer;
            height: 20px;
            line-height: 20px;
        }
        #weekDropdown:focus {
            outline: 2px solid #fff;
            box-shadow: 0 0 0 2px #8200fc;
        }
        #weekDropdown option {
            background: #3c0a7b;
            color: #fff;
        }
        .btn select#weekDropdown {
            position: relative;
            z-index: 2;
        }

        .more-icon {
            display: none;
        }

        
       

        .btn {
            position: relative;
            overflow: visible;
        }
        .btn select#weekDropdown::-ms-expand {
            display: none;
        }
        /* Only add arrow to .btn that contains the dropdown */
        .btn:has(select#weekDropdown)::after {
            content: '';
            position: absolute;
            right: 18px;
            top: 50%;
            width: 0;
            height: 0;
            pointer-events: none;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid #fff;
            transform: translateY(-50%);
            z-index: 1;
        }
      

        .tabs {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            border-bottom: 2px solid #3c0a7b;
        }
        .tabs .tablinks {
            background: none;
            border: none;
            outline: none;
            color: #fff;
            font-size: 16px;
            font-weight: 500;
            padding: 10px 24px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: border-color 0.2s, color 0.2s;
        }
        .tabs .tablinks.active,
        .tabs .tablinks:focus {
            color: #ffb347;
            border-bottom: 3px solid #ffb347;
        }

/* MODALS */
.modal {
  display: none;
  position: fixed;
   overflow-y: auto;
  z-index: 3000;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  width: 90%;
  max-width: 400px;
  background-color: #fff;
  border-radius: 9px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  padding: 20px;

}

.event-label {
    font-weight: bold;
    margin-bottom: 5px;
    display: block;
    color: #8200fc;
    font-size: 15px;
}

        .modal-content {
  position: relative;
}
.modal-content .close {
  position: absolute;
  right: 10px;
  top: 10px;
  font-size: 24px;
  cursor: pointer;
}
.modal h2 {
  margin-bottom: 15px;
}
.modal input[type="text"],
.modal input[type="file"],
.modal select {
  width: 100%;
  padding: 8px;
  margin-bottom: 10px;
  border: 1px solid #ccc;
  border-radius: 4px;
}


input[type="date"],
input[type="time"] {
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    width: 100%;
    margin-bottom: 10px;
}

    .help-btn, .events-icon, .settings-icon, .app-icon {
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }
        .top-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .arrow-left-right {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            flex-wrap: nowrap;
        }

        @media (max-width: 890px) {
            .sidebar {
                display: none !important;
            }
            .content {
                margin-left: 0 !important;
            }
            .topbar {
                padding: 10px 15px !important;
            }
            .logo-text {
                display: none !important;
            }
            .arrow-left-right {
                display: none !important;
            }
        }



        @media (max-width: 440px) {
            /* Hide logo and logo-text */
            .logo,
            .logo-text {
            display: none !important;
            }
            /* Move Today calendar to center */
            .today-calendar {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            margin-left: 0 !important;
            width: max-content;
            text-align: center;
            z-index: 2;
            font-size: 15px;
            }
            /* Hide help, events, settings, app icons */
            .help-btn,
            .events-icon,
            .settings-icon,
            .app-icon {
            display: none !important;
            }
            /* Hide Today button, search bar, view dropdown, create button */
            #todayBtn,
            .search-bar,
            .weekDropdown,
            .btn.hide-720,
            #calendarViewSelect {
            display: none !important;
            }
            /* Show more-icon */
            .more-icon {
            display: block !important;
            }
            /* Make topbar relative for absolute positioning */
            .topbar {
            position: relative !important;
            }
            .topbar, .content {
             min-width: 0;
            }
        }

        #searchIconMobile {
            background: none !important;
            border: none !important;
            cursor: pointer;
            padding: 0;
            display: none;
        }
        #searchIconMobile:focus {
            outline: none;
            box-shadow: none;
        }
        body.dark-mode #searchIconMobile svg {
            color: #fff;
        }
    </style>

  <meta name="theme-color" content="#3c0a7b">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

</head>
<div class="announcement">
    <span>Starting on October 15 2025 This classic will be no longer available. You can export your data before this date. Munetios Calendar New link: <a href="https://calendar.munetios.com/new">https://calendar.munetios.com/new</a></span>
</div>
<body>
     <div class="topbar">
        <div class="top-left">
            <div class="menu-btn">
            <svg width="24" height="24" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg" aria-label="Menu Icon">
                <rect y="6" width="32" height="4" rx="2" fill="currentColor"/>
                <rect y="14" width="32" height="4" rx="2" fill="currentColor"/>
                <rect y="22" width="32" height="4" rx="2" fill="currentColor"/>
            </svg>
        </div>
        <div class="logo">
            <svg width="32" height="32" viewBox="0 0 32 32" fill="none" aria-label="Calendar Icon" xmlns="http://www.w3.org/2000/svg">
                <rect x="4" y="8" width="24" height="20" rx="2" fill="#fff" stroke="#333" stroke-width="2"/>
                <rect x="4" y="8" width="24" height="4" fill="#e0e0e0"/>
                <rect x="9" y="4" width="2" height="6" rx="1" fill="#333"/>
                <rect x="21" y="4" width="2" height="6" rx="1" fill="#333"/>
                <circle cx="10" cy="16" r="1.2" fill="#333"/>
                <circle cx="16" cy="16" r="1.2" fill="#333"/>
                <circle cx="22" cy="16" r="1.2" fill="#333"/>
                <circle cx="10" cy="22" r="1.2" fill="#333"/>
                <circle cx="16" cy="22" r="1.2" fill="#333"/>
                <circle cx="22" cy="22" r="1.2" fill="#333"/>
            </svg>
            <span class="logo-text">Calendar</span>
        </div>
        <button class="btn" id="todayBtn">Today</button>
        <span id="todayCalendar" class="today-calendar"> <!-- Injected by javascript --></span>
        <div class="arrow-left-right">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" aria-label="Arrow Left Icon" xmlns="http://www.w3.org/2000/svg">
                <path d="M12.5 4.16667L7.5 10L12.5 15.8333" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" aria-label="Arrow Right Icon" xmlns="http://www.w3.org/2000/svg">
                <path d="M7.5 4.16667L12.5 10L7.5 15.8333" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </div>
        </div>
        <div class="search-bar">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" aria-label="Search Icon" xmlns="http://www.w3.org/2000/svg" >
                <circle cx="9" cy="9" r="7" stroke="currentColor" stroke-width="2"/>
                <line x1="14.1213" y1="14.1213" x2="18" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <input type="text" placeholder="Search for events, birthdays, tasks and more" class="search-input" aria-label="Search Calendar">
        </div>
        <div class="top-right">
            <button id="searchIconMobile">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" aria-label="Search Icon" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="9" cy="9" r="7" stroke="currentColor" stroke-width="2"/>
                    <line x1="14.1213" y1="14.1213" x2="18" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
            <div class="more-icon">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" aria-label="More Icon" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="10" cy="5" r="2" fill="currentColor"/>
                    <circle cx="10" cy="10" r="2" fill="currentColor"/>
                    <circle cx="10" cy="15" r="2" fill="currentColor"/>
                </svg>
            </div>
            <button class="btn weekDropdown">
                 <svg width="26" height="26" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                    <rect x="4" y="5" width="16" height="15" rx="2" stroke="currentColor" stroke-width="1.5" fill="none"/>
                    <rect x="8" y="2" width="1.5" height="4" rx="0.75" fill="currentColor"/>
                    <rect x="14.5" y="2" width="1.5" height="4" rx="0.75" fill="currentColor"/>
                    <circle cx="8" cy="10" r="1" fill="currentColor"/>
                    <circle cx="12" cy="13" r="1" fill="currentColor"/>
                    <circle cx="16" cy="10" r="1" fill="currentColor"/>
                </svg>
                <select name="weekDropdown" id="weekDropdown">
                    <option value="Day">Day</option>
                    <option value="Week">Week</option>
                    <option value="Month" selected>Month</option>
                    <option value="Year">Year</option>
                    <option value="Agenda">Agenda</option>
                    <option value="Timeline">Timeline</option>
                </select>
            </button>
            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    const appIcon = document.getElementById('app-icon');
                    const appsWrapper = document.querySelector('.apps-wrapper');

                    if (appIcon && appsWrapper) {
                        appIcon.addEventListener('click', function (e) {
                            e.stopPropagation();
                            if (appsWrapper.style.display === 'flex') {
                                appsWrapper.style.display = 'none';
                            } else {
                                appsWrapper.style.display = 'flex';
                            }
                        });

                        // Close apps wrapper when clicking outside
                        document.addEventListener('click', function (e) {
                            if (appsWrapper.style.display === 'flex' && !appsWrapper.contains(e.target) && e.target !== appIcon) {
                                appsWrapper.style.display = 'none';
                            }
                        });
                    }
                });


                (function() {
                    let contextMenu = null;
                    let contextMenuDate = null;

                    // Helper to close menu
                    function closeContextMenu() {
                        if (contextMenu) {
                            contextMenu.remove();
                            contextMenu = null;
                            contextMenuDate = null;
                            document.removeEventListener('mousedown', handleOutsideClick);
                        }
                    }
                    function handleOutsideClick(e) {
                        if (contextMenu && !contextMenu.contains(e.target)) closeContextMenu();
                    }

                    // Helper to get date from cell
                    function getDateFromCell(td, calendarType) {
                        // Month view: use mainDate's year/month and cell's day
                        if (!td) return null;
                        let daySpan = td.querySelector('span');
                        if (!daySpan) return null;
                        let day = parseInt(daySpan.textContent, 10);
                        if (isNaN(day)) return null;
                        let year = mainDate.getFullYear();
                        let month = mainDate.getMonth();
                        if (calendarType === 'Week') {
                            // Week view: get date from cell index
                            let weekStart = new Date(mainDate);
                            weekStart.setDate(mainDate.getDate() - mainDate.getDay());
                            let idx = Array.from(td.parentNode.children).indexOf(td);
                            let d = new Date(weekStart);
                            d.setDate(weekStart.getDate() + idx);
                            return d;
                        }
                        if (calendarType === 'Year') {
                            // Year view: find month from parent
                            let monthDiv = td.closest('div[style*="min-width"]');
                            if (monthDiv) {
                                let monthName = monthDiv.querySelector('div').textContent;
                                let m = new Date(Date.parse(monthName +" 1, 2000")).getMonth();
                                if (!isNaN(m)) month = m;
                            }
                        }
                        return new Date(year, month, day);
                    }

                    // Helper to get events for a date
                    function getEventsForDate(date) {
                        const ymd = n => n.toString().padStart(2, '0');
                        const dateStr = `${date.getFullYear()}-${ymd(date.getMonth() + 1)}-${ymd(date.getDate())}`;
                        return events.filter(ev => ev.date === dateStr);
                    }

                    // Show context menu at x/y for date
                    function showContextMenu(x, y, date, hasEvent) {
                        closeContextMenu();
                        contextMenuDate = date;
                        contextMenu = document.createElement('div');
                        contextMenu.style.position = 'absolute';
                        contextMenu.style.left = x + 'px';
                        contextMenu.style.top = y + 'px';
                        contextMenu.style.background = '#fff';
                        contextMenu.style.color = '#3c0a7b';
                        contextMenu.style.borderRadius = '10px';
                        contextMenu.style.boxShadow = '0 2px 8px rgba(0,0,0,0.18)';
                        contextMenu.style.zIndex = 4000;
                        contextMenu.style.minWidth = '160px';
                        contextMenu.style.fontSize = '15px';
                        contextMenu.innerHTML = `
                            <button style="all:unset;display:block;width:100%;padding:12px 18px;cursor:pointer;" id="ctx-share">Share</button>
                            <button style="all:unset;display:block;width:100%;padding:12px 18px;cursor:pointer;" id="ctx-print">Print</button>
                            <button style="all:unset;display:block;width:100%;padding:12px 18px;cursor:pointer;" id="ctx-create">Create Event</button>
                            ${hasEvent ? `<button style="all:unset;display:block;width:100%;padding:12px 18px;cursor:pointer;color:#e53935;" id="ctx-delete">Delete Event</button>` : ''}
                        `;
                        document.body.appendChild(contextMenu);

                        // Adjust if offscreen
                        const rect = contextMenu.getBoundingClientRect();
                        if (rect.right > window.innerWidth) contextMenu.style.left = (window.innerWidth - rect.width - 10) + 'px';
                        if (rect.bottom > window.innerHeight) contextMenu.style.top = (window.innerHeight - rect.height - 10) + 'px';

                        // Share
                        contextMenu.querySelector('#ctx-share').onclick = function() {
                            closeContextMenu();
                            let eventTitles = getEventsForDate(date).map(ev => ev.title);
                            let holiday = holidays.find(h => {
                                if (/^\d{4}-\d{2}-\d{2}$/.test(h.date)) {
                                    const d = new Date(h.date);
                                    return d.getFullYear() === date.getFullYear() && d.getMonth() === date.getMonth() && d.getDate() === date.getDate();
                                } else if (/^\d{2}-\d{2}$/.test(h.date)) {
                                    const [mm, dd] = h.date.split('-').map(Number);
                                    return (mm - 1) === date.getMonth() && dd === date.getDate();
                                }
                                return false;
                            });
                            let shareTitle = eventTitles.length ? eventTitles.join(', ') : (holiday ? holiday.name : 'Calendar Date');
                            let shareText = `Date: ${date.toLocaleDateString()}`
                                + (holiday ? `\nHoliday: ${holiday.name}` : '')
                                + (eventTitles.length ? `\nEvent: ${eventTitles.join(', ')}` : '');
                            let shareUrl = window.location.origin + window.location.pathname
                                + `?eventTitle=${encodeURIComponent(shareTitle)}`
                                + `&date=${encodeURIComponent(date.toISOString().slice(0,10))}`
                                + (eventTitles.length && events[0] && events[0].time ? `&time=${encodeURIComponent(events[0].time)}` : '');
                            const shareData = {
                                title: shareTitle,
                                text: shareText,
                                url: shareUrl
                            };
                            if (navigator.share) {
                                navigator.share(shareData)
                                    .then(() => showToast('Shared successfully!', 'success'))
                                    .catch(() => showToast('Share canceled or failed.', 'error'));
                            } else {
                                showToast('Share not supported on this browser.', 'error');
                            }
                        };
                        // Print
                        contextMenu.querySelector('#ctx-print').onclick = function() {
                            closeContextMenu();
                            showToast('Opening print dialog...');
                            window.print();
                        };
                        // Create Event
                        contextMenu.querySelector('#ctx-create').onclick = function() {
                            closeContextMenu();
                            // Prefill create event modal with date
                            showModal('createEvent');
                            setTimeout(() => {
                                document.getElementById('eventDate').value = date.toISOString().slice(0,10);
                                document.getElementById('eventTitle').focus();
                            }, 50);
                            showToast('Fill in details to create event.', 'info');
                        };
                        // Delete Event
                        if (hasEvent) {
                            contextMenu.querySelector('#ctx-delete').onclick = function() {
                                closeContextMenu();
                                // Delete all events for this date (or prompt for which one)
                                const evs = getEventsForDate(date);
                                if (evs.length === 1) {
                                    showConfirmModal('Delete event "'+evs[0].title+'"?', function(yes) {
                                        if (yes) {
                                            const idx = events.indexOf(evs[0]);
                                            if (idx !== -1) {
                                                events.splice(idx, 1);
                                                saveData();
                                                updateCalendarView();
                                                showToast('Event deleted.', 'success');
                                            }
                                        }
                                    });
                                } else if (evs.length > 1) {
                                    // If multiple, let user pick
                                    let msg = 'Delete which event?\n';
                                    evs.forEach((ev,i)=>{msg += `${i+1}. ${ev.title}\n`;});
                                    const sel = prompt(msg + 'Enter number (or leave blank to cancel):');
                                    const n = Number(sel);
                                    if (n >= 1 && n <= evs.length) {
                                        const idx = events.indexOf(evs[n-1]);
                                        if (idx !== -1) {
                                            events.splice(idx, 1);
                                            saveData();
                                            updateCalendarView();
                                            showToast('Event deleted.', 'success');
                                        }
                                    }
                                }
                            };
                        }

                        setTimeout(() => {
                            document.addEventListener('mousedown', handleOutsideClick);
                        }, 0);
                    }

                    // Attach contextmenu event to calendar cells
                    function attachContextMenuHandlers() {
                        // Remove old handlers
                        document.querySelectorAll('.main-calendar-container td').forEach(td => {
                            td.oncontextmenu = null;
                        });
                        // Month view
                        document.querySelectorAll('.main-calendar-container td').forEach(td => {
                            td.oncontextmenu = function(e) {
                                e.preventDefault();
                                const date = getDateFromCell(td, calendarViewSelect.value);
                                if (!date) return;
                                const hasEvent = getEventsForDate(date).length > 0;
                                showContextMenu(e.pageX, e.pageY, date, hasEvent);
                            };
                        });
                        // Week view
                        if (calendarViewSelect.value === 'Week') {
                            // Add time slot table if not already present
                            const calendarViewArea = document.getElementById('calendar-view-area');
                            // Always re-render for responsiveness and event updates
                            calendarViewArea.innerHTML = '';
                            // Build week days header
                            const weekStart = new Date(mainDate);
                            weekStart.setDate(mainDate.getDate() - mainDate.getDay());
                            let days = [];
                            for (let d = 0; d < 7; d++) {
                                const day = new Date(weekStart);
                                day.setDate(weekStart.getDate() + d);
                                days.push(day);
                            }
                            let html = `
                                <div style="overflow-x:auto;">
                                <table id="week-time-table" style="width:100%;min-width:700px;border-collapse:collapse;">
                                    <thead>
                                        <tr>
                                            <th style="width:60px;position:sticky;left:0;background:#fff;z-index:2;"></th>
                                            ${days.map(day => `<th style="text-align:center;">${day.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' })}</th>`).join('')}
                                        </tr>
                                    </thead>
                                    <tbody>
                            `;
                            // 24 hours
                            for (let hour = 0; hour < 24; hour++) {
                                const hourLabel = (hour === 0 ? '12AM' : hour < 12 ? hour + 'AM' : hour === 12 ? '12PM' : (hour - 12) + 'PM');
                                html += `<tr>`;
                                html += `<td style="text-align:right;padding-right:6px;color:#888;font-size:13px;position:sticky;left:0;background:#fff;z-index:1;">${hourLabel}</td>`;
                                for (let d = 0; d < 7; d++) {
                                    const date = days[d];
                                    const ymd = n => n.toString().padStart(2, '0');
                                    const dateStr = `${date.getFullYear()}-${ymd(date.getMonth() + 1)}-${ymd(date.getDate())}`;
                                    // Find all events for this hour (support multiple events)
                                    const evs = events.filter(ev =>
                                        ev.date === dateStr &&
                                        ev.time &&
                                        Number(ev.time.split(':')[0]) === hour
                                    );
                                    html += `<td style="border:1px solid #eee;height:36px;vertical-align:top;position:relative;cursor:pointer;min-width:90px;">`;
                                    if (evs.length) {
                                        evs.forEach(ev => {
                                            html += `<div style="background:#00e676;color:#fff;border-radius:6px;padding:2px 8px;font-size:12px;font-weight:bold;box-shadow:0 1px 4px rgba(0,0,0,0.08);margin:2px 0;cursor:pointer;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" data-title="${ev.title}" data-date="${ev.date}" data-time="${ev.time}">${ev.title}</div>`;
                                        });
                                    }
                                    html += `</td>`;
                                }
                                html += `</tr>`;
                            }
                            html += `</tbody></table></div>`;
                            calendarViewArea.innerHTML = html;

                            // Responsive: make table horizontally scrollable on small screens
                            // (already wrapped in overflow-x:auto div above)

                            // Add click handler for event editing
                            calendarViewArea.querySelectorAll('div[data-title][data-date][data-time]').forEach(div => {
                                div.onclick = function(evt) {
                                    evt.stopPropagation();
                                    const title = div.dataset.title;
                                    const date = div.dataset.date;
                                    const time = div.dataset.time;
                                    const idx = events.findIndex(ev => ev.title === title && ev.date === date && ev.time === time);
                                    if (idx !== -1) openEditEventModal(idx);
                                };
                            });

                            // Add context menu for each cell
                            const tds = calendarViewArea.querySelectorAll('td');
                            tds.forEach((td, i) => {
                                // skip time column
                                if (td.parentNode && td.cellIndex === 0) return;
                                td.oncontextmenu = function(e) {
                                    e.preventDefault();
                                    const col = td.cellIndex - 1;
                                    const row = td.parentNode.rowIndex - 1; // -1 for header
                                    const date = days[col];
                                    const hour = row;
                                    const ymd = n => n.toString().padStart(2, '0');
                                    const dateStr = `${date.getFullYear()}-${ymd(date.getMonth() + 1)}-${ymd(date.getDate())}`;
                                    const hasEvent = events.some(ev =>
                                        ev.date === dateStr &&
                                        ev.time &&
                                        Number(ev.time.split(':')[0]) === hour
                                    );
                                    // Build a date object for this cell's hour
                                    const cellDate = new Date(date);
                                    cellDate.setHours(hour, 0, 0, 0);
                                    showContextMenu(e.pageX, e.pageY, cellDate, hasEvent);
                                };
                            });
                        }
                        // Year view
                        if (calendarViewSelect.value === 'Year') {
                            document.querySelectorAll('#calendar-view-area td').forEach(td => {
                                td.oncontextmenu = function(e) {
                                    e.preventDefault();
                                    const date = getDateFromCell(td, 'Year');
                                    if (!date) return;
                                    const hasEvent = getEventsForDate(date).length > 0;
                                    showContextMenu(e.pageX, e.pageY, date, hasEvent);
                                };
                            });
                        }
                    }


                    // Attach only once after DOMContentLoaded and after calendar renders
                    document.addEventListener('DOMContentLoaded', function() {
                        attachContextMenuHandlers();
                        // Also re-attach after calendar updates
                        const origUpdateCalendarViewWithContext = updateCalendarView;
                        updateCalendarView = function() {
                            origUpdateCalendarViewWithContext();
                            attachContextMenuHandlers();
                        };
                    });
                })();


                // --- Helper Views ---
                function renderDayView(date) {
                    const year = date.getFullYear();
                    const month = date.getMonth();
                    const day = date.getDate();
                    const weekday = date.toLocaleString(undefined, { weekday: 'long' });
                    let holiday = holidays.find(h => {
                        if (/^\d{4}-\d{2}-\d{2}$/.test(h.date)) {
                            const d = new Date(h.date);
                            return d.getFullYear() === year && d.getMonth() === month && d.getDate() === day;
                        } else if (/^\d{2}-\d{2}$/.test(h.date)) {
                            const [mm, dd] = h.date.split('-').map(Number);
                            return (mm - 1) === month && dd === day;
                        }
                        return false;
                    });
                    let html = `
                        <div style="max-width:400px;margin:auto;text-align:center;">
                            <div style="font-size:28px;font-weight:bold;color:#8200fc;margin-bottom:8px;">
                                ${weekday}, ${date.toLocaleString(undefined, { month: 'long', day: 'numeric', year: 'numeric' })}
                            </div>
                            <div style="margin-bottom:24px;">
                                <span style="
                                    display:inline-block;
                                    width:60px;
                                    height:60px;
                                    line-height:60px;
                                    border-radius:12px;
                                    background:#8200fc;
                                    color:#fff;
                                    font-size:32px;
                                    font-weight:bold;
                                    box-shadow:0 0 0 2px #fff, 0 0 8px #8200fc55;
                                ">${day}</span>
                            </div>
                            ${holiday ? `<div style="color:#ffb347;font-size:18px;font-weight:bold;">🎉 ${holiday.name}</div>` : ''}
                            <div style="margin-top:32px;color:#aaa;">No events for this day.</div>
                        </div>
                    `;
                    calendarViewArea.innerHTML = html;
                }

                function renderAgendaView(date) {
                    // Show a list of days/events for the current month (demo only)
                    const year = date.getFullYear();
                    const month = date.getMonth();
                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    let html = `<div style="max-width:600px;margin:auto;">
                        <div style="font-size:22px;font-weight:bold;color:#8200fc;margin-bottom:18px;">
                            Agenda for ${date.toLocaleString(undefined, { month: 'long', year: 'numeric' })}
                        </div>
                        <ul style="list-style:none;padding:0;">`;
                    let found = false;
                    for (let d = 1; d <= daysInMonth; d++) {
                        let holiday = holidays.find(h => {
                            if (/^\d{4}-\d{2}-\d{2}$/.test(h.date)) {
                                const hd = new Date(h.date);
                                return hd.getFullYear() === year && hd.getMonth() === month && hd.getDate() === d;
                            } else if (/^\d{2}-\d{2}$/.test(h.date)) {
                                const [mm, dd] = h.date.split('-').map(Number);
                                return (mm - 1) === month && dd === d;
                            }
                            return false;
                        });
                        if (holiday) {
                            found = true;
                            html += `<li style="margin-bottom:10px;">
                                <span style="font-weight:bold;color:#8200fc;">${new Date(year, month, d).toLocaleDateString(undefined, { month: 'short', day: 'numeric', weekday: 'short' })}</span>
                                <span style="color:#ffb347;font-weight:bold;margin-left:8px;">🎉 ${holiday.name}</span>
                            </li>`;
                        }
                    }
                    if (!found) {
                        html += `<li style="color:#aaa;">No holidays/events this month.</li>`;
                    }
                    html += `</ul></div>`;
                    calendarViewArea.innerHTML = html;
                }

                function renderTimelineView(date) {
                    // Show a wrapped timeline of holidays for the current year (demo only)
                    const year = date.getFullYear();
                    const yearHolidays = holidays.filter(h => {
                        if (/^\d{4}-\d{2}-\d{2}$/.test(h.date)) {
                            return new Date(h.date).getFullYear() === year;
                        }
                        return false;
                    });
                    let html = `<div style="max-width:900px;margin:auto;">
                        <div style="font-size:22px;font-weight:bold;color:#8200fc;margin-bottom:18px;">
                            Timeline for ${year}
                        </div>
                        <div style="overflow-x:auto;padding-bottom:16px;">
                            <div style="display:flex;flex-wrap:wrap;align-items:flex-start;gap:32px;">`;
                    if (yearHolidays.length === 0) {
                        html += `<div style="color:#aaa;">No holidays for this year.</div>`;
                    } else {
                        yearHolidays.forEach((h, idx) => {
                            const d = new Date(h.date);
                            html += `<div style="text-align:center;flex:0 1 120px;margin-bottom:24px;">
                                <div style="
                                    background:#ffb347;
                                    color:#fff;
                                    border-radius:50%;
                                    width:48px;
                                    height:48px;
                                    line-height:48px;
                                    font-size:18px;
                                    font-weight:bold;
                                    margin:auto;
                                    border:2px solid #ff9800;
                                ">${d.getDate()}</div>
                                <div style="font-size:13px;color:#8200fc;margin-top:4px;">${d.toLocaleString(undefined, { month: 'short' })}</div>
                                <div style="font-size:12px;color:#ffb347;margin-top:2px;">${h.name}</div>
                            </div>`;
                        });
                    }
                    html += `</div></div></div>`;
                    calendarViewArea.innerHTML = html;
                }

                // --- Dropdown Sync ---
                const weekDropdown = document.getElementById('weekDropdown');
                // Keep both dropdowns in sync
                weekDropdown.addEventListener('change', function() {
                    if (weekDropdown.value === 'Agenda') {
                        document.getElementById('main-calendar-month').textContent = 'Agenda';
                        document.getElementById('holiday-list').style.display = 'none';
                        renderAgendaView(mainDate);
                        calendarViewSelect.value = 'Agenda';
                    } else if (weekDropdown.value === 'Timeline') {
                        document.getElementById('main-calendar-month').textContent = 'Timeline';
                        document.getElementById('holiday-list').style.display = 'none';
                        renderTimelineView(mainDate);
                        calendarViewSelect.value = 'Timeline';
                    } else if (weekDropdown.value === 'Day') {
                        document.getElementById('main-calendar-month').textContent = mainDate.toLocaleString(undefined, { month: 'long', day: 'numeric', year: 'numeric' });
                        document.getElementById('holiday-list').style.display = 'none';
                        renderDayView(mainDate);
                        calendarViewSelect.value = 'Day';
                    } else if (weekDropdown.value === 'Month') {
                        calendarViewSelect.value = 'Month';
                        updateCalendarView();
                    } else if (weekDropdown.value === 'Week') {
                        calendarViewSelect.value = 'Week';
                        updateCalendarView();
                    } else if (weekDropdown.value === 'Year') {
                        calendarViewSelect.value = 'Year';
                        updateCalendarView();
                    }
                });
                // When main select changes, update topbar dropdown
                calendarViewSelect.addEventListener('change', function() {
                    if (['Day','Week','Month','Year'].includes(calendarViewSelect.value)) {
                        weekDropdown.value = calendarViewSelect.value;
                    }
                });

                // Add support for Day/Agenda/Timeline in main select (optional)
                calendarViewSelect.addEventListener('change', function() {
                    if (calendarViewSelect.value === 'Day') {
                        document.getElementById('main-calendar-month').textContent = mainDate.toLocaleString(undefined, { month: 'long', day: 'numeric', year: 'numeric' });
                        document.getElementById('holiday-list').style.display = 'none';
                        renderDayView(mainDate);
                    } else if (calendarViewSelect.value === 'Agenda') {
                        document.getElementById('main-calendar-month').textContent = 'Agenda';
                        document.getElementById('holiday-list').style.display = 'none';
                        renderAgendaView(mainDate);
                    } else if (calendarViewSelect.value === 'Timeline') {
                        document.getElementById('main-calendar-month').textContent = 'Timeline';
                        document.getElementById('holiday-list').style.display = 'none';
                        renderTimelineView(mainDate);
                    }
                });
            </script>
            <button class="btn" title="Go to New version">
                <a href="https://calendar.munetios.com/new" style="color:inherit; white-space: nowrap; text-decoration:none;">Go to new version of Munetios Calendar</a>
            </button>
            <button class="btn hide-720" title="Create">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" aria-label="Add Icon" xmlns="http://www.w3.org/2000/svg">
                    <line x1="10" y1="4" x2="10" y2="16" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
                    <line x1="4" y1="10" x2="16" y2="10" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <span class="create-label">Create</span>
            </button>
            <div class="help-btn" id="help-btn">
                <svg width="26" height="26" viewBox="0 0 20 20" fill="currentColor" aria-label="Learn Icon" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="10" cy="10" r="8" stroke="currentColor" stroke-width="2" fill="none"/>
                    <path d="M10 13v-1c0-1.1 2-1.5 2-3a2 2 0 1 0-4 0" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                    <circle cx="10" cy="15" r="1" fill="currentColor"/>
                </svg>
            </div>
            <div class="events-icon" id="events-btn">
                <svg width="26" height="26" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                    <rect x="4" y="5" width="16" height="15" rx="2" stroke="currentColor" stroke-width="1.5" fill="none"/>
                    <rect x="8" y="2" width="1.5" height="4" rx="0.75" fill="currentColor"/>
                    <rect x="14.5" y="2" width="1.5" height="4" rx="0.75" fill="currentColor"/>
                    <circle cx="8" cy="10" r="1" fill="currentColor"/>
                    <circle cx="12" cy="13" r="1" fill="currentColor"/>
                    <circle cx="16" cy="10" r="1" fill="currentColor"/>
                </svg>
            </div>
            <div class="settings-icon" id="settings">
                <svg width="26" height="26" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.438.995s.145.755.438.995l1.003.827c.48.398.668 1.03.26 1.431l-1.296 2.247a1.125 1.125 0 01-1.37.49l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.063-.374-.313-.686-.645-.87a6.52 6.52 0 01-.22-.127c-.324-.196-.72-.257-1.075-.124l-1.217.456a1.125 1.125 0 01-1.37-.49l-1.296-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.437-.995s-.145-.755-.437-.995l-1.004-.827a1.125 1.125 0 01-.26-1.431l1.296-2.247a1.125 1.125 0 011.37-.49l1.217.456c.355.133.75.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
            </div>
            <div class="app-icon" id="app-icon">
                <svg width="26" height="26" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z"></path></svg>
            </div>
            <div class="apps-wrapper">
                <div class="grid-apps">
                    <div class="apps-list">
                       <p>Not available but you can still go to <a href="https://www.munetios.com/">https://www.munetios.com/</a></p>

                    </div>
                </div>
            </div>
        </div>
     </div>
     <div class="sidebar">
        <div class="calendar-sidebar-view">
            <h3 style="margin-top:0; color:#fff;">Mini Calendar</h3>
            <div id="mini-calendar" style="background:#3c0a7b; border-radius:12px; padding:16px; color:#fff; text-align:center;">
                <div id="calendar-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <button id="prevMonth" style="background:none; border:none; color:#fff; font-size:18px; cursor:pointer;">&#8592;</button>
                    <span id="calendar-month"></span>
                    <button id="nextMonth" style="background:none; border:none; color:#fff; font-size:18px; cursor:pointer;">&#8594;</button>
                </div>
                <table style="width:100%; border-collapse:collapse; color:#fff;">
                    <thead>
                        <tr style="font-size:13px;">
                            <th>Su</th>
                            <th>Mo</th>
                            <th>Tu</th>
                            <th>We</th>
                            <th>Th</th>
                            <th>Fr</th>
                            <th>Sa</th>
                        </tr>
                    </thead>
                    <tbody id="calendar-body"></tbody>
                </table>
            </div>
        </div>
        <div class="sidebar-section">
            <h3 style="margin-top:20px; color:#fff;">My Calendars</h3>
            <ul style="list-style:none; padding:0; margin:0; color:#fff;">
                <li><input type="checkbox" id="calendar-birthdays" checked> Birthdays</li>
                <li><input type="checkbox" id="calendar-events" checked> Events</li>
                <li><input type="checkbox" id="calendar-family" checked> Family</li>
                <li><input type="checkbox" id="calendar-tasks" checked> Tasks</li>
                <li><input type="checkbox" id="calendar-holidays" checked> Holidays</li>
            </ul>
            <br>
            <button class="btn" onclick="showModal('createTask')">Create Task</button>
        </div>
        <div class="sidebar-section">
            <br>
            <button class="btn" onclick="showModal('createBirthday')">Create Birthday</button>
            <h3>Birthdays list</h3>
            <ul>
                <!-- When created a birthday will appear here -->
            </ul>
        </div>
      
     </div>
    <div class="content">
        <h1>Calendar</h1>
        <div id="main-calendar-container" class="main-calendar-container" style="background:#fff; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.07); padding:24px; max-width:900px; margin:auto;">
            <div id="main-calendar-header" style="display:flex; align-items:center; justify-content:space-between; margin-bottom:18px;">
                <button id="mainPrev" style="background:none; border:none; font-size:22px; color:#8200fc; cursor:pointer;">&#8592;</button>
                <span id="main-calendar-month" style="font-size:20px; font-weight:bold; color:#3c0a7b;"></span>
                <button id="mainNext" style="background:none; border:none; font-size:22px; color:#8200fc; cursor:pointer;">&#8594;</button>
            </div>
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
                <div id="calendar-legend" style="display:flex; gap:18px; align-items:center;">
                    <span style="display:flex; align-items:center; gap:5px;">
                        <span style="display:inline-block; width:18px; height:18px; border-radius:4px; background:#ffb347; border:2px solid #ff9800;"></span>
                        <span style="font-size:14px;">Holiday</span>
                    </span>
                    <span style="display:flex; align-items:center; gap:5px;">
                        <span style="display:inline-block; width:18px; height:18px; border-radius:4px; background:#8200fc;"></span>
                        <span style="font-size:14px;">Today</span>
                    </span>
                </div>
                <div>
                    <select id="calendarViewSelect" style="padding:6px 12px; border-radius:6px; border:1px solid #ccc; font-size:15px;">
                        <option value="Month">Month</option>
                        <option value="Week">Week</option>
                        <option value="Year">Year</option>
                    </select>
                </div>
            </div>
            <div id="calendar-view-area">
                <!-- Calendar table will be rendered here -->
                <table id="main-calendar-table" style="width:100%; border-collapse:collapse; color:#333;">
                    <thead>
                        <tr style="font-size:15px;">
                            <th>Su</th>
                            <th>Mo</th>
                            <th>Tu</th>
                            <th>We</th>
                            <th>Th</th>
                            <th>Fr</th>
                            <th>Sa</th>
                        </tr>
                    </thead>
                    <tbody id="main-calendar-body"></tbody>
                </table>
            </div>
            <div id="holiday-list" style="margin-top:24px;">
                <h3 style="margin-bottom:8px;">Holidays This Month</h3>
                <ul id="holiday-ul" style="list-style:none; padding:0; color:#8200fc;"></ul>
            </div>
           
        </div>
    </div>

<div class="modal" id="helpModal">
    <div class="modal-content">
        <span class="close" id="closeHelpModal">&times;</span>
        <h2>Help</h2>
        <h3>Welcome to Munetios Calendar (Beta)</h3>
       <p>So you can view your calendar like you view your events.</p>
       <p>Use the buttons to navigate between months, and click on a date to view or edit events.</p>
         <p>Use the dropdown to switch between Month, Week, and Year views.</p>
         <p>Click outside the sidebar or on the menu button to close it on mobile devices.</p>
            <p>Enjoy managing your schedule!</p>
            <br>
            <p>Known issues:</p>
            <ul>
                <li>Changing to another calendar view then going back to month view doesnt change the whole calendar.</li>
            </ul>
    </div>
</div>

 <div class="modal" id="eventsList">
    <div class="modal-content">
        <span class="close" id="closeEventsList">&times;</span>
        <h2>Events List</h2>
        <div class="tabs">
            <button class="tablinks" onclick="openTab(event, 'Events')" id="defaultOpen">Events</button>
            <button class="tablinks" onclick="openTab(event, 'Birthdays')">Birthdays</button>
            <button class="tablinks" onclick="openTab(event, 'Tasks')">Tasks</button>
        </div>
        <ul id="eventsUl">
            <!-- Events will be dynamically added here -->
        </ul>
    </div>
 </div>
<div class="modal" id="createEvent">
    <div class="modal-content">
        <span class="close" id="closeCreateEvent">&times;</span>
        <h2>Create Event</h2>
        <form id="createEventForm">
            <label for="eventTitle" class="event-label">Event Title:</label>
            <input type="text" id="eventTitle" name="eventTitle" required>
            <label for="eventDate" class="event-label">Event Date:</label>
            <input type="date" id="eventDate" name="eventDate" required>
            <label for="eventTime" class="event-label">Event Time:</label>
            <input type="time" id="eventTime" name="eventTime" required>
            <button class="btn" type="submit">Create Event</button>
        </form>
    </div>
</div>
 <div class="modal" id="createBirthday">
    <div class="modal-content">
        <span class="close" id="closeCreateBirthday">&times;</span>
        <h2>Create Birthday</h2>
        <form id="createBirthdayForm">
            <label for="birthdayName" class="event-label">Name:</label>
            <input type="text" id="birthdayName" name="birthdayName" required>
            <label for="birthdayDate" class="event-label">Birthday Date:</label>
            <input type="date" id="birthdayDate" name="birthdayDate" required>
            <button class="btn" type="submit">Create Birthday</button>
        </form>
    </div>
 </div>
 <div class="modal" id="editEvent">
    <div class="modal-content">
        <span class="close" id="closeEditEvent">&times;</span>
        <h2>Edit Event</h2>
        <form id="editEventForm">
            <label for="editEventTitle" class="event-label">Event Title:</label>
            <input type="text" id="editEventTitle" name="editEventTitle" required>
            <label for="editEventDate" class="event-label">Event Date:</label>
            <input type="date" id="editEventDate" name="editEventDate" required>
            <label for="editEventTime" class="event-label">Event Time:</label>
            <input type="time" id="editEventTime" name="editEventTime" required>
            <button class="btn" type="submit">Save Changes</button>
        </form>
    </div>
 </div>
 <div class="modal" id="editBirthday">
    <div class="modal-content">
        <span class="close" id="closeEditBirthday">&times;</span>
        <h2>Edit Birthday</h2>
        <form id="editBirthdayForm">
            <label for="editBirthdayName" class="event-label">Name:</label>
            <input type="text" id="editBirthdayName" name="editBirthdayName" required>
            <label for="editBirthdayDate" class="event-label">Birthday Date:</label>
            <input type="date" id="editBirthdayDate" name="editBirthdayDate" required>
            <button class="btn" type="submit">Save Changes</button>
        </form>
    </div>
 </div>
 <div class="modal" id="editTask">
    <div class="modal-content">
        <span class="close" id="closeEditTask">&times;</span>
        <h2>Edit Task</h2>
        <form id="editTaskForm">
            <label for="editTaskTitle" class="event-label">Task Title:</label>
            <input type="text" id="editTaskTitle" name="editTaskTitle" required>
            <label for="editTaskDueDate" class="event-label">Due Date:</label>
            <input type="date" id="editTaskDueDate" name="editTaskDueDate" required>
            <button class="btn" type="submit">Save Changes</button>
        </form>
    </div>
 </div>
 <div class="modal" id="settingsModal">
    <div class="modal-content">
        <span class="close" id="closeSettings">&times;</span>
        <h2>Settings</h2>
        <div style="margin-bottom: 24px;">
            <label for="themeSelect" style="font-weight:bold;display:block;margin-bottom:6px;">Theme:</label>
            <select id="themeSelect" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;">
                <option value="system">System</option>
                <option value="light">Light</option>
                <option value="dark">Dark</option>
            </select>
        </div>
        <div style="margin-bottom: 24px;">
            <label for="desktopNotifications" style="font-weight:bold;display:block;margin-bottom:6px;">Desktop Notifications (Beta):</label>
            <select id="desktopNotifications" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;">
                <option value="-">-</option>
                <option value="enabled">Enabled</option>
                <option value="disabled">Disabled</option>
            </select>
        </div>
        <div style="margin-bottom: 24px;">
            <label for="languageSelect" style="font-weight:bold;display:block;margin-bottom:6px;">Language:</label>
            <select id="languageSelect" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;">
                <option value="en">English</option>
                <option value="es">Spanish</option>
                <option value="fr">French</option>
                <option value="de">German</option>
                <option value="ru">Russian</option>
                <option value="zh">Chinese</option>
                <option value="ja">Japanese</option>
                <option value="ko">Korean</option>
                <option value="pt">Portuguese</option>
            </select>
            <button class="btn" onclick="openSyncModal()">Sync Data</button>
            <script>
                /**
                 * Desktop Notification Logic
                 * - Requests permission on settings change or event creation.
                 * - Checks events every minute; if event time matches, shows notification.
                 */

                // Request notification permission if enabled in settings
                function requestNotificationPermission() {
                    if (Notification && Notification.permission !== 'granted') {
                        Notification.requestPermission();
                    }
                }

                // Listen for settings change
                document.getElementById('desktopNotifications').addEventListener('change', function() {
                    if (this.value === 'enabled') {
                        requestNotificationPermission();
                    }
                    localStorage.setItem('calendar_notifications', this.value);
                });

                // Load notification setting
                const savedNotif = localStorage.getItem('calendar_notifications') || '-';
                document.getElementById('desktopNotifications').value = savedNotif;

                // Helper: show desktop notification
                function showDesktopNotification(title, body) {
                    if (Notification && Notification.permission === 'granted') {
                        new Notification(title, { body });
                    }
                }

                // Check events every minute
                setInterval(function() {
                    if (document.getElementById('desktopNotifications').value !== 'enabled') return;
                    if (!("Notification" in window) || Notification.permission !== 'granted') return;
                    // Get today's date and time
                    const now = new Date();
                    const ymd = now.toISOString().slice(0,10);
                    const hm = now.toTimeString().slice(0,5);
                    // Find events for now
                    events.forEach(ev => {
                        if (ev.date === ymd && ev.time === hm && !ev.notified) {
                            showDesktopNotification('Event Reminder', `${ev.title} at ${ev.time}`);
                            ev.notified = true;
                            saveData();
                        }
                    });
                }, 60000);

                // Reset notified flag at midnight
                setInterval(function() {
                    const now = new Date();
                    if (now.getHours() === 0 && now.getMinutes() === 0) {
                        events.forEach(ev => { ev.notified = false; });
                        saveData();
                    }
                }, 60000);

                // Request permission on event creation if enabled
                document.getElementById('createEventForm').addEventListener('submit', function() {
                    if (document.getElementById('desktopNotifications').value === 'enabled') {
                        requestNotificationPermission();
                    }
                });




                function openSyncModal() {
                    document.getElementById('syncModal').style.display = 'block';
                }
                document.getElementById('closeSyncModal').onclick = function() {
                    document.getElementById('syncModal').style.display = 'none';
                };
                window.addEventListener('click', function(event) {
                    if (event.target === document.getElementById('syncModal')) {
                        document.getElementById('syncModal').style.display = 'none';
                    }
                });
                // --- Sync Modal: Show code as text, white in dark mode ---
                document.getElementById('generateCodeBtn').onclick = async function() {
                    // Gather data
                    const data = {
                        events: JSON.parse(localStorage.getItem('calendar_events') || '[]'),
                        birthdays: JSON.parse(localStorage.getItem('calendar_birthdays') || '[]'),
                        tasks: JSON.parse(localStorage.getItem('calendar_tasks') || '[]')
                    };
                    // Generate code and expiry
                    const code = generateSyncCode();
                    const expires = Date.now() + 15 * 60 * 1000; // 15 min
                    // Store to backend server API
                    try {
                        const res = await fetch('/api/sync', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ code, data, expires })
                        });
                        if (!res.ok) throw new Error('Server error');
                        showToast('Your sync code: ' + code + ' (expires in 15 min)', 'success');
                        navigator.clipboard && navigator.clipboard.writeText(code).catch(()=>{});
                        var codeText = document.getElementById('generatedCodeText');
                        if (codeText) {
                            codeText.textContent = code + ' (expires in 15 min)';
                            codeText.style.color = document.body.classList.contains('dark-mode') ? '#fff' : '#3c0a7b';
                        }
                    } catch {
                        showToast('Failed to sync with server.', 'error');
                    }
                };
                // Update code text color on theme change
                document.getElementById('themeSelect').addEventListener('change', function() {
                    var codeText = document.getElementById('generatedCodeText');
                    if (codeText && codeText.textContent) {
                        codeText.style.color = document.body.classList.contains('dark-mode') ? '#fff' : '#3c0a7b';
                    }
                });

                // --- Toast ---
                function showToast(msg, type = "info") {
                    let toast = document.getElementById('custom-toast');
                    if (!toast) {
                        toast = document.createElement('div');
                        toast.id = 'custom-toast';
                        toast.style.position = 'fixed';
                        toast.style.bottom = '32px';
                        toast.style.left = '50%';
                        toast.style.transform = 'translateX(-50%)';
                        toast.style.background = '#3c0a7b';
                        toast.style.color = '#fff';
                        toast.style.padding = '14px 32px';
                        toast.style.borderRadius = '10px';
                        toast.style.fontSize = '16px';
                        toast.style.boxShadow = '0 2px 8px rgba(0,0,0,0.18)';
                        toast.style.zIndex = 9999;
                        toast.style.transition = 'opacity 0.3s';
                        toast.style.opacity = '0';
                        document.body.appendChild(toast);
                    }
                    toast.textContent = msg;
                    toast.style.background = type === "error" ? "#e53935" : (type === "success" ? "#00e676" : "#3c0a7b");
                    toast.style.opacity = '1';
                    setTimeout(() => { toast.style.opacity = '0'; }, 3000);
                }

                // --- Confirm ---
                function showSyncConfirm(msg, cb) {
                    let modal = document.getElementById('sync-confirm-modal');
                    if (!modal) {
                        modal = document.createElement('div');
                        modal.id = 'sync-confirm-modal';
                        modal.style.position = 'fixed';
                        modal.style.top = '0';
                        modal.style.left = '0';
                        modal.style.width = '100vw';
                        modal.style.height = '100vh';
                        modal.style.background = 'rgba(44,0,83,0.25)';
                        modal.style.zIndex = 9998;
                        modal.innerHTML = `
                            <div style="background:#fff;max-width:340px;margin:120px auto 0 auto;padding:28px 18px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.18);text-align:center;">
                                <div id="sync-confirm-msg" style="margin-bottom:18px;font-size:17px;color:#3c0a7b;"></div>
                                <div style="display:flex;gap:12px;justify-content:center;">
                                    <button id="sync-confirm-yes" style="background:#e53935;color:#fff;border:none;border-radius:6px;padding:8px 22px;font-size:15px;cursor:pointer;">Yes</button>
                                    <button id="sync-confirm-no" style="background:#8200fc;color:#fff;border:none;border-radius:6px;padding:8px 22px;font-size:15px;cursor:pointer;">No</button>
                                </div>
                            </div>
                        `;
                        document.body.appendChild(modal);
                    }
                    modal.querySelector('#sync-confirm-msg').textContent = msg;
                    modal.style.display = 'block';
                    modal.querySelector('#sync-confirm-yes').onclick = function() {
                        modal.style.display = 'none';
                        cb(true);
                    };
                    modal.querySelector('#sync-confirm-no').onclick = function() {
                        modal.style.display = 'none';
                        cb(false);
                    };
                }

                // --- Generate 12-digit code ---
                function generateSyncCode() {
                    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // no O/0/I/1 for clarity
                    let code = '';
                    for (let i = 0; i < 12; i++) {
                        code += chars[Math.floor(Math.random() * chars.length)];
                    }
                    return code;
                }

                // --- Import Data ---
                document.getElementById('importCodeInput').addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        importSyncCode();
                    }
                });
                document.getElementById('importCodeInput').addEventListener('blur', function(e) {
                    // Optionally, auto-import on blur
                    // importSyncCode();
                });
                async function importSyncCode() {
                    const code = document.getElementById('importCodeInput').value.trim().toUpperCase();
                    if (!/^[A-Z2-9]{12}$/.test(code)) {
                        showToast('Invalid code format.', 'error');
                        return;
                    }
                    // Fetch from backend API
                    try {
                        const res = await fetch('/api/sync?code=' + code);
                        if (!res.ok) {
                            showToast('Code not found or expired.', 'error');
                            return;
                        }
                        const obj = await res.json();
                        if (!obj.expires || Date.now() > obj.expires) {
                            showToast('Code expired.', 'error');
                            return;
                        }
                        // Confirm before import
                        showSyncConfirm('Importing will overwrite your current data. Continue?', async function(yes) {
                            if (!yes) return;
                            // Import data
                            localStorage.setItem('calendar_events', JSON.stringify(obj.data.events || []));
                            localStorage.setItem('calendar_birthdays', JSON.stringify(obj.data.birthdays || []));
                            localStorage.setItem('calendar_tasks', JSON.stringify(obj.data.tasks || []));
                            // Optionally, delete code from server (if API supports)
                            try { await fetch('/api/sync?code=' + code, { method: 'DELETE' }); } catch {}
                            showToast('Data imported successfully!', 'success');
                            setTimeout(()=>window.location.reload(), 1200);
                        });
                    } catch {
                        showToast('Failed to import from server.', 'error');
                    }
                }
                // Add import button for UX (optional)
                if (!document.getElementById('importCodeBtn')) {
                    const btn = document.createElement('button');
                    btn.className = 'btn';
                    btn.id = 'importCodeBtn';
                    btn.textContent = 'Import Code';
                    btn.style.marginTop = '10px';
                    btn.onclick = importSyncCode;
                    document.getElementById('importCodeInput').parentNode.appendChild(btn);
                }


            </script>
        </div>
        <script>
            



            const settingsBtn = document.getElementById('settings');
            const settingsModal = document.getElementById('settingsModal');
            const closeSettings = document.getElementById('closeSettings');

            settingsBtn.addEventListener('click', function() {
                settingsModal.style.display = 'block';
            });
            closeSettings.addEventListener('click', function() {
                settingsModal.style.display = 'none';
            });
            window.addEventListener('click', function(event) {
                if (event.target === settingsModal) {
                    settingsModal.style.display = 'none';
                }
            });


 

            // Theme dropdown logic
            const themeSelect = document.getElementById('themeSelect');
            function applyTheme(theme) {
                if (theme === 'dark') {
                    document.body.classList.add('dark-mode');
                } else if (theme === 'light') {
                    document.body.classList.remove('dark-mode');
                } else if (theme === 'system') {
                    // Use prefers-color-scheme
                    if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                        document.body.classList.add('dark-mode');
                    } else {
                        document.body.classList.remove('dark-mode');
                    }
                }
            }
            // Load theme from localStorage
            const savedTheme = localStorage.getItem('calendar_theme') || 'system';
            themeSelect.value = savedTheme;
            applyTheme(savedTheme);
            themeSelect.onchange = function() {
                localStorage.setItem('calendar_theme', themeSelect.value);
                applyTheme(themeSelect.value);
            };
            // Listen for system theme changes if system selected
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
                if ((localStorage.getItem('calendar_theme') || 'system') === 'system') {
                    applyTheme('system');
                }
            });

            // Language dropdown logic (functional)
            const languageSelect = document.getElementById('languageSelect');
            const savedLang = localStorage.getItem('calendar_language') || 'en';
            languageSelect.value = savedLang;

            // Simple translations for demonstration
            const translations = {
                en: {
                    'Calendar': 'Calendar',
                    'Mini Calendar': 'Mini Calendar',
                    'My Calendars': 'My Calendars',
                    'Birthdays list': 'Birthdays list',
                    'Create': 'Create',
                    'Create Task': 'Create Task',
                    'Create Birthday': 'Create Birthday',
                    'Create Event': 'Create Event',
                    'Today': 'Today',
                    'Help': 'Help',
                    'Settings': 'Settings',
                    'Events List': 'Events List',
                    'Event Title:': 'Event Title:',
                    'Event Date:': 'Event Date:',
                    'Event Time:': 'Event Time:',
                    'Save Changes': 'Save Changes',
                    'Task Title:': 'Task Title:',
                    'Due Date:': 'Due Date:',
                    'Name:': 'Name:',
                    'Birthday Date:': 'Birthday Date:',
                    'Holidays This Month': 'Holidays This Month',
                    'No holidays this month.': 'No holidays this month.',
                    'No birthdays yet.': 'No birthdays yet.',
                    'No events.': 'No events.',
                    'No birthdays.': 'No birthdays.',
                    'No tasks.': 'No tasks.',
                    'Month': 'Month',
                    'Week': 'Week',
                    'Year': 'Year',
                    'Day': 'Day',
                    'Agenda': 'Agenda',
                    'Language': 'Language',
                    'Timeline': 'Timeline'

                },
                es: {
                    'Calendar': 'Calendario',
                    'Mini Calendar': 'Mini Calendario',
                    'My Calendars': 'Mis calendarios',
                    'Birthdays list': 'Lista de cumpleaños',
                    'Create': 'Crear',
                    'Create Task': 'Crear tarea',
                    'Create Birthday': 'Crear cumpleaños',
                    'Create Event': 'Crear evento',
                    'Today': 'Hoy',
                    'Help': 'Ayuda',
                    'Settings': 'Configuración',
                    'Events List': 'Lista de eventos',
                    'Event Title:': 'Título del evento:',
                    'Event Date:': 'Fecha del evento:',
                    'Event Time:': 'Hora del evento:',
                    'Save Changes': 'Guardar cambios',
                    'Task Title:': 'Título de la tarea:',
                    'Due Date:': 'Fecha límite:',
                    'Name:': 'Nombre:',
                    'Birthday Date:': 'Fecha de cumpleaños:',
                    'Holidays This Month': 'Festivos este mes',
                    'No holidays this month.': 'No hay festivos este mes.',
                    'No birthdays yet.': 'Aún no hay cumpleaños.',
                    'No events.': 'No hay eventos.',
                    'No birthdays.': 'No hay cumpleaños.',
                    'No tasks.': 'No hay tareas.',
                    'Month': 'Mes',
                    'Week': 'Semana',
                    'Year': 'Año',
                    'Language': 'Idioma',
                    'Day': 'Día',
                    'Agenda': 'Agenda',
                    'Timeline': 'Cronología'
                },
                fr: {
                    'Calendar': 'Calendrier',
                    'Mini Calendar': 'Mini calendrier',
                    'My Calendars': 'Mes calendriers',
                    'Birthdays list': 'Liste des anniversaires',
                    'Create': 'Créer',
                    'Create Task': 'Créer une tâche',
                    'Create Birthday': 'Créer un anniversaire',
                    'Create Event': 'Créer un événement',
                    'Today': 'Aujourd\'hui',
                    'Language': 'Langue',
                    'Help': 'Aide',
                    'Settings': 'Paramètres',
                    'Events List': 'Liste des événements',
                    'Event Title:': 'Titre de l\'événement :',
                    'Event Date:': 'Date de l\'événement :',
                    'Event Time:': 'Heure de l\'événement :',
                    'Save Changes': 'Enregistrer les modifications',
                    'Task Title:': 'Titre de la tâche :',
                    'Due Date:': 'Date d\'échéance :',
                    'Name:': 'Nom :',
                    'Birthday Date:': 'Date d\'anniversaire :',
                    'Holidays This Month': 'Jours fériés ce mois-ci',
                    'No holidays this month.': 'Aucun jour férié ce mois-ci.',
                    'No birthdays yet.': 'Pas encore d\'anniversaires.',
                    'No events.': 'Aucun événement.',
                    'No birthdays.': 'Aucun anniversaire.',
                    'No tasks.': 'Aucune tâche.',
                    'Month': 'Mois',
                    'Week': 'Semaine',
                    'Year': 'Année',
                    'Day': 'Jour',
                    'Agenda': 'Agenda',
                    'Timeline': 'Chronologie'
                },
                // Add more languages as needed
                de: {
                    'Calendar': 'Kalender',
                    'Mini Calendar': 'Mini-Kalender',
                    'My Calendars': 'Meine Kalender',
                    'Birthdays list': 'Geburtstagsliste',
                    'Create': 'Erstellen',
                    'Create Task': 'Aufgabe erstellen',
                    'Create Birthday': 'Geburtstag erstellen',
                    'Create Event': 'Ereignis erstellen',
                    'Today': 'Heute',
                    'Help': 'Hilfe',
                    'Settings': 'Einstellungen',
                    'Events List': 'Ereignisliste',
                    'Event Title:': 'Ereignistitel:',
                    'Event Date:': 'Ereignisdatum:',
                    'Event Time:': 'Ereigniszeit:',
                    'Save Changes': 'Änderungen speichern',
                    'Task Title:': 'Aufgabentitel:',
                    'Due Date:': 'Fälligkeitsdatum:',
                    'Name:': 'Name:',
                    'Birthday Date:': 'Geburtsdatum:',
                    'Holidays This Month': 'Feiertage diesen Monat',
                    'No holidays this month.': 'Keine Feiertage diesen Monat.',
                    'No birthdays yet.': 'Noch keine Geburtstage.',
                    'No events.': 'Keine Ereignisse.',
                    'No birthdays.': 'Keine Geburtstage.',
                    'No tasks.': 'Keine Aufgaben.',
                    'Language': 'Sprache',
                    'Month': 'Monat',
                    'Week': 'Woche',
                    'Year': 'Jahr',
                    'Day': 'Tag',
                    'Agenda': 'Agenda',
                    'Timeline': 'Zeitachse'
                },
                ru: {
                    'Calendar': 'Календарь',
                    'Mini Calendar': 'Мини-календарь',
                    'My Calendars': 'Мои календари',
                    'Birthdays list': 'Список дней рождения',
                    'Create': 'Создать',
                    'Create Task': 'Создать задачу',
                    'Create Birthday': 'Добавить день рождения',
                    'Create Event': 'Создать событие',
                    'Today': 'Сегодня',
                    'Help': 'Помощь',
                    'Settings': 'Настройки',
                    'Events List': 'Список событий',
                    'Event Title:': 'Название события:',
                    'Event Date:': 'Дата события:',
                    'Event Time:': 'Время события:',
                    'Save Changes': 'Сохранить изменения',
                    'Task Title:': 'Название задачи:',
                    'Language': 'Язык',
                    'Due Date:': 'Срок выполнения:',
                    'Name:': 'Имя:',
                    'Birthday Date:': 'Дата рождения:',
                    'Holidays This Month': 'Праздники в этом месяце',
                    'No holidays this month.': 'В этом месяце нет праздников.',
                    'No birthdays yet.': 'Пока нет дней рождения.',
                    'No events.': 'Нет событий.',
                    'No birthdays.': 'Нет дней рождения.',
                    'No tasks.': 'Нет задач.',
                    'Month': 'Месяц',
                    'Week': 'Неделя',
                    'Year': 'Год',
                    'Day': 'День',
                    'Agenda': 'Повестка',
                    'Timeline': 'Хронология'
                },
                zh: {
                    'Calendar': '日历',
                    'Mini Calendar': '迷你日历',
                    'My Calendars': '我的日历',
                    'Birthdays list': '生日列表',
                    'Create': '创建',
                    'Create Task': '创建任务',
                    'Create Birthday': '创建生日',
                    'Create Event': '创建事件',
                    'Today': '今天',
                    'Help': '帮助',
                    'Settings': '设置',
                    'Events List': '事件列表',
                    'Event Title:': '事件标题：',
                    'Event Date:': '事件日期：',
                    'Event Time:': '事件时间：',
                    'Save Changes': '保存更改',
                    'Language': '语言',
                    'Task Title:': '任务标题：',
                    'Due Date:': '截止日期：',
                    'Name:': '姓名：',
                    'Birthday Date:': '生日日期：',
                    'Holidays This Month': '本月节假日',
                    'No holidays this month.': '本月没有节假日。',
                    'No birthdays yet.': '还没有生日。',
                    'No events.': '没有事件。',
                    'No birthdays.': '没有生日。',
                    'No tasks.': '没有任务。',
                    'Month': '月',
                    'Week': '周',
                    'Year': '年',
                    'Day': '日',
                    'Agenda': '议程',
                    'Timeline': '时间线'
                },
                ja: {
                    'Calendar': 'カレンダー',
                    'Mini Calendar': 'ミニカレンダー',
                    'My Calendars': 'マイカレンダー',
                    'Birthdays list': '誕生日リスト',
                    'Create': '作成',
                    'Create Task': 'タスクを作成',
                    'Create Birthday': '誕生日を作成',
                    'Create Event': 'イベントを作成',
                    'Today': '今日',
                    'Help': 'ヘルプ',
                    'Settings': '設定',
                    'Language': '言語',
                    'Events List': 'イベントリスト',
                    'Event Title:': 'イベントタイトル：',
                    'Event Date:': 'イベント日付：',
                    'Event Time:': 'イベント時間：',
                    'Save Changes': '変更を保存',
                    'Task Title:': 'タスクタイトル：',
                    'Due Date:': '期限日：',
                    'Name:': '名前：',
                    'Birthday Date:': '誕生日：',
                    'Holidays This Month': '今月の祝日',
                    'No holidays this month.': '今月は祝日がありません。',
                    'No birthdays yet.': 'まだ誕生日がありません。',
                    'No events.': 'イベントがありません。',
                    'No birthdays.': '誕生日がありません。',
                    'No tasks.': 'タスクがありません。',
                    'Month': '月',
                    'Week': '週',
                    'Year': '年',
                    'Day': '日',
                    'Agenda': '予定',
                    'Timeline': 'タイムライン'
                },
                ko: {
                    'Calendar': '달력',
                    'Mini Calendar': '미니 달력',
                    'My Calendars': '내 달력',
                    'Birthdays list': '생일 목록',
                    'Create': '생성',
                    'Create Task': '작업 생성',
                    'Create Birthday': '생일 생성',
                    'Create Event': '이벤트 생성',
                    'Today': '오늘',
                    'Help': '도움말',
                    'Settings': '설정',
                    'Events List': '이벤트 목록',
                    'Event Title:': '이벤트 제목:',
                    'Event Date:': '이벤트 날짜:',
                    'Event Time:': '이벤트 시간:',
                    'Save Changes': '변경 사항 저장',
                    'Task Title:': '작업 제목:',
                    'Due Date:': '마감일:',
                    'Name:': '이름:',
                    'Birthday Date:': '생일 날짜:',
                    'Language': '언어',
                    'Holidays This Month': '이번 달의 휴일',
                    'No holidays this month.': '이번 달에는 휴일이 없습니다.',
                    'No birthdays yet.': '아직 생일이 없습니다.',
                    'No events.': '이벤트가 없습니다.',
                    'No birthdays.': '생일이 없습니다.',
                    'No tasks.': '작업이 없습니다.',
                    'Month': '월',
                    'Week': '주',
                    'Year': '년',
                    'Day': '일',
                    'Agenda': '일정',
                    'Timeline': '타임라인'
                },
                pt: {
                    'Calendar': 'Calendário',
                    'Mini Calendar': 'Mini calendário',
                    'My Calendars': 'Meus calendários',
                    'Birthdays list': 'Lista de aniversários',
                    'Create': 'Criar',
                    'Create Task': 'Criar tarefa',
                    'Create Birthday': 'Criar aniversário',
                    'Create Event': 'Criar evento',
                    'Today': 'Hoje',
                    'Help': 'Ajuda',
                    'Settings': 'Configurações',
                    'Events List': 'Lista de eventos',
                    'Event Title:': 'Título do evento:',
                    'Event Date:': 'Data do evento:',
                    'Event Time:': 'Hora do evento:',
                    'Save Changes': 'Salvar alterações',
                    'Task Title:': 'Título da tarefa:',
                    'Due Date:': 'Data de vencimento:',
                    'Name:': 'Nome:',
                    'Birthday Date:': 'Data de aniversário:',
                    'Holidays This Month': 'Feriados deste mês',
                    'No holidays this month.': 'Nenhum feriado este mês.',
                    'No birthdays yet.': 'Nenhum aniversário ainda.',
                    'No events.': 'Nenhum evento.',
                    'No birthdays.': 'Nenhum aniversário.',
                    'No tasks.': 'Nenhuma tarefa.',
                    'Language': 'Idioma',
                    'Month': 'Mês',
                    'Week': 'Semana',
                    'Year': 'Ano',
                    'Day': 'Dia',
                    'Agenda': 'Agenda',
                    'Timeline': 'Linha do tempo'
                }
            };

            function translatePage(lang) {
                const t = translations[lang] || translations['en'];
                // Translate static text by selector and textContent
                const map = [
                    { selector: 'h1', key: 'Calendar' },
                    { selector: '.logo-text', key: 'Calendar' },
                    { selector: '.sidebar-section h3', key: 'My Calendars', index: 0 },
                    { selector: '.sidebar-section h3', key: 'Birthdays list', index: 1 },
                    { selector: '.calendar-sidebar-view h3', key: 'Mini Calendar' },
                    { selector: '.btn .create-label', key: 'Create' },
                    { selector: '#createTaskForm label[for="taskTitle"]', key: 'Task Title:' },
                    { selector: '#createTaskForm label[for="taskDueDate"]', key: 'Due Date:' },
                    { selector: '#createTaskForm button[type="submit"]', key: 'Create Task' },
                    { selector: '#createBirthdayForm label[for="birthdayName"]', key: 'Name:' },
                    { selector: '#createBirthdayForm label[for="birthdayDate"]', key: 'Birthday Date:' },
                    { selector: '#createBirthdayForm button[type="submit"]', key: 'Create Birthday' },
                    { selector: '#createEventForm label[for="eventTitle"]', key: 'Event Title:' },
                    { selector: '#createEventForm label[for="eventDate"]', key: 'Event Date:' },
                    { selector: '#createEventForm label[for="eventTime"]', key: 'Event Time:' },
                    { selector: '#createEventForm button[type="submit"]', key: 'Create Event' },
                    { selector: '#todayBtn', key: 'Today' },
                    { selector: '#help-btn', key: 'Help', svg: true },
                    { selector: '#settings', key: 'Settings', svg: true },
                    { selector: '#eventsList h2', key: 'Events List' },
                    { selector: '#editEventForm label[for="editEventTitle"]', key: 'Event Title:' },
                    { selector: '#editEventForm label[for="editEventDate"]', key: 'Event Date:' },
                    { selector: '#editEventForm label[for="editEventTime"]', key: 'Event Time:' },
                    { selector: '#editEventForm button[type="submit"]', key: 'Save Changes' },
                    { selector: '#editTaskForm label[for="editTaskTitle"]', key: 'Task Title:' },
                    { selector: '#editTaskForm label[for="editTaskDueDate"]', key: 'Due Date:' },
                    { selector: '#editTaskForm button[type="submit"]', key: 'Save Changes' },
                    { selector: '#editBirthdayForm label[for="editBirthdayName"]', key: 'Name:' },
                    { selector: '#editBirthdayForm label[for="editBirthdayDate"]', key: 'Birthday Date:' },
                    { selector: '#editBirthdayForm button[type="submit"]', key: 'Save Changes' },
                    { selector: '#holiday-list h3', key: 'Holidays This Month' },
                ];
                map.forEach(item => {
                    let el = document.querySelectorAll(item.selector);
                    if (el && el.length) {
                        if (typeof item.index === 'number') {
                            el = [el[item.index]];
                        }
                        el.forEach(e => {
                            // Only replace text if element does not contain an SVG (icon-only buttons)
                            if (e && !e.querySelector('svg')) {
                                e.textContent = t[item.key] || item.key;
                            }
                        });
                    }
                });
                // Translate select options for calendar view
                const viewSelect = document.getElementById('calendarViewSelect');
                if (viewSelect) {
                    Array.from(viewSelect.options).forEach(opt => {
                        if (t[opt.value]) opt.textContent = t[opt.value];
                    });
                }
                // Translate weekDropdown
                const weekDropdown = document.getElementById('weekDropdown');
                if (weekDropdown) {
                    Array.from(weekDropdown.options).forEach(opt => {
                        if (t[opt.value]) opt.textContent = t[opt.value];
                    });
                }
                // Translate some dynamic content (holiday list, birthdays, events)
                const holidayUl = document.getElementById('holiday-ul');
                if (holidayUl && holidayUl.children.length === 1) {
                    if (holidayUl.children[0].textContent.trim().toLowerCase().includes('no holidays')) {
                        holidayUl.children[0].textContent = t['No holidays this month.'];
                    }
                }
                // Birthdays list in sidebar
                document.querySelectorAll('.sidebar-section ul').forEach(ul => {
                    if (ul.children.length === 1 && ul.children[0].textContent.trim().toLowerCase().includes('no birthdays')) {
                        ul.children[0].textContent = t['No birthdays yet.'];
                    }
                });
                // Events modal empty states
                const eventsUl = document.getElementById('eventsUl');
                if (eventsUl && eventsUl.children.length === 1) {
                    const txt = eventsUl.children[0].textContent.trim().toLowerCase();
                    if (txt.includes('no events')) eventsUl.children[0].textContent = t['No events.'];
                    if (txt.includes('no birthdays')) eventsUl.children[0].textContent = t['No birthdays.'];
                    if (txt.includes('no tasks')) eventsUl.children[0].textContent = t['No tasks.'];
                }
            }

            // On change, save and translate
            languageSelect.onchange = function() {
                localStorage.setItem('calendar_language', languageSelect.value);
                translatePage(languageSelect.value);
            };

            // Initial translation
            translatePage(savedLang);
        </script>
    </div>
 </div>
<!-- Sync Modal: Export/Import as JSON file -->
<div class="modal" id="syncModal">
    <div class="modal-content">
        <span class="close" id="closeSyncModal">&times;</span>
        <h2>Sync Data</h2>
        <h3>Export Data as backup.json:</h3>
        <button class="btn" id="exportJsonBtn">Export Backup</button>
        <div id="exportStatus" style="margin-top:10px;font-size:16px;font-weight:bold;color:#3c0a7b;"></div>
        <h3>Import Data from backup.json:</h3>
        <input type="file" id="importJsonInput" accept=".json" style="margin-top:8px;">
        <div id="importStatus" style="margin-top:10px;font-size:16px;font-weight:bold;color:#3c0a7b;"></div>
    </div>
</div>
<script>
    // --- Export as JSON ---
    document.getElementById('exportJsonBtn').onclick = function() {
        const data = {
            events: JSON.parse(localStorage.getItem('calendar_events') || '[]'),
            birthdays: JSON.parse(localStorage.getItem('calendar_birthdays') || '[]'),
            tasks: JSON.parse(localStorage.getItem('calendar_tasks') || '[]')
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'backup.json';
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }, 100);
        document.getElementById('exportStatus').textContent = 'Backup downloaded as backup.json';
        setTimeout(() => { document.getElementById('exportStatus').textContent = ''; }, 3000);
    };

    // --- Import from JSON ---
    document.getElementById('importJsonInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(evt) {
            try {
                const obj = JSON.parse(evt.target.result);
                if (!obj || typeof obj !== 'object') throw new Error();
                // Confirm before import
                showSyncConfirm('Importing will overwrite your current data. Continue?', function(yes) {
                    if (!yes) return;
                    localStorage.setItem('calendar_events', JSON.stringify(obj.events || []));
                    localStorage.setItem('calendar_birthdays', JSON.stringify(obj.birthdays || []));
                    localStorage.setItem('calendar_tasks', JSON.stringify(obj.tasks || []));
                    document.getElementById('importStatus').textContent = 'Data imported successfully!';
                    setTimeout(()=>window.location.reload(), 1200);
                });
            } catch {
                document.getElementById('importStatus').textContent = 'Invalid backup.json file.';
                setTimeout(() => { document.getElementById('importStatus').textContent = ''; }, 3000);
            }
        };
        reader.readAsText(file);
    });

    // --- Close icon for sync modal ---
    document.getElementById('closeSyncModal').onclick = function() {
        document.getElementById('syncModal').style.display = 'none';
        document.getElementById('exportStatus').textContent = '';
        document.getElementById('importStatus').textContent = '';
        document.getElementById('importJsonInput').value = '';
    };
    // Also close modal when clicking outside modal-content
    window.addEventListener('click', function(event) {
        var syncModal = document.getElementById('syncModal');
        if (event.target === syncModal) {
            syncModal.style.display = 'none';
            document.getElementById('exportStatus').textContent = '';
            document.getElementById('importStatus').textContent = '';
            document.getElementById('importJsonInput').value = '';
        }
    });

    // --- Confirm dialog for import ---
    function showSyncConfirm(msg, cb) {
        let modal = document.getElementById('sync-confirm-modal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'sync-confirm-modal';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100vw';
            modal.style.height = '100vh';
            modal.style.background = 'rgba(44,0,83,0.25)';
            modal.style.zIndex = 9998;
            modal.innerHTML = `
                <div style="background:#fff;max-width:340px;margin:120px auto 0 auto;padding:28px 18px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.18);text-align:center;">
                    <div id="sync-confirm-msg" style="margin-bottom:18px;font-size:17px;color:#3c0a7b;"></div>
                    <div style="display:flex;gap:12px;justify-content:center;">
                        <button id="sync-confirm-yes" style="background:#e53935;color:#fff;border:none;border-radius:6px;padding:8px 22px;font-size:15px;cursor:pointer;">Yes</button>
                        <button id="sync-confirm-no" style="background:#8200fc;color:#fff;border:none;border-radius:6px;padding:8px 22px;font-size:15px;cursor:pointer;">No</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        modal.querySelector('#sync-confirm-msg').textContent = msg;
        modal.style.display = 'block';
        modal.querySelector('#sync-confirm-yes').onclick = function() {
            modal.style.display = 'none';
            cb(true);
        };
        modal.querySelector('#sync-confirm-no').onclick = function() {
            modal.style.display = 'none';
            cb(false);
        };
    }
</script>
 <div class="modal" id="createTask">
    <div class="modal-content">
        <span class="close" id="closeCreateTask">&times;</span>
        <h2>Create Task</h2>
        <form id="createTaskForm">
            <label for="taskTitle">Task Title:</label>
            <input type="text" id="taskTitle" name="taskTitle" required>
            <label for="taskDueDate">Due Date:</label>
            <input type="date" id="taskDueDate" name="taskDueDate" required>
            <button class="btn" type="submit">Create Task</button>
        </form>
    </div>
 </div>      
    <script>
    /* --- Events List Modal Logic --- */
    const eventsBtn = document.getElementById('events-btn');
    const eventsListModal = document.getElementById('eventsList');
    const closeEventsList = document.getElementById('closeEventsList');
    const eventsUl = document.getElementById('eventsUl');

    // Tabs logic
    function openTab(evt, tabName) {
        // Hide all tab contents
        const tablinks = eventsListModal.querySelectorAll('.tablinks');
        tablinks.forEach(btn => btn.classList.remove('active'));
        evt.currentTarget.classList.add('active');
        renderEventsList(tabName);
    }

    // Render events/birthdays/tasks in the modal
    function renderEventsList(tab) {
        eventsUl.innerHTML = '';
        if (tab === 'Events') {
            if (events.length === 0) {
                eventsUl.innerHTML = '<li style="color:#aaa;padding:12px;">No events.</li>';
            } else {
                events.forEach((ev, idx) => {
                    const li = document.createElement('li');
                    li.style.padding = '10px 0';
                    li.style.display = 'flex';
                    li.style.justifyContent = 'space-between';
                    li.style.alignItems = 'center';
                    li.innerHTML = `
                        <span>
                            <strong>${ev.title}</strong>
                            <span style="color:#8200fc;font-size:13px;margin-left:8px;">
                                ${ev.date} ${ev.time ? ev.time : ''}
                            </span>
                        </span>
                        <span>
                            <button style="margin-right:8px;background:#8200fc;color:#fff;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;" data-edit="${idx}">Edit</button>
                            <button style="background:#e53935;color:#fff;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;" data-delete="${idx}">Delete</button>
                        </span>
                    `;
                    eventsUl.appendChild(li);
                });
            }
        } else if (tab === 'Birthdays') {
            if (birthdays.length === 0) {
                eventsUl.innerHTML = '<li style="color:#aaa;padding:12px;">No birthdays.</li>';
            } else {
                birthdays.forEach((bd, idx) => {
                    const li = document.createElement('li');
                    li.style.padding = '10px 0';
                    li.style.display = 'flex';
                    li.style.justifyContent = 'space-between';
                    li.style.alignItems = 'center';
                    li.innerHTML = `
                        <span>
                            <strong>${bd.name}</strong>
                            <span style="color:#8200fc;font-size:13px;margin-left:8px;">
                                ${bd.date}
                            </span>
                        </span>
                        <span>
                            <button style="margin-right:8px;background:#8200fc;color:#fff;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;" data-edit-birthday="${idx}">Edit</button>
                            <button style="background:#e53935;color:#fff;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;" data-delete-birthday="${idx}">Delete</button>
                        </span>
                    `;
                    eventsUl.appendChild(li);
                });
            }
        } else if (tab === 'Tasks') {
            if (tasks.length === 0) {
                eventsUl.innerHTML = '<li style="color:#aaa;padding:12px;">No tasks.</li>';
            } else {
                tasks.forEach((tsk, idx) => {
                    const li = document.createElement('li');
                    li.style.padding = '10px 0';
                    li.style.display = 'flex';
                    li.style.justifyContent = 'space-between';
                    li.style.alignItems = 'center';
                    li.innerHTML = `
                        <span>
                            <strong>${tsk.title}</strong>
                            <span style="color:#8200fc;font-size:13px;margin-left:8px;">
                                ${tsk.dueDate}
                            </span>
                        </span>
                        <span>
                            <button style="margin-right:8px;background:#8200fc;color:#fff;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;" data-edit-task="${idx}">Edit</button>
                            <button style="background:#e53935;color:#fff;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;" data-delete-task="${idx}">Delete</button>
                        </span>
                    `;
                    eventsUl.appendChild(li);
                });
            }
        }
    }

    // Open modal on icon click
    eventsBtn.addEventListener('click', function() {
        eventsListModal.style.display = 'block';
        // Default to Events tab
        const defaultTab = eventsListModal.querySelector('.tablinks#defaultOpen');
        if (defaultTab) {
            defaultTab.click();
        } else {
            renderEventsList('Events');
        }
    });

    // Close modal
    closeEventsList.addEventListener('click', function() {
        eventsListModal.style.display = 'none';
    });

    // Handle tab switching
    eventsListModal.querySelectorAll('.tablinks').forEach(btn => {
        btn.onclick = function(e) {
            openTab(e, btn.textContent);
        };
    });

    // Handle edit/delete in the list
    eventsUl.addEventListener('click', function(e) {
        // Events
        if (e.target.dataset.edit !== undefined) {
            openEditEventModal(Number(e.target.dataset.edit));
        }
        if (e.target.dataset.delete !== undefined) {
            const idx = Number(e.target.dataset.delete);
            showConfirmModal('Are you sure you want to delete this event?', function(confirmed) {
                if (confirmed) {
                    events.splice(idx, 1);
                    saveData();
                    updateCalendarView();
                    renderEventsList('Events');
                }
            });
        }
        // Birthdays
        if (e.target.dataset['editBirthday'] !== undefined) {
            openEditBirthdayModal(Number(e.target.dataset['editBirthday']));
        }
        if (e.target.dataset['deleteBirthday'] !== undefined) {
            const idx = Number(e.target.dataset['deleteBirthday']);
            showConfirmModal('Are you sure you want to delete this birthday?', function(confirmed) {
                if (confirmed) {
                    birthdays.splice(idx, 1);
                    saveData();
                    updateCalendarView();
                    renderBirthdayList();
                    renderEventsList('Birthdays');
                }
            });
        }
        // Tasks
        if (e.target.dataset['editTask'] !== undefined) {
            openEditTaskModal(Number(e.target.dataset['editTask']));
        }
        if (e.target.dataset['deleteTask'] !== undefined) {
            const idx = Number(e.target.dataset['deleteTask']);
            showConfirmModal('Are you sure you want to delete this task?', function(confirmed) {
                if (confirmed) {
                    tasks.splice(idx, 1);
                    saveData();
                    updateCalendarView();
                    renderEventsList('Tasks');
                }
            });
        }
    });

    // Edit Birthday Modal logic
    function openEditBirthdayModal(idx) {
        const bd = birthdays[idx];
        document.getElementById('editBirthdayName').value = bd.name;
        document.getElementById('editBirthdayDate').value = bd.date;
        document.getElementById('editBirthday').style.display = 'block';
        // Save handler
        document.getElementById('editBirthdayForm').onsubmit = function(e) {
            e.preventDefault();
            const name = this.editBirthdayName.value.trim();
            const date = this.editBirthdayDate.value;
            if (name && date) {
                birthdays[idx] = { name, date };
                saveData();
                updateCalendarView();
                renderBirthdayList();
                renderEventsList('Birthdays');
                document.getElementById('editBirthday').style.display = 'none';
            }
        };
        // Close handler
        document.getElementById('closeEditBirthday').onclick = function() {
            document.getElementById('editBirthday').style.display = 'none';
        };
    }

    // Edit Task Modal logic
    function openEditTaskModal(idx) {
        const tsk = tasks[idx];
        document.getElementById('editTaskTitle').value = tsk.title;
        document.getElementById('editTaskDueDate').value = tsk.dueDate;
        document.getElementById('editTask').style.display = 'block';
        // Save handler
        document.getElementById('editTaskForm').onsubmit = function(e) {
            e.preventDefault();
            const title = this.editTaskTitle.value.trim();
            const dueDate = this.editTaskDueDate.value;
            if (title && dueDate) {
                tasks[idx] = { title, dueDate };
                saveData();
                updateCalendarView();
                renderEventsList('Tasks');
                document.getElementById('editTask').style.display = 'none';
            }
        };
        // Close handler
        document.getElementById('closeEditTask').onclick = function() {
            document.getElementById('editTask').style.display = 'none';
        };
    }

    // Close modal on outside click
    window.addEventListener('click', function(event) {
        if (event.target === eventsListModal) {
            eventsListModal.style.display = 'none';
        }
    });





        /*
         * Make the "Create" button in the More menu open the create dropdown.
         * This ensures clicking "Create" in the More menu works like the topbar Create button.
         */
        document.addEventListener('DOMContentLoaded', function() {
            // Delegate because More menu is dynamically created
            document.body.addEventListener('click', function(e) {
                if (e.target && e.target.id === 'more-create') {
                    // Directly open the create event modal (default action)
                    showModal('createEvent');
                }
            });
        });



        let events = [];
        let birthdays = [];
        let tasks = [];

        // --- Event/Birthday/Task Storage Helpers ---
        function saveData() {
            localStorage.setItem('calendar_events', JSON.stringify(events));
            localStorage.setItem('calendar_birthdays', JSON.stringify(birthdays));
            localStorage.setItem('calendar_tasks', JSON.stringify(tasks));
        }
        function loadData() {
            events = JSON.parse(localStorage.getItem('calendar_events') || '[]');
            birthdays = JSON.parse(localStorage.getItem('calendar_birthdays') || '[]');
            tasks = JSON.parse(localStorage.getItem('calendar_tasks') || '[]');
        }
        loadData();

        // --- My Calendars Checkbox Logic ---
        // IDs: calendar-birthdays, calendar-events, calendar-family, calendar-tasks, calendar-holidays
        let calendarFilters = {
            birthdays: true,
            events: true,
            family: true,
            tasks: true,
            holidays: true
        };
        function updateCalendarFiltersFromCheckboxes() {
            calendarFilters.birthdays = document.getElementById('calendar-birthdays').checked;
            calendarFilters.events = document.getElementById('calendar-events').checked;
            calendarFilters.family = document.getElementById('calendar-family').checked;
            calendarFilters.tasks = document.getElementById('calendar-tasks').checked;
            calendarFilters.holidays = document.getElementById('calendar-holidays').checked;
            updateCalendarView();
        }
        document.getElementById('calendar-birthdays').addEventListener('change', updateCalendarFiltersFromCheckboxes);
        document.getElementById('calendar-events').addEventListener('change', updateCalendarFiltersFromCheckboxes);
        document.getElementById('calendar-family').addEventListener('change', updateCalendarFiltersFromCheckboxes);
        document.getElementById('calendar-tasks').addEventListener('change', updateCalendarFiltersFromCheckboxes);
        document.getElementById('calendar-holidays').addEventListener('change', updateCalendarFiltersFromCheckboxes);


        // --- Modal Handling ---
        function showModal(id) {
            document.getElementById(id).style.display = 'block';
        }
        function hideModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        // --- Create Button Wrapper ---
        // Replace the single create button with a wrapper dropdown
        function setupCreateButtonWrapper() {
            // Remove old create button if present
            const oldBtn = document.querySelector('.btn.hide-720');
            if (oldBtn) oldBtn.parentNode.removeChild(oldBtn);

            // Create wrapper
            const wrapper = document.createElement('div');
            wrapper.className = 'btn hide-720';
            wrapper.style.position = 'relative';
            wrapper.style.userSelect = 'none';
            wrapper.tabIndex = 0;
            wrapper.innerHTML = `
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" aria-label="Add Icon" xmlns="http://www.w3.org/2000/svg">
                <line x1="10" y1="4" x2="10" y2="16" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
                <line x1="4" y1="10" x2="16" y2="10" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <span class="create-label">Create</span>
            <svg width="16" height="16" style="margin-left:6px;" viewBox="0 0 20 20" fill="none"><path d="M6 8l4 4 4-4" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            <div class="create-dropdown" style="display:none;position:absolute;top:110%;right:0;background:#3c0a7b;color:#fff;min-width:180px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.18);z-index:3002;overflow:hidden;">
                <button style="all:unset;display:block;width:100%;padding:12px 20px;cursor:pointer;font-size:15px;" id="create-event-btn">Create Event</button>
                <button style="all:unset;display:block;width:100%;padding:12px 20px;cursor:pointer;font-size:15px;" id="create-task-btn">Create Task</button>
                <button style="all:unset;display:block;width:100%;padding:12px 20px;cursor:pointer;font-size:15px;" id="create-birthday-btn">Create Birthday</button>
            </div>
            `;
            // Insert wrapper into topbar
            const topRight = document.querySelector('.top-right');
            // Insert before help-btn if possible
            const helpBtn = document.getElementById('help-btn');
            if (helpBtn) {
            topRight.insertBefore(wrapper, helpBtn);
            } else {
            topRight.appendChild(wrapper);
            }

            // Dropdown logic
            const dropdown = wrapper.querySelector('.create-dropdown');
            function closeDropdown() {
            dropdown.style.display = 'none';
            }
            function openDropdown() {
            dropdown.style.display = 'block';
            }
            wrapper.onclick = function(e) {
            e.stopPropagation();
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
            };
            // Keyboard accessibility
            wrapper.onkeydown = function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
            }
            if (e.key === 'Escape') {
                closeDropdown();
            }
            };
            // Close on outside click
            document.addEventListener('click', function(e) {
            if (!wrapper.contains(e.target)) closeDropdown();
            });

            // Button actions
            dropdown.querySelector('#create-event-btn').onclick = function(e) {
            e.stopPropagation();
            showModal('createEvent');
            closeDropdown();
            };
            dropdown.querySelector('#create-task-btn').onclick = function(e) {
            e.stopPropagation();
            showModal('createTask');
            closeDropdown();
            };
            dropdown.querySelector('#create-birthday-btn').onclick = function(e) {
            e.stopPropagation();
            showModal('createBirthday');
            closeDropdown();
            };
        }
        setupCreateButtonWrapper();

        document.getElementById('closeCreateEvent').onclick = () => hideModal('createEvent');
        document.getElementById('closeCreateBirthday').onclick = () => hideModal('createBirthday');
        document.getElementById('closeCreateTask').onclick = () => hideModal('createTask');

        // --- Create Event ---
        document.getElementById('createEventForm').onsubmit = function(e) {
            e.preventDefault();
            const title = this.eventTitle.value.trim();
            const date = this.eventDate.value;
            const time = this.eventTime.value;
            if (title && date && time) {
            events.push({ title, date, time });
            saveData();
            hideModal('createEvent');
            updateCalendarView();
            }
            this.reset();
        };

        /* --- Style events in calendar --- */
        // This function is used by the patched renderMainCalendar above
        // It adds event labels with a green color and rounded background
        function styleEventSpans() {
            // Style event spans in main calendar
            mainBody.querySelectorAll('span[style*="#00e676"]').forEach(span => {
                span.style.background = '#00e676';
                span.style.color = '#fff';
                span.style.borderRadius = '6px';
                span.style.padding = '2px 8px';
                span.style.marginTop = '4px';
                span.style.display = 'inline-block';
                span.style.fontWeight = 'bold';
                span.style.fontSize = '12px';
                span.style.boxShadow = '0 1px 4px rgba(0,0,0,0.08)';
            });
            // Style event spans in Month view (calendarViewArea)
            if (calendarViewArea) {
                calendarViewArea.querySelectorAll('span[style*="#00e676"]').forEach(span => {
                    span.style.background = '#00e676';
                    span.style.color = '#fff';
                    span.style.borderRadius = '6px';
                    span.style.padding = '2px 8px';
                    span.style.marginTop = '4px';
                    span.style.display = 'inline-block';
                    span.style.fontWeight = 'bold';
                    span.style.fontSize = '12px';
                    span.style.boxShadow = '0 1px 4px rgba(0,0,0,0.08)';
                });
            }
        }

        // Call styleEventSpans after calendar renders
        const origUpdateCalendarViewWithEvents = updateCalendarView;
        updateCalendarView = function() {
            origUpdateCalendarViewWithEvents();
            styleEventSpans();
        };



        /* --- Edit Event Modal Logic --- */
        // Create the modal HTML and append to body
        (function() {
            if (document.getElementById('editEventModal')) return;
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'editEventModal';
            modal.innerHTML = `
            <div class="modal-content">
                <span class="close" id="closeEditEventModal">&times;</span>
                <h2>Edit Event</h2>
                <form id="editEventForm">
                <label for="editEventTitle">Event Title:</label>
                <input type="text" id="editEventTitle" name="editEventTitle" required>
                <label for="editEventDate">Event Date:</label>
                <input type="date" id="editEventDate" name="editEventDate" required>
                <label for="editEventTime">Event Time:</label>
                <input type="time" id="editEventTime" name="editEventTime">
                <div style="display:flex;justify-content:space-between;gap:10px;margin-top:18px;">
                    <button type="submit" style="flex:1;">Save</button>
                    <button type="button" id="deleteEventBtn" style="flex:1;background:#e53935;color:#fff;border:none;border-radius:4px;">Delete</button>
                </div>
                </form>
            </div>
            `;
            document.body.appendChild(modal);
        })();

        // Confirm Modal
        (function() {
            if (document.getElementById('confirmModal')) return;
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'confirmModal';
            modal.innerHTML = `
            <div class="modal-content">
                <h2 id="confirmModalTitle" style="margin-bottom:10px;">Confirm</h2>
                <div id="confirmModalMessage" style="margin-bottom:20px;"></div>
                <div style="display:flex;gap:10px;">
                <button id="confirmModalYes" style="flex:1;background:#e53935;color:#fff;border:none;border-radius:4px;">Yes</button>
                <button id="confirmModalNo" style="flex:1;">No</button>
                </div>
            </div>
            `;
            document.body.appendChild(modal);
        })();

        function showConfirmModal(message, callback) {
            const modal = document.getElementById('confirmModal');
            document.getElementById('confirmModalMessage').textContent = message;
            modal.style.display = 'block';
            function cleanup(result) {
            modal.style.display = 'none';
            document.getElementById('confirmModalYes').onclick = null;
            document.getElementById('confirmModalNo').onclick = null;
            if (callback) callback(result);
            }
            document.getElementById('confirmModalYes').onclick = function() { cleanup(true); };
            document.getElementById('confirmModalNo').onclick = function() { cleanup(false); };
        }

        let editingEventIndex = null;

        // Open edit modal for event at index
        function openEditEventModal(idx) {
            editingEventIndex = idx;
            const ev = events[idx];
            // Populate modal fields with current event data
            document.getElementById('editEventTitle').value = ev.title || '';
            document.getElementById('editEventDate').value = ev.date || '';
            document.getElementById('editEventTime').value = ev.time || '';
            document.getElementById('editEvent').style.display = 'block';
            // Focus the first input for better UX
            setTimeout(() => {
                document.getElementById('editEventTitle').focus();
            }, 50);
        }

        // Save edits
        document.getElementById('editEventForm').onsubmit = function(e) {
            e.preventDefault();
            if (editingEventIndex == null) return;
            const title = document.getElementById('editEventTitle').value.trim();
            const date = document.getElementById('editEventDate').value;
            const time = document.getElementById('editEventTime').value;
            if (title && date) {
                // Update the actual event object in the events array
                events[editingEventIndex].title = title;
                events[editingEventIndex].date = date;
                events[editingEventIndex].time = time;
                saveData();
                updateCalendarView();
                renderEventsList('Events'); // Ensure events modal updates
                document.getElementById('editEvent').style.display = 'none';
                editingEventIndex = null;
            }
        };

        // Close modal for dynamically created modal (editEventModal)
        document.getElementById('closeEditEventModal').onclick = function() {
            document.getElementById('editEventModal').style.display = 'none';
            editingEventIndex = null;
        };

        // Close modal for the main edit event modal (editEvent)
        document.getElementById('closeEditEvent').onclick = function() {
            document.getElementById('editEvent').style.display = 'none';
            editingEventIndex = null;
        };

        // Delete event with confirm modal
        document.getElementById('deleteEventBtn').onclick = function() {
            if (editingEventIndex == null) return;
            showConfirmModal('Are you sure you want to delete this event?', function(confirmed) {
            if (confirmed) {
                events.splice(editingEventIndex, 1);
                saveData();
                updateCalendarView();
                document.getElementById('editEvent').style.display = 'none';
                editingEventIndex = null;
            }
            });
        };

        // Click event handler for calendar event spans
        function handleEventClick(e, year, month, day) {
            const title = e.target.dataset.title;
            const date = e.target.dataset.date;
            const time = e.target.dataset.time;
            // Find event index
            const idx = events.findIndex(ev =>
            ev.title === title && ev.date === date && (ev.time || '') === (time || '')
            );
            if (idx !== -1) {
            openEditEventModal(idx);
            }
        }

        // Patch renderMainCalendar to add event click handlers
        // This patch ensures event labels are clickable and open the edit modal
        const origRenderMainCalendarWithEvents = renderMainCalendar;
        renderMainCalendar = function(date) {
            origRenderMainCalendarWithEvents(date);
            // Add click handlers to event spans
            const year = date.getFullYear();
            const month = date.getMonth();
            // Find all event spans in calendar
            mainBody.querySelectorAll('td').forEach(td => {
                // Find the green event label span
                const eventSpan = td.querySelector('span[style*="#00e676"]');
                if (eventSpan) {
                    // There may be multiple events, split by comma
                    const dayNum = Number(td.querySelector('span').textContent);
                    const eventsToday = getEventsForDay(year, month, dayNum);
                    if (eventsToday.length) {
                        eventSpan.innerHTML = '';
                        eventsToday.forEach(ev => {
                            // Only allow editing for real events, not birthdays/tasks
                            const idx = events.findIndex(evv =>
                                evv.title === ev.title && evv.date === ev.date && (evv.time || '') === (ev.time || '')
                            );
                            const evSpan = document.createElement('span');
                            evSpan.textContent = ev.title;
                            evSpan.style.cursor = idx !== -1 ? 'pointer' : 'default';
                            evSpan.style.textDecoration = idx !== -1 ? 'underline' : '';
                            evSpan.style.marginRight = '6px';
                            evSpan.dataset.title = ev.title;
                            evSpan.dataset.date = ev.date;
                            if (ev.time) evSpan.dataset.time = ev.time;
                            if (idx !== -1) {
                                evSpan.onclick = function(evt) {
                                    evt.stopPropagation();
                                    handleEventClick(evt, year, month, dayNum);
                                };
                            }
                            eventSpan.appendChild(evSpan);
                        });
                    }
                }
            });

            // Also patch the calendarViewArea for Month view (if rendered there)
            if (calendarViewArea) {
                calendarViewArea.querySelectorAll('span[style*="#00e676"]').forEach(eventSpan => {
                    const td = eventSpan.closest('td');
                    if (!td) return;
                    const dayNum = Number(td.querySelector('span').textContent);
                    const eventsToday = getEventsForDay(year, month, dayNum);
                    if (eventsToday.length) {
                        eventSpan.innerHTML = '';
                        eventsToday.forEach(ev => {
                            const idx = events.findIndex(evv =>
                                evv.title === ev.title && evv.date === ev.date && (evv.time || '') === (ev.time || '')
                            );
                            const evSpan = document.createElement('span');
                            evSpan.textContent = ev.title;
                            evSpan.style.cursor = idx !== -1 ? 'pointer' : 'default';
                            evSpan.style.textDecoration = idx !== -1 ? 'underline' : '';
                            evSpan.style.marginRight = '6px';
                            evSpan.dataset.title = ev.title;
                            evSpan.dataset.date = ev.date;
                            if (ev.time) evSpan.dataset.time = ev.time;
                            if (idx !== -1) {
                                evSpan.onclick = function(evt) {
                                    evt.stopPropagation();
                                    handleEventClick(evt, year, month, dayNum);
                                };
                            }
                            eventSpan.appendChild(evSpan);
                        });
                    }
                });
            }
        };






        // --- Create Birthday ---
        document.getElementById('createBirthdayForm').onsubmit = function(e) {
            e.preventDefault();
            const name = this.birthdayName.value.trim();
            const date = this.birthdayDate.value;
            if (name && date) {
            birthdays.push({ name, date });
            saveData();
            hideModal('createBirthday');
            updateCalendarView();
            renderBirthdayList();
            }
            this.reset();
        };

        // --- Create Task ---
        document.getElementById('createTaskForm').onsubmit = function(e) {
            e.preventDefault();
            const title = this.taskTitle.value.trim();
            const dueDate = this.taskDueDate.value;
            if (title && dueDate) {
            tasks.push({ title, dueDate });
            saveData();
            hideModal('createTask');
            updateCalendarView();
            }
            this.reset();
        };

        // --- Birthday List in Sidebar ---
        function renderBirthdayList() {
            // Find the correct sidebar-section for birthdays
            const sidebarSections = document.querySelectorAll('.sidebar-section');
            let ul = null;
            sidebarSections.forEach(section => {
            if (section.querySelector('h3') && section.querySelector('h3').textContent.toLowerCase().includes('birthdays')) {
                ul = section.querySelector('ul');
            }
            });
            if (!ul) return;
            ul.innerHTML = '';
            if (birthdays.length === 0) {
            ul.innerHTML = '<li style="color:#aaa;">No birthdays yet.</li>';
            } else {
            birthdays.forEach(b => {
                const d = new Date(b.date);
                ul.innerHTML += `<li>${b.name} - ${d.toLocaleDateString()}</li>`;
            });
            }
        }
        renderBirthdayList();

        // --- Patch calendar rendering to show events/birthdays/tasks ---
        function getEventsForDay(year, month, day) {
            const ymd = (n) => n.toString().padStart(2, '0');
            const dateStr = `${year}-${ymd(month + 1)}-${ymd(day)}`;
            let dayEvents = [];
            // Events
            if (calendarFilters.events) {
            dayEvents = dayEvents.concat(events.filter(ev => ev.date === dateStr));
            }
            // Birthdays (show every year)
            if (calendarFilters.birthdays) {
            dayEvents = dayEvents.concat(birthdays.filter(bd => {
                const [y, m, d] = bd.date.split('-');
                return ymd(Number(m)) == ymd(month + 1) && ymd(Number(d)) == ymd(day);
            }).map(bd => ({ title: `🎂 ${bd.name}'s Birthday`, date: dateStr })));
            }
            // Tasks
            if (calendarFilters.tasks) {
            dayEvents = dayEvents.concat(tasks.filter(tsk => tsk.dueDate === dateStr));
            }
            return dayEvents;
        }

        // Patch renderMainCalendar and updateCalendarView to show events/birthdays/tasks
        const origRenderMainCalendar = renderMainCalendar;
        renderMainCalendar = function(date) {
            const year = date.getFullYear();
            const month = date.getMonth();
            mainMonth.textContent = date.toLocaleString(undefined, { month: 'long', year: 'numeric' });

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            let monthHolidays = getHolidaysForMonth(year, month);
            // Filter holidays if unchecked
            if (!calendarFilters.holidays) monthHolidays = [];

            let html = '';
            let day = 1;
            for (let i = 0; i < 6; i++) {
            html += '<tr>';
            for (let j = 0; j < 7; j++) {
                if ((i === 0 && j < firstDay) || day > daysInMonth) {
                html += '<td style="padding:8px 0;"></td>';
                } else {
                const isToday =
                    day === (new Date()).getDate() &&
                    month === (new Date()).getMonth() &&
                    year === (new Date()).getFullYear();

                let holiday = monthHolidays.find(h => {
                    if (/^\d{4}-\d{2}-\d{2}$/.test(h.date)) {
                    const d = new Date(h.date);
                    return d.getDate() === day;
                    } else if (/^\d{2}-\d{2}$/.test(h.date)) {
                    const [mm, dd] = h.date.split('-').map(Number);
                    return dd === day;
                    }
                    return false;
                });

                const eventsToday = getEventsForDay(year, month, day);

                html += `<td style="padding:8px 0; text-align:center; vertical-align:top;">
                    <div style="display:flex; flex-direction:column; align-items:center;">
                    <span style="
                    display:inline-block;
                    width:36px;
                    height:36px;
                    line-height:36px;
                    border-radius:8px;
                    background:${isToday ? '#8200fc' : (holiday ? '#ffb347' : 'none')};
                    color:${isToday ? '#fff' : (holiday ? '#fff' : (document.body.classList.contains('dark-mode') ? '#fff' : '#3c0a7b'))};
                    font-weight:${isToday || holiday ? 'bold' : 'normal'};
                    font-size:16px;
                    cursor:pointer;
                    transition:background 0.2s;
                    border:${holiday ? '2px solid #ff9800' : 'none'};
                    box-shadow:${isToday ? '0 0 0 2px #fff, 0 0 8px #8200fc55' : ''};
                    " title="${holiday ? holiday.name : ''}">
                    ${day}${holiday ? ' 🎉' : ''}
                    </span>
                    ${holiday ? `<span style="font-size:11px; color:#ffb347; font-weight:bold; margin-top:2px;">${holiday.name}</span>` : ''}
                    ${eventsToday.length > 0 ? `<span style="font-size:11px; color:#00e676; margin-top:2px;">${eventsToday.map(e => e.title).join(', ')}</span>` : ''}
                    </div>
                </td>`;
                day++;
                }
            }
            html += '</tr>';
            if (day > daysInMonth) break;
            }
            mainBody.innerHTML = html;

            // Render holiday list
            holidayUl.innerHTML = '';
            if (monthHolidays.length === 0) {
            holidayUl.innerHTML = '<li style="color:#aaa;">No holidays this month.</li>';
            } else {
            monthHolidays.forEach(h => {
                let d;
                if (/^\d{4}-\d{2}-\d{2}$/.test(h.date)) {
                d = new Date(h.date);
                } else if (/^\d{2}-\d{2}$/.test(h.date)) {
                d = new Date(year + '-' + h.date);
                }
                holidayUl.innerHTML += `<li><strong>${d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' })}:</strong> ${h.name}</li>`;
            });
            }
        };

        // Patch updateCalendarView for Month view to use new renderMainCalendar
        const origUpdateCalendarView = updateCalendarView;
        updateCalendarView = function() {
            const view = calendarViewSelect.value;
            if (view === 'Month') {
            renderMainCalendar(mainDate);
            document.getElementById('holiday-list').style.display = '';
            mainMonth.textContent = mainDate.toLocaleString(undefined, { month: 'long', year: 'numeric' });
            } else {
            origUpdateCalendarView();
            }
        };

        // --- SEARCH FUNCTIONALITY ---
        // Desktop search bar
        const searchInput = document.querySelector('.search-bar input');
        function searchAll(query) {
            query = query.trim().toLowerCase();
            if (!query) return [];
            let results = [];
            // Events
            events.forEach(ev => {
            if (ev.title.toLowerCase().includes(query) || ev.date.includes(query) || (ev.time && ev.time.includes(query))) {
                results.push({ type: 'Event', ...ev });
            }
            });
            // Birthdays
            birthdays.forEach(bd => {
            if (bd.name.toLowerCase().includes(query) || bd.date.includes(query)) {
                results.push({ type: 'Birthday', ...bd });
            }
            });
            // Tasks
            tasks.forEach(tsk => {
            if (tsk.title.toLowerCase().includes(query) || tsk.dueDate.includes(query)) {
                results.push({ type: 'Task', ...tsk });
            }
            });
            return results;
        }

        function showSearchResults(results, anchorEl) {
            // Remove old results
            let old = document.getElementById('search-results-dropdown');
            if (old) old.remove();
            if (!results.length) return;
            // Create dropdown
            const dropdown = document.createElement('div');
            dropdown.id = 'search-results-dropdown';
            dropdown.style.position = 'absolute';
            dropdown.style.left = anchorEl.getBoundingClientRect().left + window.scrollX + 'px';
            dropdown.style.top = (anchorEl.getBoundingClientRect().bottom + window.scrollY) + 'px';
            dropdown.style.background = '#fff';
            dropdown.style.color = '#3c0a7b';
            dropdown.style.minWidth = anchorEl.offsetWidth + 'px';
            dropdown.style.borderRadius = '10px';
            dropdown.style.boxShadow = '0 2px 8px rgba(0,0,0,0.18)';
            dropdown.style.zIndex = 3003;
            dropdown.style.maxHeight = '320px';
            dropdown.style.overflowY = 'auto';
            dropdown.innerHTML = results.map(r => {
            let dateStr = r.date || r.dueDate || '';
            let dateDisp = dateStr ? new Date(dateStr).toLocaleDateString() : '';
            let timeDisp = r.time ? ` ${r.time}` : '';
            return `<div style="padding:10px 18px;cursor:pointer;border-bottom:1px solid #eee;" tabindex="0">
                <span style="font-weight:bold;">${r.type}:</span> ${r.title || r.name}
                <span style="color:#8200fc;font-size:13px;margin-left:8px;">${dateDisp}${timeDisp}</span>
            </div>`;
            }).join('');
            document.body.appendChild(dropdown);

            // Remove on click outside
            function removeDropdown(e) {
            if (!dropdown.contains(e.target) && e.target !== anchorEl) {
                dropdown.remove();
                document.removeEventListener('mousedown', removeDropdown);
            }
            }
            document.addEventListener('mousedown', removeDropdown);
        }

        let searchTimeout = null;
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const val = this.value;
            if (!val.trim()) {
            let old = document.getElementById('search-results-dropdown');
            if (old) old.remove();
            return;
            }
            searchTimeout = setTimeout(() => {
            const results = searchAll(val);
            showSearchResults(results, searchInput);
            }, 200);
        });

        // Remove dropdown on blur
        searchInput.addEventListener('blur', function() {
            setTimeout(() => {
            let old = document.getElementById('search-results-dropdown');
            if (old) old.remove();
            }, 200);
        });

        // --- Mobile search overlay ---
        const searchIconMobile = document.getElementById('searchIconMobile');
        let searchOverlay = null;

        function openSearchOverlay() {
            if (!searchOverlay) {
            searchOverlay = document.createElement('div');
            searchOverlay.style.position = 'fixed';
            searchOverlay.style.top = '0';
            searchOverlay.style.left = '0';
            searchOverlay.style.width = '100vw';
            searchOverlay.style.height = '100vh';
            searchOverlay.style.background = 'rgba(44,0,83,0.95)';
            searchOverlay.style.zIndex = 4000;
            searchOverlay.innerHTML = `
                <div style="display:flex;align-items:center;padding:14px 18px 14px 8px;gap:10px;background:#3c0a7b;">
                <button id="searchOverlayBack" style="background:none;border:none;outline:none;cursor:pointer;padding:0 8px 0 0;">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none"><path d="M15 18l-6-6 6-6" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
                <div style="flex:1;display:flex;align-items:center;background:#1d1d1d;border-radius:20px;padding:10px 18px;">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" style="color:#fff;"><circle cx="9" cy="9" r="7" stroke="currentColor" stroke-width="2"/><line x1="14.1213" y1="14.1213" x2="18" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                    <input type="text" placeholder="Search for events, birthdays, tasks and more" style="border:none;outline:none;background:transparent;color:#fff;width:100%;padding-left:10px;font-size:16px;" autofocus>
                </div>
                </div>
                <div id="searchOverlayResults" style="background:#fff;color:#3c0a7b;max-width:600px;margin:18px auto 0 auto;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.18);padding:0;overflow:hidden;"></div>
            `;
            document.body.appendChild(searchOverlay);

            // Focus input after DOM insert
            setTimeout(() => {
                const input = searchOverlay.querySelector('input');
                if (input) input.focus();
            }, 10);

            // Back button closes overlay
            searchOverlay.querySelector('#searchOverlayBack').onclick = closeSearchOverlay;

            // ESC closes overlay
            searchOverlay.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') closeSearchOverlay();
            });

            // Search logic
            const input = searchOverlay.querySelector('input');
            const resultsDiv = searchOverlay.querySelector('#searchOverlayResults');
            let overlayTimeout = null;
            input.addEventListener('input', function() {
                clearTimeout(overlayTimeout);
                const val = this.value;
                if (!val.trim()) {
                resultsDiv.innerHTML = '';
                return;
                }
                overlayTimeout = setTimeout(() => {
                const results = searchAll(val);
                if (!results.length) {
                    resultsDiv.innerHTML = '<div style="padding:18px;text-align:center;color:#aaa;">No results found.</div>';
                } else {
                    resultsDiv.innerHTML = results.map(r => {
                    let dateStr = r.date || r.dueDate || '';
                    let dateDisp = dateStr ? new Date(dateStr).toLocaleDateString() : '';
                    let timeDisp = r.time ? ` ${r.time}` : '';
                    return `<div style="padding:14px 22px;cursor:pointer;border-bottom:1px solid #eee;">
                        <span style="font-weight:bold;">${r.type}:</span> ${r.title || r.name}
                        <span style="color:#8200fc;font-size:13px;margin-left:8px;">${dateDisp}${timeDisp}</span>
                    </div>`;
                    }).join('');
                }
                }, 200);
            });
            }
            searchOverlay.style.display = 'block';
            // Focus input
            const input = searchOverlay.querySelector('input');
            if (input) input.focus();
        }

        function closeSearchOverlay() {
            if (searchOverlay) {
            searchOverlay.style.display = 'none';
            }
        }

        searchIconMobile.addEventListener('click', function(e) {
            e.preventDefault();
            openSearchOverlay();
        });


        document.getElementById('todayBtn').addEventListener('click', function() {
            mainDate = new Date();
            updateCalendarView();
        });





        const helpBtn = document.getElementById('help-btn');
        const helpModal = document.getElementById('helpModal');
        const closeHelpModal = document.getElementById('closeHelpModal');

        helpBtn.addEventListener('click', function() {
            helpModal.style.display = 'block';
        });

        closeHelpModal.addEventListener('click', function() {
            helpModal.style.display = 'none';
        });

        window.addEventListener('click', function(event) {
            if (event.target === helpModal) {
                helpModal.style.display = 'none';
            }
        });


        const moreIcon = document.querySelector('.more-icon');
        let moreMenu = null;

        // Helper to close the menu
        function closeMoreMenu() {
            if (moreMenu) {
            moreMenu.remove();
            moreMenu = null;
            document.removeEventListener('click', handleOutsideClick);
            }
        }

        // Handle outside click to close menu
        function handleOutsideClick(e) {
            if (moreMenu && !moreMenu.contains(e.target) && !moreIcon.contains(e.target)) {
            closeMoreMenu();
            }
        }

        // Build the More menu
        function openMoreMenu() {
            closeMoreMenu();
            moreMenu = document.createElement('div');
            moreMenu.style.position = 'absolute';
            moreMenu.style.top = '60px';
            moreMenu.style.right = '18px';
            moreMenu.style.background = '#3c0a7b';
            moreMenu.style.color = '#fff';
            moreMenu.style.borderRadius = '12px';
            moreMenu.style.boxShadow = '0 2px 8px rgba(0,0,0,0.18)';
            moreMenu.style.zIndex = 3002;
            moreMenu.style.minWidth = '180px';
            moreMenu.style.padding = '8px 0';
            moreMenu.style.fontSize = '16px';

            // Menu items: Today, Create, View, Help, Settings, Events, Apps
            moreMenu.innerHTML = `
            <button style="all:unset;display:flex;align-items:center;width:100%;padding:10px 20px;cursor:pointer;gap:10px;" id="more-today">
                <svg width="20" height="20" fill="none" viewBox="0 0 20 20"><rect x="2" y="4" width="16" height="14" rx="2" fill="#fff" stroke="#8200fc" stroke-width="1.5"/><rect x="2" y="4" width="16" height="3" fill="#e0e0e0"/><rect x="6" y="2" width="1.5" height="4" rx="0.75" fill="#8200fc"/><rect x="12.5" y="2" width="1.5" height="4" rx="0.75" fill="#8200fc"/></svg>
                Today
            </button>
            <button style="all:unset;display:flex;align-items:center;width:100%;padding:10px 20px;cursor:pointer;gap:10px;" id="more-create">
                <svg width="20" height="20" fill="none" viewBox="0 0 20 20"><line x1="10" y1="4" x2="10" y2="16" stroke="#8200fc" stroke-width="2" stroke-linecap="round"/><line x1="4" y1="10" x2="16" y2="10" stroke="#8200fc" stroke-width="2" stroke-linecap="round"/></svg>
                Create
            </button>
            <div style="position:relative;">
                <button style="all:unset;display:flex;align-items:center;width:100%;padding:10px 20px;cursor:pointer;gap:10px;" id="more-view">
                <svg width="20" height="20" fill="none" viewBox="0 0 20 20"><rect x="2" y="4" width="16" height="12" rx="2" stroke="#8200fc" stroke-width="1.5" fill="none"/><circle cx="10" cy="10" r="3" stroke="#8200fc" stroke-width="1.5" fill="none"/></svg>
                View
                <svg width="16" height="16" style="margin-left:auto;" viewBox="0 0 20 20" fill="none"><path d="M6 8l4 4 4-4" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
                <div id="more-view-dropdown" style="display:none;position:absolute;left:0;top:100%;background:#fff;color:#3c0a7b;min-width:140px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.18);z-index:3003;overflow:hidden;">
                <button style="all:unset;display:block;width:100%;padding:10px 18px;cursor:pointer;font-size:15px;" data-view="Month">Month</button>
                <button style="all:unset;display:block;width:100%;padding:10px 18px;cursor:pointer;font-size:15px;" data-view="Week">Week</button>
                <button style="all:unset;display:block;width:100%;padding:10px 18px;cursor:pointer;font-size:15px;" data-view="Year">Year</button>
                <button style="all:unset;display:block;width:100%;padding:10px 18px;cursor:pointer;font-size:15px;" data-view="Day">Day</button>
                <button style="all:unset;display:block;width:100%;padding:10px 18px;cursor:pointer;font-size:15px;" data-view="Agenda">Agenda</button>
                <button style="all:unset;display:block;width:100%;padding:10px 18px;cursor:pointer;font-size:15px;" data-view="Timeline">Timeline</button>
                </div>
            </div>
            <button style="all:unset;display:flex;align-items:center;width:100%;padding:10px 20px;cursor:pointer;gap:10px;" id="more-help">
                <svg width="20" height="20" fill="none" viewBox="0 0 20 20"><circle cx="10" cy="10" r="8" stroke="#8200fc" stroke-width="2" fill="none"/><path d="M10 13v-1c0-1.1 2-1.5 2-3a2 2 0 1 0-4 0" stroke="#8200fc" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/><circle cx="10" cy="15" r="1" fill="#8200fc"/></svg>
                Help
            </button>
            <button style="all:unset;display:flex;align-items:center;width:100%;padding:10px 20px;cursor:pointer;gap:10px;" id="more-settings">
                <svg width="20" height="20" fill="none" viewBox="0 0 20 20"><g stroke="#8200fc" stroke-width="1.5" fill="none"><circle cx="10" cy="10" r="7"/><path d="M10 5v2M10 13v2M5 10h2M13 10h2M7.5 7.5l1 1M11.5 11.5l1 1M7.5 12.5l1-1M11.5 8.5l1-1"/></g></svg>
                Settings
            </button>
            <button style="all:unset;display:flex;align-items:center;width:100%;padding:10px 20px;cursor:pointer;gap:10px;" id="more-events">
                <svg width="20" height="20" fill="none" viewBox="0 0 20 20"><rect x="2" y="4" width="16" height="12" rx="2" stroke="#8200fc" stroke-width="1.5" fill="none"/><rect x="6" y="2" width="1.5" height="4" rx="0.75" fill="#8200fc"/><rect x="12.5" y="2" width="1.5" height="4" rx="0.75" fill="#8200fc"/></svg>
                Events
            </button>
           
            `;

            document.body.appendChild(moreMenu);

            // Position menu below the icon
            const iconRect = moreIcon.getBoundingClientRect();
            moreMenu.style.top = (window.scrollY + iconRect.bottom + 6) + 'px';
            moreMenu.style.right = (window.innerWidth - iconRect.right + 8) + 'px';

            // Add event listeners for menu actions
            moreMenu.querySelector('#more-today').onclick = function() {
            mainDate = new Date();
            updateCalendarView();
            closeMoreMenu();
            };
            moreMenu.querySelector('#more-create').onclick = function() {
            // Simulate click on Create button (if present)
            const createBtn = document.querySelector('.btn.hide-720');
            if (createBtn) createBtn.click();
            closeMoreMenu();
            };

            // View dropdown logic
            const viewBtn = moreMenu.querySelector('#more-view');
            const viewDropdown = moreMenu.querySelector('#more-view-dropdown');
            let viewDropdownOpen = false;

            viewBtn.onclick = function(e) {
            e.stopPropagation();
            viewDropdown.style.display = viewDropdownOpen ? 'none' : 'block';
            viewDropdownOpen = !viewDropdownOpen;
            };

            // Close dropdown if click outside
            viewDropdown.addEventListener('click', function(e) {
            e.stopPropagation();
            });

            // Handle view selection
            viewDropdown.querySelectorAll('button[data-view]').forEach(btn => {
                btn.onclick = function() {
                    const val = btn.getAttribute('data-view');
                    if (['Month', 'Week', 'Year'].includes(val)) {
                        calendarViewSelect.value = val;
                        weekDropdown.value = val;
                        updateCalendarView();
                    } else {
                        // For Day, Agenda, Timeline
                        weekDropdown.value = val;
                        weekDropdown.dispatchEvent(new Event('change'));
                    }
                    closeMoreMenu();
                };
            });

            moreMenu.querySelector('#more-help').onclick = function() {
            helpModal.style.display = 'block';
            closeMoreMenu();
            };
            moreMenu.querySelector('#more-settings').onclick = function() {
            // Simulate click on settings icon
            const settingsBtn = document.getElementById('settings');
            if (settingsBtn) {
                // If you have a modal or settings handler, trigger it here
                settingsBtn.dispatchEvent(new Event('click'));
            }
            closeMoreMenu();
            };
            moreMenu.querySelector('#more-events').onclick = function() {
            // Simulate click on events icon
            const eventsBtn = document.getElementById('events-btn');
            if (eventsBtn) eventsBtn.click();
            closeMoreMenu();
            };
            moreMenu.querySelector('#more-apps').onclick = function() {
            // Simulate click on app icon
            const appBtn = document.getElementById('app-icon');
            if (appBtn) appBtn.click();
            closeMoreMenu();
            };

            setTimeout(() => {
            document.addEventListener('click', handleOutsideClick);
            }, 0);
        }

        moreIcon.addEventListener('click', function(e) {
            e.stopPropagation();
            if (moreMenu) {
            closeMoreMenu();
            } else {
            openMoreMenu();
            }
        });


        
        const sidebar = document.querySelector('.sidebar');

        // Helper to force sidebar display:block !important (for overlays)
        function forceSidebarDisplayBlock() {
            sidebar.style.setProperty('display', 'block', 'important');
        }
        const menuBtn = document.querySelector('.menu-btn');
        const content = document.querySelector('.content');
        let sidebarOpen = true;

        // Overlay for mobile
        let sidebarOverlay = null;

        function showSidebarOverlay() {
            if (!sidebarOverlay) {
            sidebarOverlay = document.createElement('div');
            sidebarOverlay.style.position = 'fixed';
            sidebarOverlay.style.top = 0;
            sidebarOverlay.style.left = 0;
            sidebarOverlay.style.width = '100vw';
            sidebarOverlay.style.height = '100vh';
            sidebarOverlay.style.background = 'rgba(44,0,83,0.65)';
            sidebarOverlay.style.zIndex = 1000;
            sidebarOverlay.onclick = hideSidebarOverlay;
            document.body.appendChild(sidebarOverlay);
            }
            // Show sidebar above overlay
            sidebar.style.setProperty('display', 'block', 'important');
            sidebar.style.position = 'fixed';
            sidebar.style.top = '70px';
            sidebar.style.left = '0';
            sidebar.style.zIndex = 1001;
            sidebarOverlay.style.display = 'block';
            sidebar.classList.add('sidebar-overlay');
            content.style.marginLeft = '0';
        }

        function hideSidebarOverlay() {
            if (sidebarOverlay) {
            sidebarOverlay.style.display = 'none';
            }
            sidebar.style.display = '';
            sidebar.style.position = '';
            sidebar.style.top = '';
            sidebar.style.left = '';
            sidebar.style.zIndex = '';
            sidebar.classList.remove('sidebar-overlay');
            content.style.marginLeft = '0';
        }

        function toggleSidebar() {
            // Mobile: show overlay
            if (window.innerWidth <= 890) {
                if (!sidebarOverlay || sidebarOverlay.style.display === 'none') {
                    showSidebarOverlay();
                } else {
                    hideSidebarOverlay();
                }
            } else {
                // Desktop: collapse sidebar
                sidebarOpen = !sidebarOpen;
                // Always show sidebar if toggling from hidden state
                if (sidebarOpen) {
                    sidebar.style.display = 'block';
                } else {
                    sidebar.style.display = 'none';
                }
                sidebar.style.position = '';
                sidebar.style.top = '';
                sidebar.style.left = '';
                sidebar.style.zIndex = '';
                sidebar.classList.remove('sidebar-overlay');
                content.style.marginLeft = sidebarOpen ? '290px' : '0';
            }
        }

        menuBtn.addEventListener('click', toggleSidebar);

        // Hide sidebar overlay on resize if needed
        window.addEventListener('resize', () => {
            if (window.innerWidth > 890) {
            if (sidebarOverlay) hideSidebarOverlay();
            sidebar.style.display = 'block';
            sidebar.style.position = '';
            sidebar.style.top = '';
            sidebar.style.left = '';
            sidebar.style.zIndex = '';
            sidebar.classList.remove('sidebar-overlay');
            sidebarOpen = true;
            content.style.marginLeft = '290px';
            } else {
            sidebar.style.display = '';
            sidebar.style.position = '';
            sidebar.style.top = '';
            sidebar.style.left = '';
            sidebar.style.zIndex = '';
            sidebar.classList.remove('sidebar-overlay');
            content.style.marginLeft = '0';
            }
        });


        // Holidays can be fixed (every year) or specific to a year
        // Helper to calculate Easter Sunday for a given year (Western, Gregorian)
        function getEasterDate(year) {
            // Meeus/Jones/Butcher algorithm
            const f = Math.floor,
            G = year % 19,
            C = f(year / 100),
            H = (C - f(C / 4) - f((8 * C + 13) / 25) + 19 * G + 15) % 30,
            I = H - f(H / 28) * (1 - f(29 / (H + 1)) * f((21 - G) / 11)),
            J = (year + f(year / 4) + I + 2 - C + f(C / 4)) % 7,
            L = I - J,
            month = 3 + f((L + 40) / 44),
            day = L + 28 - 31 * f(month / 4);
            return new Date(year, month - 1, day);
        }

        // Returns array of holiday objects for a given year (fixed + movable)
        // --- Helper functions for Jewish holidays (approximate, Gregorian) ---
        function getRoshHashanah(year) {
            // Approximate: Rosh Hashanah falls in Sep/Oct, use known dates for 2023-2030
            const dates = {
            2023: "2023-09-16",
            2024: "2024-10-03",
            2025: "2025-09-23",
            2026: "2026-09-13",
            2027: "2027-10-02",
            2028: "2028-09-21",
            2029: "2029-09-10",
            2030: "2030-09-28"
            };
            return dates[year] || `${year}-09-15`;
        }
        function getYomKippur(year) {
            // Approximate: Yom Kippur is 10 days after Rosh Hashanah
            const rh = new Date(getRoshHashanah(year));
            rh.setDate(rh.getDate() + 9);
            return rh.toISOString().slice(0, 10);
        }

        





        function getHanukkahStart(year) {
            // Approximate: Hanukkah starts in late Nov/Dec, use known dates for 2023-2030
            const dates = {
            2023: "2023-12-07",
            2024: "2024-12-25",
            2025: "2025-12-14",
            2026: "2026-12-04",
            2027: "2027-12-24",
            2028: "2028-12-12",
            2029: "2029-12-02",
            2030: "2030-12-20"
            };
            return dates[year] || `${year}-12-10`;
        }
        function getHanukkahEnd(year) {
            // Hanukkah lasts 8 days
            const start = new Date(getHanukkahStart(year));
            start.setDate(start.getDate() + 7);
            return start.toISOString().slice(0, 10);
        }

        function getAllHolidays(year) {
            const easter = getEasterDate(year);
            // Helper for offset days from Easter
            function offsetEaster(days, name) {
            const d = new Date(easter);
            d.setDate(easter.getDate() + days + 1);
            return { date: d.toISOString().slice(0, 10), name };
            }
            // Helper to add +1 to a date string (yyyy-mm-dd)
            function plusOne(dateStr) {
            const d = new Date(dateStr);
            d.setDate(d.getDate() + 1);
            return d.toISOString().slice(0, 10);
            }
            return [
            { date: plusOne(`${year}-01-01`), name: "New Year's Day" },
            { date: plusOne(getNthWeekdayOfMonth(year, 1, 1, 3)), name: "Martin Luther King Jr. Day" }, // 3rd Monday Jan
            { date: plusOne(`${year}-02-14`), name: "Valentine's Day" },
            { date: plusOne(getNthWeekdayOfMonth(year, 3, 0, 2)), name: "Daylight Saving Time Begins" }, // 2nd Sunday March
            { date: plusOne(getNthWeekdayOfMonth(year, 2, 1, 3)), name: "Presidents' Day" }, // 3rd Monday Feb
            { date: plusOne(`${year}-03-17`), name: "St. Patrick's Day" },
            { date: plusOne(`${year}-04-01`), name: "April Fool's Day" },
            { date: plusOne(easter.toISOString().slice(0, 10)), name: "Easter Sunday" },
            offsetEaster(-2, "Good Friday"),
            offsetEaster(1, "Easter Monday"),
            { date: plusOne(`${year}-05-05`), name: "Cinco de Mayo" },
            { date: plusOne(getNthWeekdayOfMonth(year, 5, 0, 2)), name: "Mother's Day" }, // 2nd Sunday May
            { date: plusOne(getLastWeekdayOfMonth(year, 5, 1)), name: "Memorial Day" }, // Last Monday May
            { date: plusOne(`${year}-06-19`), name: "Juneteenth" },
            { date: plusOne(getNthWeekdayOfMonth(year, 6, 0, 3)), name: "Father's Day" }, // 3rd Sunday June
            { date: plusOne(`${year}-07-04`), name: "Independence Day" },
            { date: plusOne(getNthWeekdayOfMonth(year, 9, 1, 1)), name: "Labor Day" }, // 1st Monday Sep
            { date: plusOne(getNthWeekdayOfMonth(year, 10, 1, 2)), name: "Columbus Day" }, // 2nd Monday Oct
            { date: plusOne(`${year}-10-31`), name: "Halloween" },
            { date: plusOne(getNthWeekdayOfMonth(year, 11, 4, 4)), name: "Thanksgiving" }, // 4th Thursday Nov
            { date: plusOne(`${year}-12-24`), name: "Christmas Eve" },
            { date: plusOne(`${year}-12-25`), name: "Christmas Day" },
            { date: plusOne(getNthWeekdayOfMonth(year, 11, 0, 1)), name: "Daylight Saving Time Ends" }, // 1st Sunday Nov
            { date: plusOne(`${year}-12-31`), name: "New Year's Eve" },
            { date: plusOne(getRoshHashanah(year)), name: "Rosh Hashanah" },
            { date: plusOne(getYomKippur(year)), name: "Yom Kippur" },
            { date: plusOne(getHanukkahStart(year)), name: "Hanukkah Begins" },
            { date: plusOne(getHanukkahEnd(year)), name: "Hanukkah Ends" },
            { date: plusOne(`${year}-12-26`), name: "Kwanzaa Begins" },
            { date: plusOne(`${year}-01-01`), name: "Kwanzaa Ends" }
            ];
        }

        // Helper: get Nth weekday of month (e.g. 3rd Monday in January)
        // weekday: 0=Sunday, 1=Monday, ..., 6=Saturday
        function getNthWeekdayOfMonth(year, month, weekday, n) {
            // month: 1-based (Jan=1)
            let count = 0;
            for (let day = 1; day <= 31; day++) {
                let date = new Date(year, month - 1, day);
                if (date.getMonth() !== month - 1) break;
                if (date.getDay() === weekday) {
                    count++;
                    if (count === n) {
                        return date.toISOString().slice(0, 10);
                    }
                }
            }
            return null;
        }

        // Helper: get last weekday of month (e.g. last Monday in May)
        function getLastWeekdayOfMonth(year, month, weekday) {
            // month: 1-based (Jan=1)
            for (let day = 31; day >= 1; day--) {
                let date = new Date(year, month - 1, day);
                if (date.getMonth() !== month - 1) continue;
                if (date.getDay() === weekday) {
                    return date.toISOString().slice(0, 10);
                }
            }
            return null;
        }

        // For compatibility with existing code, build a flat array for the current year
        const holidays = getAllHolidays(new Date().getFullYear());

        function getHolidaysForMonth(year, month) {
            return holidays.filter(h => {
            if (/^\d{4}-\d{2}-\d{2}$/.test(h.date)) {
                const d = new Date(h.date);
                return d.getFullYear() === year && d.getMonth() === month;
            } else if (/^\d{2}-\d{2}$/.test(h.date)) {
                const [mm, dd] = h.date.split('-').map(Number);
                return (mm - 1) === month;
            }
            return false;
            });
        }

        let mainDate = new Date();
        const mainMonth = document.getElementById('main-calendar-month');
        const mainBody = document.getElementById('main-calendar-body');
        const holidayUl = document.getElementById('holiday-ul');
        const calendarViewSelect = document.getElementById('calendarViewSelect');
        const calendarViewArea = document.getElementById('calendar-view-area');

        function renderMainCalendar(date) {
            const year = date.getFullYear();
            const month = date.getMonth();
            mainMonth.textContent = date.toLocaleString(undefined, { month: 'long', year: 'numeric' });

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const monthHolidays = getHolidaysForMonth(year, month);

            let html = '';
            let day = 1;
            for (let i = 0; i < 6; i++) {
                html += '<tr>';
                for (let j = 0; j < 7; j++) {
                    if ((i === 0 && j < firstDay) || day > daysInMonth) {
                        html += '<td style="padding:8px 0;"></td>';
                    } else {
                        const isToday =
                            day === (new Date()).getDate() &&
                            month === (new Date()).getMonth() &&
                            year === (new Date()).getFullYear();

                        let holiday = monthHolidays.find(h => {
                            if (/^\d{4}-\d{2}-\d{2}$/.test(h.date)) {
                                const d = new Date(h.date);
                                return d.getDate() === day;
                            } else if (/^\d{2}-\d{2}$/.test(h.date)) {
                                const [mm, dd] = h.date.split('-').map(Number);
                                return dd === day;
                            }
                            return false;
                        });

                        html += `<td style="padding:8px 0; text-align:center; vertical-align:top;">
                            <div style="display:flex; flex-direction:column; align-items:center;">
                                <span style="
                                    display:inline-block;
                                    width:36px;
                                    height:36px;
                                    line-height:36px;
                                    border-radius:8px;
                                    background:${isToday ? '#8200fc' : (holiday ? '#ffb347' : 'none')};
                                    color:${isToday ? '#fff' : (holiday ? '#fff' : (document.body.classList.contains('dark-mode') ? '#fff' : '#3c0a7b'))};
                                    font-weight:${isToday || holiday ? 'bold' : 'normal'};
                                    font-size:16px;
                                    cursor:pointer;
                                    transition:background 0.2s;
                                    border:${holiday ? '2px solid #ff9800' : 'none'};
                                    box-shadow:${isToday ? '0 0 0 2px #fff, 0 0 8px #8200fc55' : ''};
                                " title="${holiday ? holiday.name : ''}">
                                    ${day}${holiday ? ' 🎉' : ''}
                                </span>
                                ${holiday ? `<span style="font-size:11px; color:#ffb347; font-weight:bold; margin-top:2px;">${holiday.name}</span>` : ''}
                            </div>
                        </td>`;
                        day++;
                    }
                }
                html += '</tr>';
                if (day > daysInMonth) break;
            }
            mainBody.innerHTML = html;

            // Render holiday list
            holidayUl.innerHTML = '';
            if (monthHolidays.length === 0) {
                holidayUl.innerHTML = '<li style="color:#aaa;">No holidays this month.</li>';
            } else {
                monthHolidays.forEach(h => {
                    let d;
                    if (/^\d{4}-\d{2}-\d{2}$/.test(h.date)) {
                        d = new Date(h.date);
                    } else if (/^\d{2}-\d{2}$/.test(h.date)) {
                        d = new Date(year + '-' + h.date);
                    }
                    holidayUl.innerHTML += `<li><strong>${d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' })}:</strong> ${h.name}</li>`;
                });
            }
        }

        function renderWeekView(date) {
            // Find the Sunday of the current week
            const weekStart = new Date(date);
            weekStart.setDate(date.getDate() - date.getDay());
            let html = '<table style="width:100%; border-collapse:collapse; color:#333;"><thead><tr>';
            const days = ['Su','Mo','Tu','We','Th','Fr','Sa'];
            for (let d = 0; d < 7; d++) {
                html += `<th>${days[d]}</th>`;
            }
            html += '</tr></thead><tbody><tr>';
            for (let d = 0; d < 7; d++) {
                const dayDate = new Date(weekStart);
                dayDate.setDate(weekStart.getDate() + d);
                const isToday =
                    dayDate.getDate() === (new Date()).getDate() &&
                    dayDate.getMonth() === (new Date()).getMonth() &&
                    dayDate.getFullYear() === (new Date()).getFullYear();

                // Check if this day is a holiday
                let holiday = holidays.find(h => {
                    if (/^\d{4}-\d{2}-\d{2}$/.test(h.date)) {
                        const hd = new Date(h.date);
                        return hd.getFullYear() === dayDate.getFullYear() && hd.getMonth() === dayDate.getMonth() && hd.getDate() === dayDate.getDate();
                    } else if (/^\d{2}-\d{2}$/.test(h.date)) {
                        const [mm, dd] = h.date.split('-').map(Number);
                        return (mm - 1) === dayDate.getMonth() && dd === dayDate.getDate();
                    }
                    return false;
                });

                html += `<td style="padding:16px 0; text-align:center;">
                    <span style="
                        display:inline-block;
                        width:48px;
                        height:48px;
                        line-height:48px;
                        border-radius:8px;
                        background:${isToday ? '#8200fc' : (holiday ? '#ffb347' : 'none')};
                        color:${isToday ? '#fff' : (holiday ? '#fff' : (document.body.classList.contains('dark-mode') ? '#fff' : '#3c0a7b'))};
                        font-weight:${isToday || holiday ? 'bold' : 'normal'};
                        font-size:20px;
                        border:${holiday ? '2px solid #ff9800' : 'none'};
                        box-shadow:${isToday ? '0 0 0 2px #fff, 0 0 8px #8200fc55' : ''};
                    " title="${holiday ? holiday.name : ''}">
                        ${dayDate.getDate()}${holiday ? ' 🎉' : ''}
                    </span>
                </td>`;
            }
            html += '</tr></tbody></table>';
            calendarViewArea.innerHTML = html;
        }

        function renderYearView(date) {
            const year = date.getFullYear();
            let html = '<div style="display:flex; flex-wrap:wrap; gap:18px; justify-content:center;">';
            for (let m = 0; m < 12; m++) {
                const monthDate = new Date(year, m, 1);
                const daysInMonth = new Date(year, m + 1, 0).getDate();
                const monthHolidays = getHolidaysForMonth(year, m);
                html += `<div style="background:${document.body.classList.contains('dark-mode') ? '#3c0a7b' : '#f7f7fa'}; border-radius:10px; padding:10px 8px; min-width:170px;">
                    <div style="text-align:center; font-weight:bold; margin-bottom:4px; color:#8200fc;">${monthDate.toLocaleString(undefined, { month: 'short' })}</div>
                    <table style="width:100%; border-collapse:collapse; font-size:12px;">
                        <thead>
                            <tr>
                                <th>Su</th><th>Mo</th><th>Tu</th><th>We</th><th>Th</th><th>Fr</th><th>Sa</th>
                            </tr>
                        </thead>
                        <tbody>`;
                let day = 1;
                const firstDay = new Date(year, m, 1).getDay();
                for (let i = 0; i < 6; i++) {
                    html += '<tr>';
                    for (let j = 0; j < 7; j++) {
                        if ((i === 0 && j < firstDay) || day > daysInMonth) {
                            html += '<td></td>';
                        } else {
                            // Check if this day is a holiday
                            let holiday = monthHolidays.find(h => {
                                if (/^\d{4}-\d{2}-\d{2}$/.test(h.date)) {
                                    const d = new Date(h.date);
                                    return d.getDate() === day;
                                } else if (/^\d{2}-\d{2}$/.test(h.date)) {
                                    const [mm, dd] = h.date.split('-').map(Number);
                                    return dd === day;
                                }
                                return false;
                            });
                            html += `<td style="padding:2px 0;">
                                <span style="
                                    display:inline-block;
                                    width:20px;
                                    height:20px;
                                    line-height:20px;
                                    border-radius:5px;
                                    background:${holiday ? '#ffb347' : 'none'};
                                    color:${holiday ? '#fff' : (document.body.classList.contains('dark-mode') ? '#fff' : '#3c0a7b')};
                                    font-weight:${holiday ? 'bold' : 'normal'};
                                    border:${holiday ? '2px solid #ff9800' : 'none'};
                                    font-size:12px;
                                " title="${holiday ? holiday.name : ''}">
                                    ${day}${holiday ? '🎉' : ''}
                                </span>
                            </td>`;
                            day++;
                        }
                    }
                    html += '</tr>';
                    if (day > daysInMonth) break;
                }
                html += '</tbody></table></div>';
            }
            html += '</div>';
            calendarViewArea.innerHTML = html;
        }

        function updateCalendarView() {
            const view = calendarViewSelect.value;
            if (view === 'Month') {
                // Render the full month calendar grid and holidays list
                renderMainCalendar(mainDate);
                document.getElementById('holiday-list').style.display = '';
                mainMonth.textContent = mainDate.toLocaleString(undefined, { month: 'long', year: 'numeric' });
                // Ensure the main calendar table is visible
                document.getElementById('main-calendar-table').style.display = '';
                // Optionally hide other views if present
                calendarViewArea.innerHTML = '';
            } else if (view === 'Week') {
                renderWeekView(mainDate);
                document.getElementById('holiday-list').style.display = 'none';
                mainMonth.textContent = mainDate.toLocaleString(undefined, { month: 'long', year: 'numeric' });
            } else if (view === 'Year') {
                renderYearView(mainDate);
                document.getElementById('holiday-list').style.display = 'none';
                mainMonth.textContent = mainDate.getFullYear();
            }
        }
        // Navigation
        document.getElementById('mainPrev').onclick = function() {
            const view = calendarViewSelect.value;
            if (view === 'Month') {
                mainDate.setMonth(mainDate.getMonth() - 1);
            } else if (view === 'Week') {
                mainDate.setDate(mainDate.getDate() - 7);
            } else if (view === 'Year') {
                mainDate.setFullYear(mainDate.getFullYear() - 1);
            }
            updateCalendarView();
        };
        document.getElementById('mainNext').onclick = function() {
            const view = calendarViewSelect.value;
            if (view === 'Month') {
                mainDate.setMonth(mainDate.getMonth() + 1);
            } else if (view === 'Week') {
                mainDate.setDate(mainDate.getDate() + 7);
            } else if (view === 'Year') {
                mainDate.setFullYear(mainDate.getFullYear() + 1);
            }
            updateCalendarView();
        };

        // Topbar arrow integration
        document.querySelector('.arrow-left-right svg:first-child').onclick = function() {
            document.getElementById('mainPrev').click();
        };
        document.querySelector('.arrow-left-right svg:last-child').onclick = function() {
            document.getElementById('mainNext').click();
        };

        // Calendar view select
        calendarViewSelect.onchange = function() {
            // Always force to Month view if Month is selected
            if (calendarViewSelect.value === 'Month') {
                weekDropdown.value = 'Month';
            }
            updateCalendarView();
        };

        // Also sync topbar dropdown to Month if Month view is selected elsewhere
        weekDropdown.addEventListener('change', function() {
            if (weekDropdown.value === 'Month') {
                calendarViewSelect.value = 'Month';
                updateCalendarView();
            }
        });

        // Initial render
        updateCalendarView();

        // Re-render calendar on dark mode toggle if you add a toggle in future
        // Example:
        // document.getElementById('darkModeToggle').onclick = function() {
        //     document.body.classList.toggle('dark-mode');
        //     updateCalendarView();
        // };
  

         // JavaScript to inject today's date into the calendar
         const today = new Date();
         const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
         // Mini Calendar JS
            const calendarMonth = document.getElementById('calendar-month');
            const calendarBody = document.getElementById('calendar-body');
            let miniDate = new Date();

            function renderMiniCalendar(date) {
                const year = date.getFullYear();
                const month = date.getMonth();
                calendarMonth.textContent = date.toLocaleString(undefined, { month: 'long', year: 'numeric' });

                // First day of month
                const firstDay = new Date(year, month, 1).getDay();
                // Days in month
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                let html = '';
                let day = 1;
                for (let i = 0; i < 6; i++) {
                    html += '<tr>';
                    for (let j = 0; j < 7; j++) {
                        if ((i === 0 && j < firstDay) || day > daysInMonth) {
                            html += '<td style="padding:4px 0;"></td>';
                        } else {
                            const isToday =
                                day === (new Date()).getDate() &&
                                month === (new Date()).getMonth() &&
                                year === (new Date()).getFullYear();
                            html += `<td style="padding:4px 0;">
                                <span style="
                                    display:inline-block;
                                    width:28px;
                                    height:28px;
                                    line-height:28px;
                                    border-radius:50%;
                                    background:${isToday ? '#8200fc' : 'none'};
                                    color:${isToday ? '#fff' : '#fff'};
                                    font-weight:${isToday ? 'bold' : 'normal'};
                                ">${day}</span>
                            </td>`;
                            day++;
                        }
                    }
                    html += '</tr>';
                    if (day > daysInMonth) break;
                }
                calendarBody.innerHTML = html;
            }

            document.getElementById('prevMonth').onclick = function() {
                miniDate.setMonth(miniDate.getMonth() - 1);
                renderMiniCalendar(miniDate);
            };
            document.getElementById('nextMonth').onclick = function() {
                miniDate.setMonth(miniDate.getMonth() + 1);
                renderMiniCalendar(miniDate);
            };

            renderMiniCalendar(miniDate); 
            document.getElementById('todayCalendar').innerText = today.toLocaleDateString(undefined, options);
     </script>
     <script src="bannedcountrys.js"></script>

</body>
</html>
