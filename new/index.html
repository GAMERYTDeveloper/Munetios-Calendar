<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Munetios Calendar Beta v1</title>
    <link rel="icon" type="image/x-icon" href="logo.png">
    <link rel="apple-touch-icon" sizes="180x180" href="logo.png">
    <link rel="icon" type="image/png" sizes="32x32" href="logo.png">
    <link rel="icon" type="image/png" sizes="16x16" href="logo.png">
    <meta name="description" content="Munetios Calendar is a modern, user-friendly calendar application designed to help you manage your schedule with ease.">
    <meta name="keywords" content="calendar, events, schedule, productivity, Munetios, GAMERYTDeveloper, Better Calendar, modern calendar, event management">
    <meta name="author" content="GAMERYTDeveloper">
    <meta name="theme-color" content="#270e33">
     <link rel="manifest" href="./new/manifest.webmanifest">
 <script>
  // Register service worker
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js').then((reg) => {
        console.log('✅ Service Worker registered:', reg);
      }).catch((err) => console.error('❌ SW registration failed:', err));
    });
  }
</script>

    <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap');
        * {
                font-family: Poppins, Arial, sans-serif !important; 
        }
        html {
            scroll-behavior: smooth;
            /* Optional: subtle fade for anchor jumps */
            transition: scroll 0.4s cubic-bezier(0.4,0,0.2,1);
        }
        /* Optional: highlight target after scroll */
        :target {
            animation: targetHighlight 1.2s cubic-bezier(0.4,0,0.2,1);
        }
        @keyframes targetHighlight {
            0% {
            box-shadow: 0 0 0 0px #a770ef;
            background: rgba(167,112,239,0.12);
            }
            60% {
            box-shadow: 0 0 0 12px #a770ef44;
            background: rgba(167,112,239,0.18);
            }
            100% {
            box-shadow: 0 0 0 0px #a770ef00;
            background: none;
            }
        }
        /* Make toolbar stick below topbar when scrolling */
        .toolbar {
            position: sticky;
            top: 70px; /* Height of topbar */
            z-index: 1000;
        }
        body {
            margin: 0;
            padding: 0;
        
            background: linear-gradient(120deg, #270e33 0%, #4800a7 100%);
            background-size: 200% 200%;
            animation: bgMove 12s ease-in-out infinite;
            color: #e0e0e0;
        }
        @keyframes bgMove {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .liquid-glass {
            background: linear-gradient(135deg, rgba(255,255,255,0.22) 0%, rgba(200,200,255,0.13) 100%);
            backdrop-filter: blur(6px) saturate(250%);
            -webkit-backdrop-filter: blur(6px) saturate(250%);
            border-radius: 50px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.25), 0 1.5px 8px 0 rgba(255,255,255,0.12) inset;
            border: 1.5px solid rgba(255, 255, 255, 0.28);
        }
        .topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 32px;
            background: linear-gradient(135deg, rgba(255,255,255,0.22) 0%, rgba(200,200,255,0.13) 100%);
            color: #ffffff;
            top: 0;
            position: sticky;
            position: -webkit-sticky;
            z-index: 1100;
            backdrop-filter: blur(3px) saturate(220%);
            -webkit-backdrop-filter: blur(3px) saturate(220%);
            border-radius: 50px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.25), 0 1.5px 8px 0 rgba(255,255,255,0.12) inset;
            border: 1.5px solid rgba(255, 255, 255, 0.28);
        }
        .top-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .top-right {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-shrink: 0;
        }
        .menu-btn {
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50px;
            transition: background-color 0.3s;
        }
        .menu-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .logo-text {
            font-size: 1.5em;
            font-weight: bold;
            white-space: nowrap;
        }
        .btn {
            background: linear-gradient(135deg, rgba(255,255,255,0.55) 0%, rgba(255,255,255,0.32) 100%);
            color: #fff;
            padding: 15px 25px;
            border: 1.5px solid rgba(255, 255, 255, 0.45);
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1em;
            cursor: pointer;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.18), 0 1.5px 8px 0 rgba(255,255,255,0.18) inset;
            backdrop-filter: blur(6px) saturate(250%);
            -webkit-backdrop-filter: blur(6px) saturate(250%);
            transition: background 0.3s, color 0.3s;
        }
        .btn:hover {
            background: linear-gradient(135deg, #a770ef 0%, #37066e 100%);
            color: #fff;
            box-shadow: 0 4px 24px 0 rgba(167, 112, 239, 0.25), 0 1.5px 8px 0 rgba(255,255,255,0.18) inset;
            border-color: #a770ef;
            transform: translateY(-2px) scale(1.04);
        }
        .menu-btn, .btn, .logo-text {
            transition: 
                background 0.3s cubic-bezier(0.4,0,0.2,1),
                color 0.3s cubic-bezier(0.4,0,0.2,1),
                box-shadow 0.3s cubic-bezier(0.4,0,0.2,1),
                transform 0.3s cubic-bezier(0.4,0,0.2,1);
        }

        .menu-btn:active {
            transform: scale(0.92) rotate(-4deg);
        }

        .btn:active {
            transform: scale(0.96) rotate(2deg);
        }

        .logo-text {
            animation: fadeInLogo 1.2s cubic-bezier(0.4,0,0.2,1) 0.2s both;
        }

        @keyframes fadeInLogo {
            0% {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .topbar {
            animation: glassSlideDown 1s cubic-bezier(0.4,0,0.2,1) 0.1s both;
        }

        @keyframes glassSlideDown {
            0% {
                opacity: 0;
                transform: translateY(-40px) scale(0.98);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .btn {
            position: relative;
            overflow: hidden;
        }

        .btn::after {
            content: "";
            position: absolute;
            left: -60%;
            top: 0;
            width: 220%;
            height: 100%;
            background: linear-gradient(120deg, rgba(255,255,255,0.18) 0%, rgba(255,255,255,0.05) 100%);
            transform: skewX(-24deg);
            transition: left 0.6s cubic-bezier(0.4,0,0.2,1);
            pointer-events: none;
        }

        .btn:hover::after {
            left: 100%;
        }
        svg {
            cursor: pointer;
        }
        #createBtn svg {
            width: 24px !important;
            height: 24px !important;
            max-width: 24px !important;
            max-height: 24px !important;
            min-width: 24px !important;
            min-height: 24px !important;
        }
        .menu-btn svg {
            transition: transform 0.4s cubic-bezier(0.4,0,0.2,1);
        }

        .menu-btn:hover svg {
            transform: rotate(12deg) scale(1.08);
        }
        .search-bar {
            display: flex;
            align-items: center;
            padding: 15px 25px;
            max-width: 670px;
            width: 100%;
            margin-left: 20px;
            margin-right: 60px;
        }
        .search-bar input {
            flex: 1;
            border: none;
            outline: none;
            background: transparent;
            color: #fff;
            font-size: 1em;
            width: 100%;
        }
        .skip-link {
              position: absolute;   /* remove from flow */
  left: 10px;
  top: -1000px;
}
.skip-link:focus {
  top: 0; /* slide down when focused */
}
.btn:disabled, .btn[disabled] {
    background: rgba(200, 200, 200, 0.3) !important;
    color: #aaa !important;
    cursor: not-allowed !important;
    box-shadow: none !important;
    border-color: rgba(200, 200, 200, 0.3) !important;
    transform: none !important;
    pointer-events: none !important;
    opacity: 0.6 !important;
}

.toolbar {
    display: flex;
    padding: 10px 20px;
    gap: 10px;
    flex-wrap: wrap;
    top: 70px; /* Height of topbar */
    z-index: 1000;
    background: linear-gradient(135deg, rgba(255,255,255,0.22) 0%, rgba(200,200,255,0.13) 100%);
    backdrop-filter: blur(6px) saturate(250%);
    -webkit-backdrop-filter: blur(6px) saturate(250%);
    border-radius: 50px;
    box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.18), 0 1.5px 8px 0 rgba(255,255,255,0.12) inset;
    border: 1.5px solid rgba(255, 255, 255, 0.28);
}

.toolbar .btn {
    padding: 5px 10px;
    gap: 15px;
    flex-wrap: wrap;
}
.toolbar .top-right {
    gap: 10px;
    flex-shrink: 0;
    align-items: center;
    display: flex;
    justify-content: flex-end;
    margin-left: auto;
    flex-wrap: wrap;
   
}
.toolbar .top-left {
    gap: 10px;
    align-items: center;
    display: flex;
    justify-content: flex-start;
}
.toolbar .btn:hover {
    background: rgba(255,255,255,0.13);
}
.search-bar input::placeholder {
    color: #ddd;
}
#searchIconMobile {
    display: none;
    cursor: pointer;
    padding: 8px;
    border-radius: 50px;
    transition: background-color 0.3s;
    background: transparent;
}
#searchIconMobile:hover {
    background-color: rgba(255, 255, 255, 0.1);
}

.calendar-content {
    padding: 20px;
    background: #3f0063;
    border-radius: 20px;
    box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.18), 0 1.5px 8px 0 rgba(255,255,255,0.12) inset;
    backdrop-filter: blur(6px) saturate(250%);
    -webkit-backdrop-filter: blur(6px) saturate(250%);
    border: 1.5px solid rgba(255, 255, 255, 0.28);
    margin: 20px;
    height: calc(80vh - 200px);
    overflow-y: auto;
}

/* Modal styles */
.modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100vw;
    height: 100vh;
    overflow: auto;
    background: rgba(39, 14, 51, 0.65);
    backdrop-filter: blur(2px);
    -webkit-backdrop-filter: blur(2px);
    justify-content: center;
    align-items: center;
}

.modal-content {
    margin: 60px auto;
    padding: 32px 28px 24px 28px;
    border-radius: 32px;
    max-width: 720px;
    width: 100%;
    background: linear-gradient(135deg, rgba(255,255,255,0.22) 0%, rgba(200,200,255,0.13) 100%);
    box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.25), 0 1.5px 8px 0 rgba(255,255,255,0.12) inset;
    border: 1.5px solid rgba(255, 255, 255, 0.28);
    color: #fff;
    position: relative;
    animation: glassSlideDown 0.7s cubic-bezier(0.4,0,0.2,1);
}

.modal-content h2 {
    margin-top: 0;
    margin-bottom: 18px;
    font-size: 1.5em;
    font-weight: bold;
    color: #a770ef;
    text-align: center;
}
/* Custom Scrollbar Styles */
::-webkit-scrollbar {
    width: 12px;
    background: rgba(39, 14, 51, 0.12);
    border-radius: 8px;
}
::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #a770ef 0%, #37066e 100%);
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(167,112,239,0.18);
}
::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #a770ef 0%, #270e33 100%);
}
::-webkit-scrollbar-track {
    background: rgba(39, 14, 51, 0.08);
    border-radius: 8px;
}
html {
    scrollbar-width: thin;
    scrollbar-color: #a770ef #270e33;
}
.close {
    position: absolute;
    top: 18px;
    right: 24px;
    font-size: 2em;
    color: #fff;
    cursor: pointer;
    transition: color 0.2s;
    font-weight: bold;
    z-index: 2;
}

.close:hover {
    color: #a770ef;
}

#eventForm label {
    display: block;
    margin-bottom: 6px;
    font-weight: bold;
    color: #e0e0e0;
    margin-top: 18px;
}
.create-wrapper {
    position: absolute;
    top: 60px;
    right: 40px;
    min-width: 180px;
    background: linear-gradient(135deg, rgba(255,255,255,0.22) 0%, rgba(167,112,239,0.13) 100%);
    border-radius: 24px;
    box-shadow: 0 8px 32px 0 rgba(167,112,239,0.18), 0 1.5px 8px 0 rgba(255,255,255,0.12) inset;
    border: 1.5px solid rgba(167,112,239,0.28);
    display: none;
    flex-direction: column;
    align-items: stretch;
    z-index: 1200;
    padding: 12px 10px;
    animation: glassSlideDown 0.4s cubic-bezier(0.4,0,0.2,1);
}

.create-wrapper.active {
    display: flex;
}

.create-wrapper .item {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.create-wrapper .btn {
    background: linear-gradient(135deg, rgba(255,255,255,0.18) 0%, rgba(167,112,239,0.09) 100%);
    border-radius: 18px;
    box-shadow: 0 2px 8px rgba(167,112,239,0.08);
    padding: 8px 16px;
    font-size: 0.98em;
    color: #fff;
    border: 1.5px solid rgba(167,112,239,0.18);
    transition: background 0.3s, color 0.3s, box-shadow 0.3s;
    width: 100%;
    justify-content: flex-start;
}

.create-wrapper .btn:hover {
    background: linear-gradient(135deg, #a770ef 0%, #37066e 100%);
    color: #fff;
    box-shadow: 0 4px 16px rgba(167,112,239,0.18);
    border-color: #a770ef;
    transform: translateY(-2px) scale(1.04);
}

.create-wrapper .toolbar-label {
    font-size: 0.95em;
    color: #a770ef;
    font-weight: bold;
    margin-left: 6px;
    transition: color 0.3s;
}
#eventForm input[type="text"],
#eventForm input[type="date"],
#eventForm input[type="time"],
#eventForm textarea {
    width: 100%;
    padding: 10px 14px;
    margin-bottom: 8px;
    border-radius: 16px;
    border: 1.5px solid #a770ef44;
    background: rgba(255,255,255,0.09);
    color: #fff;
    font-size: 1em;
    font-family: inherit;
    box-shadow: 0 2px 8px rgba(31,38,135,0.08);
    outline: none;
    transition: border-color 0.2s, background 0.2s;
    resize: none;
}
#holidayForm input[type="text"],
#holidayForm input[type="date"],
#holidayForm select,
#holidayForm textarea,
#birthdayForm input[type="text"],
#birthdayForm input[type="date"],
#birthdayForm textarea {
    width: 100%;
    padding: 10px 14px;
    margin-bottom: 8px;
    border-radius: 16px;
    border: 1.5px solid #a770ef44;
    background: rgba(255,255,255,0.09);
    color: #fff;
    font-size: 1em;
    font-family: inherit;
    box-shadow: 0 2px 8px rgba(31,38,135,0.08);
    outline: none;
    transition: border-color 0.2s, background 0.2s;
    resize: none;
}

#holidayForm input[type="text"]:focus,
#holidayForm input[type="date"]:focus,
#holidayForm select:focus,
#holidayForm textarea:focus,
#birthdayForm input[type="text"]:focus,
#birthdayForm input[type="date"]:focus,
#birthdayForm textarea:focus {
    border-color: #a770ef;
    background: rgba(167,112,239,0.09);
}

#holidayForm textarea,
#birthdayForm textarea {
    min-height: 60px;
    max-height: 180px;
}

#holidayForm button[type="submit"],
#birthdayForm button[type="submit"] {
    margin-top: 18px;
    width: 100%;
    font-size: 1.1em;
    font-weight: bold;
}
#eventForm input[type="text"]:focus,
#eventForm input[type="date"]:focus,
#eventForm input[type="time"]:focus,
#eventForm textarea:focus {
    border-color: #a770ef;
    background: rgba(167,112,239,0.09);
}

#eventForm textarea {
    min-height: 60px;
    max-height: 180px;
}
/* Settings Modal Styling */
#settingsModal .modal-content {
    max-width: 420px;
    padding: 32px 28px 24px 28px;
    border-radius: 32px;
    background: linear-gradient(135deg, rgba(255,255,255,0.22) 0%, rgba(167,112,239,0.13) 100%);
    box-shadow: 0 8px 32px 0 rgba(167,112,239,0.18), 0 1.5px 8px 0 rgba(255,255,255,0.12) inset;
    border: 1.5px solid rgba(167,112,239,0.28);
    color: #fff;
    position: relative;
    animation: glassSlideDown 0.7s cubic-bezier(0.4,0,0.2,1);
}
#settingsModal .options {
    list-style: none;
    padding: 0;
    margin: 0;
}
#settingsModal .options li {
    margin-bottom: 18px;
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 1em;
}
#settingsModal label {
    font-weight: bold;
    color: #a770ef;
    margin-bottom: 0;
}
#settingsModal select {
    padding: 8px 14px;
    border-radius: 16px;
    border: 1.5px solid #a770ef44;
    background: rgba(255,255,255,0.09);
    color: #fff;
    font-size: 1em;
    font-family: inherit;
    box-shadow: 0 2px 8px rgba(31,38,135,0.08);
    outline: none;
    transition: border-color 0.2s, background 0.2s;
}
#settingsModal select:focus {
    border-color: #a770ef;
    background: rgba(167,112,239,0.09);
}

/* Toggle Switch Styling */
#settingsModal input[type="checkbox"] {
    display: none;
}
#settingsModal .toggle-switch {
    position: relative;
    display: inline-block;
    width: 46px;
    height: 24px;
    vertical-align: middle;
}
#settingsModal .toggle-switch input[type="checkbox"] + .slider {
    position: absolute;
    cursor: pointer;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(167,112,239,0.18);
    border-radius: 24px;
    transition: background 0.3s;
}
#settingsModal .toggle-switch input[type="checkbox"]:checked + .slider {
    background: linear-gradient(135deg, #a770ef 0%, #37066e 100%);
}
#settingsModal .toggle-switch .slider:before {
    content: "";
    position: absolute;
    left: 4px;
    top: 4px;
    width: 16px;
    height: 16px;
    background: #fff;
    border-radius: 50%;
    transition: transform 0.3s;
    box-shadow: 0 2px 8px rgba(167,112,239,0.18);
}
#settingsModal .toggle-switch input[type="checkbox"]:checked + .slider:before {
    transform: translateX(22px);
}
#settingsModal .toggle-switch .slider {
    box-sizing: border-box;
}
#eventForm button[type="submit"] {
    margin-top: 18px;
    width: 100%;
    font-size: 1.1em;
    font-weight: bold;
}
.apps-menu {
    position: absolute;
    top: 70px;
    right: 0;
    min-width: 220px;
    background: linear-gradient(135deg, rgba(255,255,255,0.22) 0%, rgba(167,112,239,0.13) 100%);
    border-radius: 24px;
    box-shadow: 0 8px 32px 0 rgba(167,112,239,0.18), 0 1.5px 8px 0 rgba(255,255,255,0.12) inset;
    border: 1.5px solid rgba(167,112,239,0.28);
    display: none;
    flex-direction: column;
    align-items: stretch;
    z-index: 1200;
    padding: 12px 10px;
    height: 100vh;
    max-height: 700px;
    overflow-y: auto;
    animation: glassSlideDown 0.4s cubic-bezier(0.4,0,0.2,1);
}
.apps-menu.active {
    display: flex;
}
.apps-menu .item {
    display: flex;
    flex-direction: column;
    gap: 8px;
    padding: 8px 0;
    cursor: pointer;
    color: #fff;
    font-size: 1em;
    transition: background 0.2s, color 0.2s;
}
.apps-menu .item a {
    color: inherit;
    text-decoration: none;
}
.apps-menu .item:hover {
    background: rgba(167,112,239,0.13);
    color: #a770ef;
}
.apps-menu hr {
    border: none;
    border-top: 1px solid rgba(167,112,239,0.18);
    margin: 8px 0;
}
.more-wrapper {
    position: absolute;
    top: 70px;
    right: 0;
    min-width: 220px;
    background: linear-gradient(135deg, rgba(255,255,255,0.22) 0%, rgba(167,112,239,0.13) 100%);
    border-radius: 24px;
    box-shadow: 0 8px 32px 0 rgba(167,112,239,0.18), 0 1.5px 8px 0 rgba(255,255,255,0.12) inset;
    border: 1.5px solid rgba(167,112,239,0.28);
    display: none;
    flex-direction: column;
    align-items: stretch;
    z-index: 1200;
    padding: 12px 10px;
    animation: glassSlideDown 0.4s cubic-bezier(0.4,0,0.2,1);
}
.more-wrapper.active {
    display: flex;
}
.more-wrapper .item {
    display: flex;
    flex-direction: column;
    gap: 8px;
    padding: 8px 0;
    cursor: pointer;
    color: #fff;
    font-size: 1em;
    transition: background 0.2s, color 0.2s;
}
.more-wrapper .item:hover {
    background: rgba(167,112,239,0.13);
    color: #a770ef;
}
.more-wrapper hr {
    border: none;
    border-top: 1px solid rgba(167,112,239,0.18);
    margin: 8px 0;
}
@media (max-width: 540px) {
    .modal-content {
        max-width: 98vw;
        padding: 18px 8px 14px 8px;
        border-radius: 18px;
    }
}

@media (max-width: 1366px) {
    .search-bar {
        margin-left: 10px;
        margin-right: 10px;
    }
}
@media (max-width: 1190px) {
    .search-bar {
        display: none;
    }
    #searchIconMobile {
        display: block !important;
    }
    .toolbar .toolbar-label {
        display: none !important;
    }
}
@media (max-width: 1030px) {
    .logo-text {
        display: none;
    }
}
@media (max-width: 805px) {
    .hide-805 {
        display: none !important;
    }
    .topbar {
        padding: 14px 20px;
    }
    .search-bar {
        margin-right: 10px;
    }
    .create-label {
        display: none;
    }
}
@media (max-width: 600px) {
    .hide-600 {
        display: none !important;
    } 
    
}
@media (max-width: 540px) {
    .hide-540 {
        display: none !important;
    }
    .topbar {
        padding: 10px 15px;
        gap: 10px;
    }
    .top-left {
        gap: 10px;
    }
    .top-right {
        gap: 10px;
    }
    .btn {
        padding: 10px 15px;
        font-size: 0.9em;
    }
    .search-bar {
        margin-right: 5px;
    }
}
@media (max-width: 768px) {
    .skip-link {
        display: none !important;
    }
}
@media (max-width: 400px) {
    .logo {
        display: none;
    }
     #todayDate {
        display: none !important;
    } 
}

    </style>
    </head>
    
<body> 
     <div class="welcome-screen" id="welcome-screen"></div>
    <header class="topbar liquid-glass">
      
        <div class="top-left">
           
          <div class="logo">
            <img src="logo.png" alt="Munetios Logo" style="height: 50px;"> 
            <div class="logo-text">Munetios Calendar</div> 
           
        </div> 
       <a href="#main" class="btn skip-link">Skip to main content</a> 
        </div>
        <div class="search-bar liquid-glass">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 8px;">
                <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"></circle>
                <line x1="16.6569" y1="16.6569" x2="21" y2="21" stroke="currentColor" stroke-width="2" stroke-linecap="round"></line>
            </svg>
            <input type="text" placeholder="Search events, birthdays and more" id="searchInput">
        </div>
        <div class="top-right">
            <div class="search-icon" id="searchIconMobile" title="Search" aria-label="Search">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"></circle>
                    <line x1="16.6569" y1="16.6569" x2="21" y2="21" stroke="currentColor" stroke-width="2" stroke-linecap="round"></line>
                </svg>
            </div>
            <button class="btn" id="createBtn" aria-label="Create" title="Create">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 5v14m-7-7h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                </svg>
                <div class="create-label">Create</div>
            </button>
            <div class="create-wrapper">
                <div class="item">
                    <button class="btn" id="createEventBtn" style="border: none; background-color: transparent;" title="Create Event" aria-label="Create Event">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <div class="toolbar-label">Event</div>
                    </button>
                    <button class="btn" id="createBirthdayBtn" style="border: none; background-color: transparent;" title="Create Birthday" aria-label="Create Birthday">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <!-- Cake base -->
                            <rect x="5" y="12" width="14" height="7" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
                            <!-- Cake top -->
                            <path d="M5 12c0-2 2-4 7-4s7 2 7 4" stroke="currentColor" stroke-width="2" fill="none"/>
                            <!-- Candle -->
                            <rect x="11" y="7" width="2" height="4" rx="1" stroke="currentColor" stroke-width="2" fill="none"/>
                            <!-- Flame -->
                            <ellipse cx="12" cy="6" rx="0.7" ry="1.1" fill="#FFD700" stroke="currentColor" stroke-width="0.5"/>
                        </svg>
                        <div class="toolbar-label">Birthday</div>
                    </button>
                    <button class="btn" id="createHolidayBtn" style="border: none; background-color: transparent;" title="Create Holiday" aria-label="Create Holiday">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            <circle cx="12" cy="12" r="6" stroke="currentColor" stroke-width="2" fill="none"/>
                            <path d="M12 8v4l3 2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <div class="toolbar-label">Holiday</div>
                    </button>
                </div>
            </div>
            <div class="events-icon">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="3" y="4" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"></rect>
                    <path d="M16 2V6" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                    <path d="M8 2V6" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                    <path d="M3 10H21" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                </svg>
            </div>
            <div class="help-icon hide-540" title="Help" aria-label="Help">
              <svg width="28" height="28" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z"></path></svg>
            </div>
            <div class="settings-icon hide-540" title="Settings" aria-label="Settings">
               <svg height="28" width="28" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.438.995s.145.755.438.995l1.003.827c.48.398.668 1.03.26 1.431l-1.296 2.247a1.125 1.125 0 01-1.37.49l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.063-.374-.313-.686-.645-.87a6.52 6.52 0 01-.22-.127c-.324-.196-.72-.257-1.075-.124l-1.217.456a1.125 1.125 0 01-1.37-.49l-1.296-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.437-.995s-.145-.755-.437-.995l-1.004-.827a1.125 1.125 0 01-.26-1.431l1.296-2.247a1.125 1.125 0 011.37-.49l1.217.456c.355.133.75.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
            </div>
            <div class="apps-icon hide-540" title="Apps" aria-label="Apps">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="6" cy="6" r="2" fill="currentColor"></circle>
                    <circle cx="12" cy="6" r="2" fill="currentColor"></circle>
                    <circle cx="18" cy="6" r="2" fill="currentColor"></circle>
                    <circle cx="6" cy="12" r="2" fill="currentColor"></circle>
                    <circle cx="12" cy="12" r="2" fill="currentColor"></circle>
                    <circle cx="18" cy="12" r="2" fill="currentColor"></circle>
                    <circle cx="6" cy="18" r="2" fill="currentColor"></circle>
                    <circle cx="12" cy="18" r="2" fill="currentColor"></circle>
                    <circle cx="18" cy="18" r="2" fill="currentColor"></circle>
                </svg>
            </div>
            <div class="apps-menu">
              <iframe src="https://www.munetios.com/apps" width="450" height="100%" sandbox="allow-scripts allow-same-origin allow-popups" frameborder="0"></iframe>
            </div>
            <div class="more-icon" id="moreBtn"     title="More options" aria-label="More options">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="5" r="2" fill="currentColor"></circle>
                    <circle cx="12" cy="12" r="2" fill="currentColor"></circle>
                    <circle cx="12" cy="19" r="2" fill="currentColor"></circle>
                </svg>
            </div>
            <div class="more-wrapper">
                <div class="item">
                    <span>Help</span>
                </div>
                <div class="item">
                    <span><a style="text-decoration: none; color: white;" href="about.html">About</a></span>
                </div>
                <div class="item">
                    <span>Settings</span>
                </div>
                <hr>
             <button id="installApp" style="display:none;">
  Install Munetios Calendar
</button>

<script>
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  const btn = document.getElementById('installApp');
  btn.style.display = 'block';
  btn.onclick = async () => {
    btn.style.display = 'none';
    deferredPrompt.prompt();
    const choice = await deferredPrompt.userChoice;
    if (choice.outcome === 'accepted') console.log('App installed');
    deferredPrompt = null;
  };
});
</script>

            </div>
        </div>
    </header> 
    <br>
    <div class="toolbar">
        <div class="top-left" style="flex-direction: row !important; align-items: center; gap: 10px; display: flex !important;">
            <div class="menu-bar" style="display: flex; align-items: center; gap: 10px;">
                <span style="font-weight: bold;" id="todayDate"></span>
                <button class="btn" id="arrowLeftBtn" title="Previous Month" aria-label="Previous">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M15 6l-6 6 6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <button class="btn" id="arrowRightBtn2" title="Next Month" aria-label="Next">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
        </div>
        <div class="top-right" >
            <button class="btn" id="favorites">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <div class="dropdown" style="position: relative;">
                <button class="btn" id="viewBtn" title="View" aria-label="View" aria-haspopup="true" aria-expanded="false" type="button">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <rect x="3" y="4" width="18" height="16" rx="4" stroke="currentColor" stroke-width="2" fill="none"/>
                        <path d="M8 2v4M16 2v4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <path d="M3 10h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    <div class="toolbar-label">View</div>
                    <svg width="16" height="16" style="margin-left:6px;" viewBox="0 0 16 16" fill="none">
                        <path d="M4 6l4 4 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <div id="viewDropdown" class="dropdown-content" style="display:none; position:absolute; top:110%; left:0; min-width:140px; background:rgba(35, 1, 75, 0.95); border-radius:16px; box-shadow:0 4px 16px rgba(0,0,0,0.12); z-index:1000; overflow:hidden;">
                    <button class="btn" style="width:100%; border-radius:0; background:none; color:#ffffff; box-shadow:none; padding:10px 18px; text-align:left;" onclick="selectView('Month')">Month</button>
                    <button class="btn" style="width:100%; border-radius:0; background:none; color:#ffffff; box-shadow:none; padding:10px 18px; text-align:left;" onclick="selectView('Day')">Day</button>
                    <button class="btn" style="width:100%; border-radius:0; background:none; color:#ffffff; box-shadow:none; padding:10px 18px; text-align:left;" onclick="selectView('Week')">Week</button>
                    <button class="btn" style="width:100%; border-radius:0; background:none; color:#ffffff; box-shadow:none; padding:10px 18px; text-align:left;" onclick="selectView('Year')">Year</button>
                    <button class="btn" style="width:100%; border-radius:0; background:none; color:#ffffff; box-shadow:none; padding:10px 18px; text-align:left;" onclick="selectView('Timeline')">Timeline</button>
                    <button class="btn" style="width:100%; border-radius:0; background:none; color:#ffffff; box-shadow:none; padding:10px 18px; text-align:left;" onclick="selectView('Agenda')">Agenda</button>
                </div>
            </div>
            <script>
              
            </script>
            <button class="btn" style="display: none !important;" disabled id="newEvent">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <div class="toolbar-label">New Event</div>
            </button>
            <button class="btn" disabled id="printBtn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M6 9V4a2 2 0 012-2h8a2 2 0 012 2v5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M6 14h12v7H6v-7z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M6 18h12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <div class="toolbar-label">Print</div>
            </button>
            <button class="btn" disabled id="shareBtn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M4 12v7a1 1 0 001 1h14a1 1 0 001-1v-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M12 16V4m0 0l-4 4m4-4l4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <div class="toolbar-label">Share</div>
            </button>
                <button class="btn" id="selectDateCalendar" title="Select Date" aria-label="Select Date">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <rect x="4" y="4" width="16" height="16" rx="4" stroke="currentColor" stroke-width="2" fill="none"/>
                            <polyline points="7 13 11 17 17 9" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <div class="toolbar-label">Select</div>
                </button>
                <button class="more-icon btn" id="moreBtn" style="display: none;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="5" r="2" fill="currentColor"></circle>
                        <circle cx="12" cy="12" r="2" fill="currentColor"></circle>
                        <circle cx="12" cy="19" r="2" fill="currentColor"></circle>
                    </svg>
                </button>
                </div>
    </div>
    <main id="main">
        <div class="tabs" style="display: flex; gap: 10px; padding: 0 20px; margin-top: 10px; justify-content: center; align-items: center;">
            <button class="btn tab">Calendar</button>
            <button class="btn  tab">Tasks</button>
        </div>
        <div class="calendar-content">
            <div class="calendar" id="calendar"></div>
        </div>
        <div class="tasks-content" style="display: none; padding: 0 20px; margin-top: 10px;">
            <iframe style="width: 100%; height: 80vh; border-radius: 4px;" sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-pointer-lock allow-top-navigation allow-modals allow-downloads allow-popups-to-escape-sandbox allow-storage-access-by-user-activation" allow="geolocation; microphone; camera; midi; encrypted-media; clipboard-read; clipboard-write; payment; usb; xr-spatial-tracking" src="https://tasks.munetios.com" frameborder="0"></iframe>
        </div>
    </main> 
    <div class="modal" id="createEventModal">
        <div class="modal-content liquid-glass">
            <span class="close" id="closeModal">&times;</span>
            <h2>Create New Event</h2>
            <form id="eventForm">
                <label for="eventTitle">Event Title:</label>
                <input type="text" id="eventTitle" name="eventTitle" required>
                
                <label for="eventDate">Event Date:</label>
                <input type="date" id="eventDate" name="eventDate" required>
                
                <label for="eventTime">Event Time:</label>
                <input type="time" id="eventTime" name="eventTime">
                
                <label for="eventDescription">Description:</label>
                <textarea id="eventDescription" name="eventDescription"></textarea>
                
                <button type="submit" class="btn">Create Event</button>
            </form>
        </div>
    </div>
    <!-- Create Holiday Modal -->
    <div class="modal" id="createHolidayModal">
        <div class="modal-content liquid-glass">
            <span class="close" id="closeHolidayModal">&times;</span>
            <h2>Create New Holiday</h2>
            <form id="holidayForm">
                <label for="holidayTitle">Holiday Name:</label>
                <input type="text" id="holidayTitle" name="holidayTitle" required>
                
                <label for="holidayDate">Date:</label>
                <input type="date" id="holidayDate" name="holidayDate" required>
                
                <label for="holidayCountry">Country/Region:</label>
                <select id="holidayCountry" name="holidayCountry" required>
                    <option value="">Select Country/Region</option>
                    <option value="US">United States</option>
                    <option value="UK">United Kingdom</option>
                    <option value="CA">Canada</option>
                    <option value="AU">Australia</option>
                    <option value="IN">India</option>
                    <option value="FR">France</option>
                    <option value="DE">Germany</option>
                    <option value="CN">China</option>
                    <option value="JP">Japan</option>
                    <option value="BR">Brazil</option>
                    <option value="ZA">South Africa</option>
                    <option value="MX">Mexico</option>
                    <option value="RU">Russia</option>
                    <option value="KR">South Korea</option>
                    <option value="Islamic">Islamic</option>
                    <option value="Jewish">Jewish</option>
                    <option value="Buddhist">Buddhist</option>
                    <option value="Christian">Christian</option>
                    <option value="Other">Other</option>
                </select>
                
                <label for="holidayDescription">Description:</label>
                <textarea id="holidayDescription" name="holidayDescription"></textarea>
                
                <button type="submit" class="btn">Create Holiday</button>
            </form>
        </div>
    </div>
    <div class="modal" id="eventsList">
        <div class="modal-content liquid-glass">
            <span class="close" id="closeEventsList">&times;</span>
            <h1>Events</h1>
            <div class="tabs" style="display: flex; gap: 10px; padding: 10px 0; justify-content: center; align-items: center;">
                <button class="btn tab" id="allEventsTab">All Events</button>
                <button class="btn tab" id="birthdaysTab">Birthdays</button>
                <button class="btn tab" id="holidaysTab">Holidays</button>
            </div>
            <div id="allEventsContent" style="display: none; max-height: 400px; overflow-y: auto;">
                <ul id="allEventsList" style="list-style: none; padding: 0;">
                    <!-- All events will be dynamically added here -->
                </ul>
            </div>
            <div id="birthdaysContent" style="display: none; max-height: 400px; overflow-y: auto;">
                <ul id="birthdaysList" style="list-style: none; padding: 0;">
                    <!-- Birthdays will be dynamically added here -->
                </ul>
            </div>
            <div id="holidaysContent" style="display: none; max-height: 400px; overflow-y: auto;">
                <ul id="holidaysList" style="list-style: none; padding: 0;">
                    <!-- Holidays will be dynamically added here -->
                </ul>
            </div>
        </div>
    </div>
    <div class="modal" id="favoritesModal">
        <div class="modal-content liquid-glass">
            <span class="close" id="closeFavoritesModal">&times;</span>
            <h2>Favorites</h2>
            <p>Your favorite events and holidays will appear here.</p>
            <ul id="favoritesList" style="list-style: none; padding: 0; max-height: 300px; overflow-y: auto;">
                <!-- Favorite items will be dynamically added here -->
            </ul>
        </div>
    </div>
    <div class="modal" id="settingsModal">
        <div class="modal-content liquid-glass">
            <span class="close" id="closeSettingsModal">&times;</span>
            <h2>Settings</h2>
            <div class="settings-content">
                <ul class="options">
                    <li>
                        <label>Theme:</label>
                        <select id="themeSelect">
                            <option value="light">Light</option>
                            <option value="dark" selected>Dark</option>
                            <option value="system">System Default</option>
                        </select>
                    </li>
                    <li>
                        <label for="holidayRegionShow" style="margin-right: 12px;">Show Holidays For</label>
                        <select id="holidayRegionShow">
                            <option value="all" selected>All regions</option>
                            <option value="US">United States</option>
                            <option value="UK">United Kingdom</option>
                            <option value="CA">Canada</option>
                            <option value="AU">Australia</option>
                            <option value="IN">India</option>
                            <option value="FR">France</option>
                            <option value="DE">Germany</option>
                            <option value="CN">China</option>
                            <option value="JP">Japan</option>
                            <option value="BR">Brazil</option>
                            <option value="ZA">South Africa</option>
                            <option value="MX">Mexico</option>
                            <option value="RU">Russia</option>
                            <option value="KR">South Korea</option>
                            <option value="Islamic">Islamic</option>
                            <option value="Jewish">Jewish</option>
                            <option value="Buddhist">Buddhist</option>
                            <option value="Christian">Christian</option>
                            <option value="Other">Other</option>
                        </select>
                    </li>
                    <li>
                        <label for="reduceTransparencyCheckbox" style="margin-right: 12px;">Reduce Transparency</label>
                        <label class="toggle-switch" for="reduceTransparencyCheckbox">
                            <input type="checkbox" id="reduceTransparencyCheckbox">
                            <span class="slider"></span>
                        </label>
                    </li>
                    <li>
                        <label>Language:</label>
                        <select id="languageSelect">
                            <option value="en" selected>English</option>
                            <option value="es">Spanish</option>
                            <option value="fr">French</option>
                            <option value="de">German</option>
                            <option value="zh">Chinese</option>
                            <option value="ja">Japanese</option>
                            <option value="ru">Russian</option>
                            <option value="ar">Arabic</option>
                            <option value="hi">Hindi</option>
                            <option value="pt">Portuguese</option>
                            </select>
                    </li>
                    <li>
                        <label for="notificationsCheckbox" style="margin-right: 12px;">Enable Desktop Notifications</label>
                        <label class="toggle-switch" for="notificationsCheckbox">
                            <input type="checkbox" id="notificationsCheckbox">
                            <span class="slider"></span>
                        </label>
                    </li>
                    <li>
                         <button class="btn" id="backupRestoreBtn" type="button">Backup & Restore</button>  
                    </li>
                 
                </ul>
            </div>
        </div>
    </div>
    <div class="modal" id="backupModal">
        <div class="modal-content liquid-glass">
            <span class="close" id="closeBackupModal">&times;</span>
            <h2>Backup & Restore</h2>
            <button class="btn" id="backupBtn">Backup Data</button>
            <input type="file" accept=".json" id="restoreInput" style="display: none;">
            <button class="btn" id="restoreBtn">Restore Data</button>
            <p id="backupStatus" style="margin-top: 10px;"></p>
        </div>
    </div>
    <!-- Create Birthday Modal -->
    <div class="modal" id="createBirthdayModal">
        <div class="modal-content liquid-glass">
            <span class="close" id="closeBirthdayModal">&times;</span>
            <h2>Create New Birthday</h2>
            <form id="birthdayForm">
                <label for="birthdayName">Name:</label>
                <input type="text" id="birthdayName" name="birthdayName" required>
                
                <label for="birthdayDate">Birthday:</label>
                <input type="date" id="birthdayDate" name="birthdayDate" required>
                
                <label for="birthdayDescription">Description:</label>
                <textarea id="birthdayDescription" name="birthdayDescription"></textarea>
                
                <button type="submit" class="btn">Create Birthday</button>
            </form>
        </div>
    </div>
    <script>

    function showWelcomeScreen() {
        // Only show once per user (localStorage)
        if (
            localStorage.getItem('welcomeScreenClosed') === 'true' ||
            !navigator.onLine
        ) {
            document.getElementById('welcome-screen').style.display = 'none';
            return;
        }

        // Calculate network speed (if available)
        let speed = 1;
        if (navigator.connection && navigator.connection.downlink) {
            speed = navigator.connection.downlink;
        }

        // Determine loadTime (welcome screen visible) and progressTime (progress bar duration)
        let loadTime, progressTime;
        if (speed >= 10) {
            loadTime = 100;
            progressTime = 1000;
        } else if (speed >= 5) {
            loadTime = 500;
            progressTime = 3000;
        } else if (speed >= 2) {
            loadTime = 2000;
            progressTime = 7000;
        } else if (speed >= 1) {
            loadTime = 5000;
            progressTime = 15000;
        } else if (speed > 0) {
            loadTime = 15000;
            progressTime = 30000;
        } else {
            loadTime = 100 + Math.random() * (60000 - 100);
            progressTime = 1000 + Math.random() * (120000 - 1000);
        }
        loadTime = Math.max(100, Math.min(60000, loadTime));
        progressTime = Math.max(1000, Math.min(120000, progressTime));

        if (navigator.connection && navigator.connection.downlink && navigator.connection.downlink < 0.5) {
            document.getElementById('welcome-screen').style.display = 'none';
            window.addEventListener('load', () => {
                setTimeout(() => {
                    document.getElementById('welcome-screen').style.display = 'flex';
                }, 1000);
            });
            return;
        }

        // Random welcome descriptions
        const descs = [
            "Munetios Calendar is a modern, user-friendly calendar application designed to help you manage your schedule with ease. Enjoy features like events, holidays, tasks, and more. The UI is liquid glass and fully responsive. Do more with Munetios Calendar!",
            "Plan your days with Munetios Calendar. Organize events, track holidays, and manage tasks in a beautiful, animated interface.",
            "Welcome! Munetios Calendar helps you stay productive with events, birthdays, holidays, and a sleek, responsive design.",
            "Your time, organized. Munetios Calendar brings you a fast, modern calendar with tasks, favorites, and more.",
            "All your events, holidays, and tasks in one place. Munetios Calendar is designed for productivity and style.",
            "Experience the next generation of calendar apps with Munetios Calendar. Responsive, beautiful, and packed with features."
        ];
        const randomDesc = descs[Math.floor(Math.random() * descs.length)];

        // Show fetching message in calendar content
        const calendarContent = document.querySelector('.calendar-content');
        let oldCalendarHTML = calendarContent.innerHTML;
        calendarContent.innerHTML = `<div style="color:#a770ef;font-size:1.3em;text-align:center;margin-top:40px;">Fetching the calendar...</div>`;

        const welcome = document.getElementById('welcome-screen');
        welcome.style.position = 'fixed';
        welcome.style.top = '0';
        welcome.style.left = '0';
        welcome.style.width = '100vw';
        welcome.style.height = '100vh';
        welcome.style.background = 'linear-gradient(120deg, #270e33 0%, #4800a7 100%)';
        welcome.style.zIndex = '99999';
        welcome.style.display = 'flex';
        welcome.style.flexDirection = 'column';
        welcome.style.justifyContent = 'center';
        welcome.style.alignItems = 'center';
        welcome.style.transition = 'opacity 0.7s cubic-bezier(0.4,0,0.2,1)';

        // Story mode button only if min width 800 and min height 600
        let showStoryMode = window.innerWidth >= 800 && window.innerHeight >= 600;
        let storyBtnHtml = '';
        if (showStoryMode) {
            storyBtnHtml = `<button id="storyModeBtn" class="btn" style="margin-top:24px;font-size:1.1em;background:linear-gradient(135deg,#FFD700 0%,#a770ef 100%);color:#270e33;font-weight:bold;">Story mode</button>`;
        }

        welcome.innerHTML = `
            <div id="welcomeRocket" style="margin-bottom:32px;animation:rocketUp 2s cubic-bezier(0.4,0,0.2,1) infinite;">
                <svg width="90" height="90" viewBox="0 0 64 64" fill="none">
                    <g>
                        <ellipse cx="32" cy="62" rx="8" ry="2.5" fill="#FFD700" opacity="0.7"/>
                        <path d="M32 4C36 16 44 24 44 32C44 40 36 48 32 60C28 48 20 40 20 32C20 24 28 16 32 4Z" fill="#a770ef" stroke="#fff" stroke-width="2"/>
                        <circle cx="32" cy="32" r="7" fill="#fff" stroke="#a770ef" stroke-width="2"/>
                        <rect x="29" y="52" width="6" height="10" rx="3" fill="#FFD700"/>
                        <polygon points="32,62 29,52 35,52" fill="#FFD700" opacity="0.8"/>
                        <path d="M32 14 L32 24" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
                        <circle cx="32" cy="12" r="2" fill="#FFD700" opacity="0.9"/>
                    </g>
                </svg>
            </div>
            <div id="welcomeText" style="font-size:2.6em;font-weight:bold;color:#fff;text-align:center;letter-spacing:2px;animation:fadeInWelcome 1.2s cubic-bezier(0.4,0,0.2,1);">
                WELCOME TO MUNETIOS Calendar
            </div>
            <div id="welcomeDesc" style="font-size:1.3em;color:#e0e0e0;text-align:center;margin-top:18px;max-width:500px;animation:fadeInDesc 1.8s cubic-bezier(0.4,0,0.2,1);">
                ${randomDesc}
            </div>
            <div id="welcomeProgressBar" style="width:320px;height:12px;background:rgba(255,255,255,0.13);border-radius:8px;overflow:hidden;margin-top:32px;">
                <div id="welcomeProgress" style="height:100%;width:0%;background:linear-gradient(90deg,#a770ef 0%,#FFD700 100%);border-radius:8px;transition:width 0.2s;"></div>
            </div>
            ${storyBtnHtml}
            <div style="margin-top:32px; display:none !important;">
                <button id="settingsWelcomeBtn" class="btn" style="font-size:1.1em;">Settings</button>
            </div>
        `;

        // Animate rocket and text
        const style = document.createElement('style');
        style.innerHTML = `
            @keyframes rocketUp {
                0% { transform: translateY(40px) scale(0.8); opacity:0.7; }
                20% { transform: translateY(0) scale(1.05); opacity:1; }
                40% { transform: translateY(-30px) scale(1.1); opacity:1; }
                60% { transform: translateY(-60px) scale(1.15); opacity:1; }
                80% { transform: translateY(0) scale(1.05); opacity:1; }
                100% { transform: translateY(40px) scale(0.8); opacity:0.7; }
            }
            @keyframes fadeInWelcome {
                0% { opacity:0; transform:scale(0.95);}
                100% { opacity:1; transform:scale(1);}
            }
            @keyframes fadeInDesc {
                0% { opacity:0; transform:translateY(40px);}
                100% { opacity:1; transform:translateY(0);}
            }
            @keyframes fadeInSection {
                0% { opacity:0; transform:translateY(40px);}
                100% { opacity:1; transform:translateY(0);}
            }
            @keyframes fadeOutWelcome {
                0% { opacity:1; }
                100% { opacity:0; }
            }
            .story-highlight {
                box-shadow: 0 0 0 4px #FFD700, 0 0 16px 4px #a770ef88 !important;
                z-index: 10001 !important;
                position: relative !important;
                transition: box-shadow 0.3s, filter 0.2s;
                filter: brightness(1.25);
            }
            .story-tooltip {
                position: fixed;
                pointer-events: none;
                z-index: 10002;
                background: linear-gradient(135deg,#FFD700 0%,#a770ef 100%);
                color: #270e33;
                font-weight: bold;
                font-size: 1.08em;
                padding: 12px 22px;
                border-radius: 18px;
                box-shadow: 0 4px 24px #a770ef44;
                white-space: pre-line;
                max-width: 340px;
                opacity: 0.98;
            }
        `;
        document.head.appendChild(style);

        // Animate progress bar (duration: progressTime)
        let progress = 0;
        const progressBar = document.getElementById('welcomeProgress');
        let startTime = Date.now();
        let interval = setInterval(() => {
            let elapsed = Date.now() - startTime;
            progress = Math.min(100, (elapsed / progressTime) * 100);
            progressBar.style.width = progress + '%';
            if (progress >= 100) clearInterval(interval);
        }, 50);

        // Settings modal for welcome screen
        let welcomeSettingsModal = document.getElementById('welcomeSettingsModal');
        if (!welcomeSettingsModal) {
            welcomeSettingsModal = document.createElement('div');
            welcomeSettingsModal.id = 'welcomeSettingsModal';
            welcomeSettingsModal.className = 'modal';
            welcomeSettingsModal.style.display = 'none';
            welcomeSettingsModal.innerHTML = `
                <div class="modal-content liquid-glass" style="max-width: 420px;">
                    <span class="close" id="closeWelcomeSettingsModal" style="right:18px;top:18px;">&times;</span>
                    <h2 style="text-align:center;color:#a770ef;">Settings</h2>
                    <div class="settings-content">
                        <ul class="options">
                            <li>
                                <label>Theme:</label>
                                <select id="welcomeThemeSelect">
                                    <option value="light">Light</option>
                                    <option value="dark" selected>Dark</option>
                                    <option value="system">System Default</option>
                                </select>
                            </li>
                            <li>
                                <label>Language:</label>
                                <select id="welcomeLanguageSelect">
                                    <option value="en" selected>English</option>
                                    <option value="es">Spanish</option>
                                    <option value="fr">French</option>
                                    <option value="de">German</option>
                                    <option value="zh">Chinese</option>
                                    <option value="ja">Japanese</option>
                                    <option value="ru">Russian</option>
                                    <option value="ar">Arabic</option>
                                    <option value="hi">Hindi</option>
                                    <option value="pt">Portuguese</option>
                                </select>
                            </li>
                            <li>
                                <label for="welcomeReduceTransparencyCheckbox" style="margin-right: 12px;">Reduce Transparency</label>
                                <label class="toggle-switch" for="welcomeReduceTransparencyCheckbox">
                                    <input type="checkbox" id="welcomeReduceTransparencyCheckbox">
                                    <span class="slider"></span>
                                </label>
                            </li>
                        </ul>
                    </div>
                </div>
            `;
            document.body.appendChild(welcomeSettingsModal);
            document.getElementById('closeWelcomeSettingsModal').onclick = function() {
                welcomeSettingsModal.style.display = 'none';
                welcome.style.display = 'flex';
            };
            document.getElementById('welcomeThemeSelect').value = localStorage.getItem('theme') || 'dark';
            document.getElementById('welcomeThemeSelect').onchange = function() {
                localStorage.setItem('theme', this.value);
                if (typeof applyTheme === 'function') applyTheme(this.value);
            };
            document.getElementById('welcomeLanguageSelect').value = localStorage.getItem('language') || 'en';
            document.getElementById('welcomeLanguageSelect').onchange = function() {
                localStorage.setItem('language', this.value);
                if (typeof applyTranslations === 'function') applyTranslations(this.value);
            };
            document.getElementById('welcomeReduceTransparencyCheckbox').checked = localStorage.getItem('reduceTransparency') === 'true';
            document.getElementById('welcomeReduceTransparencyCheckbox').onchange = function() {
                localStorage.setItem('reduceTransparency', this.checked);
                if (typeof applyTransparency === 'function') applyTransparency(this.checked);
            };
        }

        document.getElementById('settingsWelcomeBtn').onclick = function() {
            welcome.style.display = 'none';
            welcomeSettingsModal.style.display = 'flex';
        };

        // --- Story Mode with interactive tips/highlights ---
        function runStoryMode() {
            // Remove any existing overlay
            let old = document.getElementById('storyModeOverlay');
            if (old) old.remove();

            // Remove any highlight
            document.querySelectorAll('.story-highlight').forEach(el => el.classList.remove('story-highlight'));
            document.querySelectorAll('.story-tooltip').forEach(el => el.remove());

            let overlay = document.createElement('div');
            overlay.id = 'storyModeOverlay';
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100vw';
            overlay.style.height = '100vh';
            overlay.style.background = 'rgba(39,14,51,0.65)';
            overlay.style.zIndex = '10000';
            // Allow pointer events everywhere in story mode
            overlay.style.pointerEvents = 'none';
            document.body.appendChild(overlay);

            // Steps: each step can optionally highlight a selector and show a tooltip
            const steps = [
                {
                    tip: "Welcome to Story Mode!\nLet's take a quick interactive tour of Munetios Calendar.\n\nClick Next to begin.",
                    selector: null,
                    nextBtn: true
                },
                {
                    tip: "This is the <b>Create</b> button. Click it to add a new event, birthday, or holiday.",
                    selector: "#createBtn",
                    nextBtn: true,
                    waitForClick: "#createBtn"
                },
                {
                    tip: "Here you can choose to create an Event, Birthday, or Holiday. Try clicking <b>Event</b>.",
                    selector: "#createEventBtn",
                    nextBtn: true,
                    waitForClick: "#createEventBtn"
                },
                {
                    tip: "Fill in the event details and click <b>Create Event</b> to add it to your calendar.",
                    selector: "#eventForm button[type='submit']",
                    nextBtn: true
                },
                {
                    tip: "Use the <b>View</b> button to switch between Month, Day, Week, Year, Timeline, and Agenda views.",
                    selector: "#viewBtn",
                    nextBtn: true,
                    waitForClick: "#viewBtn"
                },
                {
                    tip: "Try switching to <b>Day</b> or <b>Week</b> view.",
                    selector: "#viewDropdown",
                    nextBtn: true
                },
                {
                    tip: "Use the search bar to quickly find events, birthdays, or holidays.",
                    selector: ".search-bar input",
                    nextBtn: true
                },
                {
                    tip: "Switch to the <b>Tasks</b> tab to manage your to-dos.",
                    selector: ".tabs .tab:nth-child(2)",
                    nextBtn: true,
                    waitForClick: ".tabs .tab:nth-child(2)"
                },
                {
                    tip: "Mark important dates as <b>Favorites</b> for quick access.",
                    selector: "#favorites",
                    nextBtn: true,
                    waitForClick: "#favorites"
                },
                {
                    tip: "Explore <b>Settings</b> to customize your experience.",
                    selector: ".settings-icon",
                    nextBtn: true,
                    waitForClick: ".settings-icon"
                },
                {
                    tip: "That's it for the tour!\nYou can always revisit this tour by refreshing the page.\n\nClick Done to finish.",
                    selector: null,
                    nextBtn: true
                }
            ];
            let step = 0;

            // Helper to show tooltip at mouse or at element
            function showTooltip(tip, selector) {
                // Remove old tooltip
                document.querySelectorAll('.story-tooltip').forEach(el => el.remove());
                let tooltip = document.createElement('div');
                tooltip.className = 'story-tooltip';
                tooltip.innerHTML = tip;
                document.body.appendChild(tooltip);

                // If selector, position near element, else center
                if (selector) {
                    let el = document.querySelector(selector);
                    if (el) {
                        let rect = el.getBoundingClientRect();
                        let top = rect.top + window.scrollY - tooltip.offsetHeight - 16;
                        if (top < 0) top = rect.bottom + window.scrollY + 16;
                        let left = rect.left + window.scrollX + rect.width / 2 - tooltip.offsetWidth / 2;
                        if (left < 0) left = 16;
                        if (left + tooltip.offsetWidth > window.innerWidth) left = window.innerWidth - tooltip.offsetWidth - 16;
                        tooltip.style.top = `${top}px`;
                        tooltip.style.left = `${left}px`;
                    } else {
                        tooltip.style.top = '30%';
                        tooltip.style.left = '50%';
                        tooltip.style.transform = 'translate(-50%,0)';
                    }
                } else {
                    tooltip.style.top = '30%';
                    tooltip.style.left = '50%';
                    tooltip.style.transform = 'translate(-50%,0)';
                }
            }

            function highlight(selector) {
                document.querySelectorAll('.story-highlight').forEach(el => el.classList.remove('story-highlight'));
                if (selector) {
                    let el = document.querySelector(selector);
                    if (el) {
                        el.classList.add('story-highlight');
                        el.scrollIntoView({behavior: 'smooth', block: 'center'});
                        // Enable pointer events for highlighted element
                        el.style.pointerEvents = 'auto';
                        // If it's a button and disabled, enable it for the tour
                        if (el.tagName === 'BUTTON') {
                            if (el.disabled) {
                                el.disabled = false;
                                el.setAttribute('data-story-enabled', 'true');
                            }
                            // Visually indicate enabled state
                            el.style.filter = 'brightness(1.25)';
                        }
                    }
                }
            }

            function removeHighlight() {
                document.querySelectorAll('.story-highlight').forEach(el => {
                    el.classList.remove('story-highlight');
                    // Restore disabled state if it was enabled for story
                    if (el.getAttribute('data-story-enabled') === 'true') {
                        el.disabled = true;
                        el.removeAttribute('data-story-enabled');
                    }
                    // Remove brightness filter
                    if (el.tagName === 'BUTTON') {
                        el.style.filter = '';
                    }
                });
            }

            // In story mode, allow pointer events everywhere (no blocking)
            function setPointerEvents(selector) {
                document.body.style.pointerEvents = '';
                let overlay = document.getElementById('storyModeOverlay');
                if (overlay) overlay.style.pointerEvents = 'none';
                document.querySelectorAll('.story-highlight').forEach(el => el.style.pointerEvents = '');
                if (selector) {
                    let el = document.querySelector(selector);
                    if (el) el.style.pointerEvents = '';
                }
                document.querySelectorAll('.story-tooltip').forEach(el => el.style.pointerEvents = 'auto');
            }

            function resetPointerEvents() {
                document.body.style.pointerEvents = '';
                let overlay = document.getElementById('storyModeOverlay');
                if (overlay) overlay.style.pointerEvents = 'none';
                document.querySelectorAll('.story-highlight').forEach(el => el.style.pointerEvents = '');
                document.querySelectorAll('.story-tooltip').forEach(el => el.style.pointerEvents = '');
            }

            // Show current step
            function showStep(idx) {
                removeHighlight();
                // Get current step object
                let s = steps[idx];
                // Show tooltip and highlight
                showTooltip(s.tip, s.selector);
                highlight(s.selector);

                // Add Next/Done button to tooltip if needed
                let tooltip = document.querySelector('.story-tooltip');
                if (s.nextBtn && tooltip) {
                    let btn = document.createElement('button');
                    btn.className = 'btn';
                    btn.style.marginTop = '18px';
                    btn.textContent = (idx === steps.length - 1) ? 'Done' : 'Next';
                    btn.onclick = function(e) {
                        e.stopPropagation();
                        if (idx === steps.length - 1) {
                            if (overlay) overlay.remove();
                            removeHighlight();
                            resetPointerEvents();
                            document.querySelectorAll('.story-tooltip').forEach(el => el.remove());
                        } else {
                            showStep(idx + 1);
                        }
                    };
                    tooltip.appendChild(btn);
                    // Always allow pointer events for tooltip (button)
                    tooltip.style.pointerEvents = 'auto';
                }
                // If waitForClick, attach handler
                if (s.waitForClick) {
                    let el = document.querySelector(s.waitForClick);
                    if (el) {
                        // If it's a button and disabled, enable it for the tour
                        if (el.tagName === 'BUTTON' && el.disabled) {
                            el.disabled = false;
                            el.setAttribute('data-story-enabled', 'true');
                        }
                        let handler = function(e) {
                            e.stopPropagation();
                            el.removeEventListener('click', handler, true);
                            showStep(idx + 1);
                            // Remove highlight from previous
                            removeHighlight();
                            resetPointerEvents();
                            document.querySelectorAll('.story-tooltip').forEach(el => el.remove());
                        };
                        // Use capture phase to ensure handler fires before default
                        el.addEventListener('click', handler, true);
                    }
                }
                // After tooltip and highlight, set pointer events
                setPointerEvents(s.selector);
            }
            showStep(step);
        }

        // Story mode logic
        if (showStoryMode) {
            document.getElementById('storyModeBtn').onclick = function() {
                welcome.style.display = 'none';
                localStorage.setItem('welcomeScreenClosed', 'true');
                calendarContent.innerHTML = oldCalendarHTML;
                setTimeout(runStoryMode, 300);
            };
        }

        // After loadTime ms, show section 2 (but only after progress bar is done)
        setTimeout(() => {
            let waitForProgress = () => {
                if (progress >= 100) {
                    clearInterval(interval);
                    welcome.innerHTML = `
                        <div style="margin-bottom:32px;animation:rocketUp 2s cubic-bezier(0.4,0,0.2,1) infinite;">
                            <svg width="90" height="90" viewBox="0 0 64 64" fill="none">
                                <g>
                                    <ellipse cx="32" cy="62" rx="8" ry="2.5" fill="#FFD700" opacity="0.7"/>
                                    <path d="M32 4C36 16 44 24 44 32C44 40 36 48 32 60C28 48 20 40 20 32C20 24 28 16 32 4Z" fill="#a770ef" stroke="#fff" stroke-width="2"/>
                                    <circle cx="32" cy="32" r="7" fill="#fff" stroke="#a770ef" stroke-width="2"/>
                                    <rect x="29" y="52" width="6" height="10" rx="3" fill="#FFD700"/>
                                    <polygon points="32,62 29,52 35,52" fill="#FFD700" opacity="0.8"/>
                                    <path d="M32 14 L32 24" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
                                    <circle cx="32" cy="12" r="2" fill="#FFD700" opacity="0.9"/>
                                </g>
                            </svg>
                        </div>
                        <div style="font-size:2.1em;font-weight:bold;color:#fff;text-align:center;letter-spacing:2px;margin-bottom:24px;animation:fadeInSection 1s;">
                            Get Started with Munetios Calendar
                        </div>
                        <div style="font-size:1.2em;color:#e0e0e0;text-align:center;max-width:500px;margin-bottom:24px;animation:fadeInDesc 1.2s;">
                            Easily manage your events, holidays, and tasks. Enjoy a beautiful, animated experience!
                        </div>
                        <button id="doneWelcomeBtn" class="btn" style="margin-bottom:18px;font-size:1.1em;animation:fadeInSection 1.2s;">Done</button>
                        <div style="position:absolute;bottom:32px;left:50%;transform:translateX(-50%);">
                            <button id="settingsWelcomeBtn2" class="btn" style="font-size:1em;margin-left:8px;">Settings</button>
                            <p> <a href="https://www.munetios.com/policies/#/terms">Terms</a> | <a href="https://www.munetios.com/policies/#/privacy">Privacy</a> </p>
                        </div>
                        ${showStoryMode ? `<button id="storyModeBtn2" class="btn" style="margin-top:24px;font-size:1.1em;background:linear-gradient(135deg,#FFD700 0%,#a770ef 100%);color:#270e33;font-weight:bold;">Story mode</button>` : ''}
                    `;
                    document.getElementById('doneWelcomeBtn').onclick = function() {
                        welcome.style.animation = 'fadeOutWelcome 0.7s cubic-bezier(0.4,0,0.2,1)';
                        setTimeout(() => {
                            welcome.style.display = 'none';
                            localStorage.setItem('welcomeScreenClosed', 'true');
                            calendarContent.innerHTML = oldCalendarHTML;
                        }, 700);
                    };
                    document.getElementById('classicWelcomeBtn').onclick = function() {
                        window.open('https://calendar.munetios.com/', '_blank');
                    };
                    document.getElementById('settingsWelcomeBtn2').onclick = function() {
                        welcome.style.display = 'none';
                        welcomeSettingsModal.style.display = 'flex';
                    };
                    // Story mode button in section 2
                    if (showStoryMode && document.getElementById('storyModeBtn2')) {
                        document.getElementById('storyModeBtn2').onclick = function() {
                            welcome.style.display = 'none';
                            localStorage.setItem('welcomeScreenClosed', 'true');
                            calendarContent.innerHTML = oldCalendarHTML;
                            setTimeout(runStoryMode, 300);
                        };
                    }
                } else {
                    setTimeout(waitForProgress, 100);
                }
            };
            waitForProgress();
        }, loadTime);
    }

    // Show on first load
    document.addEventListener('DOMContentLoaded', showWelcomeScreen);

        document.querySelector('.apps-icon').addEventListener('click', function(e) {
            e.stopPropagation();
            document.querySelector('.apps-menu').classList.toggle('active');
        });

        // Hide apps-menu when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.apps-icon') && !e.target.closest('.apps-menu')) {
                document.querySelector('.apps-menu').classList.remove('active');
            }
        });

        // Prevent closing when clicking inside
        document.querySelector('.apps-menu').addEventListener('click', function(e) {
            e.stopPropagation();
        });
        document.querySelector('.more-icon').addEventListener('click', function(e) {
            e.stopPropagation();
            document.querySelector('.more-wrapper').classList.toggle('active');
        });

        // Hide more-wrapper when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.more-icon') && !e.target.closest('.more-wrapper')) {
            document.querySelector('.more-wrapper').classList.remove('active');
            }
        });

        // Prevent closing when clicking inside
        document.querySelector('.more-wrapper').addEventListener('click', function(e) {
            e.stopPropagation();
        });

        // More-wrapper actions
        const moreItems = document.querySelectorAll('.more-wrapper .item');
        if (moreItems.length > 0) {
            // Help
            if (moreItems[0]) {
                moreItems[0].onclick = function() {
                    showToast('Welcome to Munetios Calendar! So we have great features like it has events, holidays, tasks, etc. The UI is liquid glass and responsive. Do more with Munetios Calendar.', { duration: 10000 });
                    document.querySelector('.more-wrapper').classList.remove('active');
                };
            }
            // about
            if (moreItems[1]) {
                moreItems[1].onclick = function() {
                    document.getElementById('aboutModal').style.display = 'flex';
                    document.querySelector('.more-wrapper').classList.remove('active');
                };
            }

            // Settings
            if (moreItems[2]) {
                moreItems[2].onclick = function() {
                    document.getElementById('settingsModal').style.display = 'flex';
                    document.querySelector('.more-wrapper').classList.remove('active');
                };
            }
   
        }


        document.getElementById('settingsModal').style.display = 'none';

        // Use 12-hour time format for event times everywhere
        function formatTime12(timeStr) {
            if (!timeStr) return '';
            let [h, m] = timeStr.split(':');
            h = parseInt(h, 10);
            let ampm = h < 12 ? 'AM' : 'PM';
            let hour12 = h % 12 === 0 ? 12 : h % 12;
            return `${hour12}:${m} ${ampm}`;
        }
        document.querySelector('.settings-icon').addEventListener('click', function(e) {
            e.stopPropagation();
            document.getElementById('settingsModal').style.display = 'flex';
        });

        // Theme selection
        const themeSelect = document.getElementById('themeSelect');
        themeSelect.value = localStorage.getItem('theme') || 'dark';

        function applyTheme(theme) {
            if (theme === 'light') {
            document.body.style.background = 'linear-gradient(120deg, #f5f5fa 0%, #e0e7ff 100%)';
            document.body.style.color = '#222';
            document.documentElement.style.setProperty('--theme-color', '#e0e7ff');
            // Update glass backgrounds for light mode
            document.querySelectorAll('.liquid-glass, .toolbar, .topbar, .modal-content, .create-wrapper').forEach(el => {
                el.style.background = 'linear-gradient(135deg, rgba(255,255,255,0.85) 0%, rgba(200,200,255,0.45) 100%)';
                el.style.borderColor = 'rgba(180,180,220,0.28)';
                el.style.boxShadow = '0 8px 32px 0 rgba(180, 180, 220, 0.18), 0 1.5px 8px 0 rgba(255,255,255,0.12) inset';
                el.style.color = '#222';
            });
            document.querySelectorAll('.btn').forEach(btn => {
                btn.style.background = 'linear-gradient(135deg, rgba(255,255,255,0.65) 0%, rgba(220,220,255,0.32) 100%)';
                btn.style.color = '#222';
                btn.style.borderColor = 'rgba(180,180,220,0.45)';
            });
            } else if (theme === 'dark') {
            document.body.style.background = 'linear-gradient(120deg, #270e33 0%, #4800a7 100%)';
            document.body.style.color = '#e0e0e0';
            document.documentElement.style.setProperty('--theme-color', '#270e33');
            document.querySelectorAll('.liquid-glass, .toolbar, .topbar, .modal-content, .create-wrapper').forEach(el => {
                el.style.background = '';
                el.style.borderColor = '';
                el.style.boxShadow = '';
                el.style.color = '';
            });
            document.querySelectorAll('.btn').forEach(btn => {
                btn.style.background = '';
                btn.style.color = '';
                btn.style.borderColor = '';
            });
            } else {
            // System default
            if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                applyTheme('dark');
            } else {
                applyTheme('light');
            }
            }
        }
        applyTheme(themeSelect.value);
        themeSelect.onchange = function() {
            localStorage.setItem('theme', themeSelect.value);
            applyTheme(themeSelect.value);
        };

     
        // Reduce transparency
        const reduceTransparencyCheckbox = document.getElementById('reduceTransparencyCheckbox');
        reduceTransparencyCheckbox.checked = localStorage.getItem('reduceTransparency') === 'true';
        function applyTransparency(reduce) {
            document.querySelectorAll('.liquid-glass, .toolbar, .topbar, .modal-content, .create-wrapper, #searchResultsWrapper').forEach(el => {
            if (reduce) {
                el.style.backdropFilter = 'none';
                el.style.background = 'rgba(60, 30, 90, 0.98)';
            } else {
                el.style.backdropFilter = '';
                el.style.background = '';
            }
            });
        }
        applyTransparency(reduceTransparencyCheckbox.checked);
        reduceTransparencyCheckbox.onchange = function() {
            localStorage.setItem('reduceTransparency', reduceTransparencyCheckbox.checked);
            applyTransparency(reduceTransparencyCheckbox.checked);
        };

        // Show Holidays For Region functionality
        const holidayRegionShow = document.getElementById('holidayRegionShow');
        holidayRegionShow.value = localStorage.getItem('holidayRegionShow') || 'all';

        function getFilteredHolidays(year) {
            const region = holidayRegionShow.value;
            const allHolidays = getHolidays(year);
            if (!region || region === 'all') return allHolidays;
            // Filter by region/country code in holiday name or type
            const regionMap = {
            US: '(US)',
            UK: '(UK)',
            CA: '(CA)',
            AU: '(AU)',
            IN: '(IN)',
            FR: '(FR)',
            DE: '(DE)',
            CN: '(CN)',
            JP: '(JP)',
            BR: '(BR)',
            ZA: '(ZA)',
            MX: '(MX)',
            RU: '(RU)',
            KR: '(KR)',
            Islamic: '(Islamic)',
            Jewish: '(Jewish)',
            Buddhist: '(Buddhist)',
            Christian: '(Christian)',
            Other: '(Other)'
            };
            const regionTag = regionMap[region] || '';
            let filtered = {};
            Object.entries(allHolidays).forEach(([date, name]) => {
            if (regionTag && name.includes(regionTag)) {
                filtered[date] = name;
            }
            });
            return filtered;
        }

        // Patch renderCalendar to use filtered holidays
        const origRenderCalendarRegion = renderCalendar;
        renderCalendar = function(year, month) {
            // Use filtered holidays
            window.getUSHolidays = getFilteredHolidays;
            origRenderCalendarRegion(year, month);
            // Restore getUSHolidays for other code if needed
            window.getUSHolidays = getFilteredHolidays;
        };

        holidayRegionShow.onchange = function() {
            localStorage.setItem('holidayRegionShow', holidayRegionShow.value);
            renderCalendar(currentYear, currentMonth);
        };

        // Language selection
        const languageSelect = document.getElementById('languageSelect');
        languageSelect.value = localStorage.getItem('language') || 'en';

        // Simple translations for demonstration
        const translations = {
            en: {
            createEvent: "Create New Event",
            createBirthday: "Create New Birthday",
            createHoliday: "Create New Holiday",
            favorites: "Favorites",
            settings: "Settings",
            backup: "Backup & Restore",
            eventTitle: "Event Title:",
            eventDate: "Event Date:",
            eventTime: "Event Time:",
            eventDescription: "Description:",
            createEventBtn: "Create Event",
            holidayTitle: "Holiday Name:",
            holidayDate: "Date:",
            holidayCountry: "Country/Region:",
            holidayDescription: "Description:",
            createHolidayBtn: "Create Holiday",
            birthdayName: "Name:",
            birthdayDate: "Birthday:",
            birthdayDescription: "Description:",
            createBirthdayBtn: "Create Birthday",
            languageChanged: "Language changed.",
            noEvents: "No events found.",
            noBirthdays: "No birthdays found.",
            noHolidays: "No holidays found.",
            noFavorites: "No favorites yet.",
            backupDownloaded: "Backup downloaded.",
            notificationsEnabled: "Notifications enabled.",
            notificationsDisabled: "Notifications disabled.",
            notificationsDenied: "Notifications denied.",
            addedToFavorites: "Added to favorites!",
            selectModeEnabled: "Select mode enabled. Click dates to select.",
            selectModeDisabled: "Select mode disabled.",
            welcome: "Welcome to Munetios Calendar! So we have great features like it has events, holidays, tasks, etc. The UI is liquid glass and responsive. Do more with Munetios Calendar.",
            noResults: 'No results found for',
            resultsFor: 'Results for',
            tasks: "Tasks",
            calendar: "Calendar",
            allEvents: "All Events",
            birthdays: "Birthdays",
            holidays: "Holidays",
            print: "Print",
            share: "Share",
            favorite: "Favorite",
            close: "Close",
            select: "Select",
            view: "View",
            month: "Month",
            day: "Day",
            week: "Week",
            year: "Year",
            timeline: "Timeline",
            agenda: "Agenda"
            },
            es: {
            createEvent: "Crear nuevo evento",
            createBirthday: "Crear nuevo cumpleaños",
            createHoliday: "Crear nueva festividad",
            favorites: "Favoritos",
            settings: "Configuración",
            backup: "Copia de seguridad y restaurar",
            eventTitle: "Título del evento:",
            eventDate: "Fecha del evento:",
            eventTime: "Hora del evento:",
            eventDescription: "Descripción:",
            createEventBtn: "Crear evento",
            holidayTitle: "Nombre de la festividad:",
            holidayDate: "Fecha:",
            holidayCountry: "País/Región:",
            holidayDescription: "Descripción:",
            createHolidayBtn: "Crear festividad",
            birthdayName: "Nombre:",
            birthdayDate: "Cumpleaños:",
            birthdayDescription: "Descripción:",
            createBirthdayBtn: "Crear cumpleaños",
            languageChanged: "Idioma cambiado.",
            noEvents: "No se encontraron eventos.",
            noBirthdays: "No se encontraron cumpleaños.",
            noHolidays: "No se encontraron festividades.",
            noFavorites: "Sin favoritos aún.",
            backupDownloaded: "Copia de seguridad descargada.",
            notificationsEnabled: "Notificaciones habilitadas.",
            notificationsDisabled: "Notificaciones deshabilitadas.",
            notificationsDenied: "Notificaciones denegadas.",
            addedToFavorites: "¡Añadido a favoritos!",
            selectModeEnabled: "Modo de selección activado. Haz clic en las fechas para seleccionar.",
            selectModeDisabled: "Modo de selección desactivado.",
            welcome: "¡Bienvenido a Munetios Calendar! Tenemos excelentes funciones como eventos, festividades, tareas, etc. La interfaz es moderna y adaptable. Haz más con Munetios Calendar.",
            noResults: 'No se encontraron resultados para',
            resultsFor: 'Resultados para',
            tasks: "Tareas",
            calendar: "Calendario",
            allEvents: "Todos los eventos",
            birthdays: "Cumpleaños",
            holidays: "Festividades",
            print: "Imprimir",
            share: "Compartir",
            favorite: "Favorito",
            close: "Cerrar",
            select: "Seleccionar",
            view: "Vista",
            month: "Mes",
            day: "Día",
            week: "Semana",
            year: "Año",
            timeline: "Cronología",
            agenda: "Agenda"
            },
            fr: {
            createEvent: "Créer un nouvel événement",
            createBirthday: "Créer un nouvel anniversaire",
            createHoliday: "Créer une nouvelle fête",
            favorites: "Favoris",
            settings: "Paramètres",
            backup: "Sauvegarder & Restaurer",
            eventTitle: "Titre de l'événement :",
            eventDate: "Date de l'événement :",
            eventTime: "Heure de l'événement :",
            eventDescription: "Description :",
            createEventBtn: "Créer l'événement",
            holidayTitle: "Nom de la fête :",
            holidayDate: "Date :",
            holidayCountry: "Pays/Région :",
            holidayDescription: "Description :",
            createHolidayBtn: "Créer la fête",
            birthdayName: "Nom :",
            birthdayDate: "Anniversaire :",
            birthdayDescription: "Description :",
            createBirthdayBtn: "Créer l'anniversaire",
            languageChanged: "Langue changée.",
            noEvents: "Aucun événement trouvé.",
            noBirthdays: "Aucun anniversaire trouvé.",
            noHolidays: "Aucune fête trouvée.",
            noFavorites: "Pas encore de favoris.",
            backupDownloaded: "Sauvegarde téléchargée.",
            notificationsEnabled: "Notifications activées.",
            notificationsDisabled: "Notifications désactivées.",
            notificationsDenied: "Notifications refusées.",
            addedToFavorites: "Ajouté aux favoris !",
            selectModeEnabled: "Mode sélection activé. Cliquez sur les dates pour sélectionner.",
            selectModeDisabled: "Mode sélection désactivé.",
            welcome: "Bienvenue sur Munetios Calendar ! Profitez de nombreuses fonctionnalités comme les événements, fêtes, tâches, etc. L'interface est moderne et réactive. Faites plus avec Munetios Calendar.",
            noResults: 'Aucun résultat trouvé pour',
            resultsFor: 'Résultats pour',
            tasks: "Tâches",
            calendar: "Calendrier",
            allEvents: "Tous les événements",
            birthdays: "Anniversaires",
            holidays: "Fêtes",
            print: "Imprimer",
            share: "Partager",
            favorite: "Favori",
            close: "Fermer",
            select: "Sélectionner",
            view: "Vue",
            month: "Mois",
            day: "Jour",
            week: "Semaine",
            year: "Année",
            timeline: "Chronologie",
            agenda: "Agenda"
            },
            de: {
            createEvent: "Neues Ereignis erstellen",
            createBirthday: "Neuen Geburtstag erstellen",
            createHoliday: "Neuen Feiertag erstellen",
            favorites: "Favoriten",
            settings: "Einstellungen",
            backup: "Sichern & Wiederherstellen",
            eventTitle: "Ereignistitel:",
            eventDate: "Ereignisdatum:",
            eventTime: "Ereigniszeit:",
            eventDescription: "Beschreibung:",
            createEventBtn: "Ereignis erstellen",
            holidayTitle: "Feiertagsname:",
            holidayDate: "Datum:",
            holidayCountry: "Land/Region:",
            holidayDescription: "Beschreibung:",
            createHolidayBtn: "Feiertag erstellen",
            birthdayName: "Name:",
            birthdayDate: "Geburtstag:",
            birthdayDescription: "Beschreibung:",
            createBirthdayBtn: "Geburtstag erstellen",
            languageChanged: "Sprache geändert.",
            noEvents: "Keine Ereignisse gefunden.",
            noBirthdays: "Keine Geburtstage gefunden.",
            noHolidays: "Keine Feiertage gefunden.",
            noFavorites: "Noch keine Favoriten.",
            backupDownloaded: "Sicherung heruntergeladen.",
            notificationsEnabled: "Benachrichtigungen aktiviert.",
            notificationsDisabled: "Benachrichtigungen deaktiviert.",
            notificationsDenied: "Benachrichtigungen verweigert.",
            addedToFavorites: "Zu Favoriten hinzugefügt!",
            selectModeEnabled: "Auswahlmodus aktiviert. Klicken Sie auf Daten zur Auswahl.",
            selectModeDisabled: "Auswahlmodus deaktiviert.",
            welcome: "Willkommen bei Munetios Calendar! Viele Funktionen wie Ereignisse, Feiertage, Aufgaben usw. Die Oberfläche ist modern und reaktionsschnell. Machen Sie mehr mit Munetios Calendar.",
            noResults: 'Keine Ergebnisse gefunden für',
            resultsFor: 'Ergebnisse für',
            tasks: "Aufgaben",
            calendar: "Kalender",
            allEvents: "Alle Ereignisse",
            birthdays: "Geburtstage",
            holidays: "Feiertage",
            print: "Drucken",
            share: "Teilen",
            favorite: "Favorit",
            close: "Schließen",
            select: "Auswählen",
            view: "Ansicht",
            month: "Monat",
            day: "Tag",
            week: "Woche",
            year: "Jahr",
            timeline: "Zeitstrahl",
            agenda: "Agenda"
            },
            zh: {
            createEvent: "创建新事件",
            createBirthday: "创建新生日",
            createHoliday: "创建新节日",
            favorites: "收藏夹",
            settings: "设置",
            backup: "备份与恢复",
            eventTitle: "事件标题：",
            eventDate: "事件日期：",
            eventTime: "事件时间：",
            eventDescription: "描述：",
            createEventBtn: "创建事件",
            holidayTitle: "节日名称：",
            holidayDate: "日期：",
            holidayCountry: "国家/地区：",
            holidayDescription: "描述：",
            createHolidayBtn: "创建节日",
            birthdayName: "姓名：",
            birthdayDate: "生日：",
            birthdayDescription: "描述：",
            createBirthdayBtn: "创建生日",
            languageChanged: "语言已更改。",
            noEvents: "未找到事件。",
            noBirthdays: "未找到生日。",
            noHolidays: "未找到节日。",
            noFavorites: "暂无收藏。",
            backupDownloaded: "备份已下载。",
            notificationsEnabled: "通知已启用。",
            notificationsDisabled: "通知已禁用。",
            notificationsDenied: "通知被拒绝。",
            addedToFavorites: "已添加到收藏夹！",
            selectModeEnabled: "选择模式已启用。点击日期进行选择。",
            selectModeDisabled: "选择模式已禁用。",
            welcome: "欢迎使用 Munetios Calendar！拥有事件、节日、任务等强大功能。界面现代且响应式。用 Munetios Calendar 做更多事情。",
            noResults: '未找到相关结果',
            resultsFor: '相关结果',
            tasks: "任务",
            calendar: "日历",
            allEvents: "所有事件",
            birthdays: "生日",
            holidays: "节日",
            print: "打印",
            share: "分享",
            favorite: "收藏",
            close: "关闭",
            select: "选择",
            view: "视图",
            month: "月",
            day: "日",
            week: "周",
            year: "年",
            timeline: "时间线",
            agenda: "日程"
            },
            ja: {
            createEvent: "新しいイベントを作成",
            createBirthday: "新しい誕生日を作成",
            createHoliday: "新しい祝日を作成",
            favorites: "お気に入り",
            settings: "設定",
            backup: "バックアップと復元",
            eventTitle: "イベント名：",
            eventDate: "イベント日：",
            eventTime: "イベント時間：",
            eventDescription: "説明：",
            createEventBtn: "イベントを作成",
            holidayTitle: "祝日名：",
            holidayDate: "日付：",
            holidayCountry: "国/地域：",
            holidayDescription: "説明：",
            createHolidayBtn: "祝日を作成",
            birthdayName: "名前：",
            birthdayDate: "誕生日：",
            birthdayDescription: "説明：",
            createBirthdayBtn: "誕生日を作成",
            languageChanged: "言語が変更されました。",
            noEvents: "イベントが見つかりません。",
            noBirthdays: "誕生日が見つかりません。",
            noHolidays: "祝日が見つかりません。",
            noFavorites: "お気に入りはまだありません。",
            backupDownloaded: "バックアップがダウンロードされました。",
            notificationsEnabled: "通知が有効になりました。",
            notificationsDisabled: "通知が無効になりました。",
            notificationsDenied: "通知が拒否されました。",
            addedToFavorites: "お気に入りに追加しました！",
            selectModeEnabled: "選択モードが有効です。日付をクリックして選択してください。",
            selectModeDisabled: "選択モードが無効です。",
            welcome: "Munetios Calendarへようこそ！イベント、祝日、タスクなどの素晴らしい機能があります。UIはモダンでレスポンシブです。Munetios Calendarでさらに多くのことをしましょう。",
            noResults: '該当する結果がありません',
            resultsFor: '検索結果',
            tasks: "タスク",
            calendar: "カレンダー",
            allEvents: "すべてのイベント",
            birthdays: "誕生日",
            holidays: "祝日",
            print: "印刷",
            share: "共有",
            favorite: "お気に入り",
            close: "閉じる",
            select: "選択",
            view: "ビュー",
            month: "月",
            day: "日",
            week: "週",
            year: "年",
            timeline: "タイムライン",
            agenda: "アジェンダ"
            },
            ru: {
            createEvent: "Создать новое событие",
            createBirthday: "Создать новый день рождения",
            createHoliday: "Создать новый праздник",
            favorites: "Избранное",
            settings: "Настройки",
            backup: "Резервное копирование и восстановление",
            eventTitle: "Название события:",
            eventDate: "Дата события:",
            eventTime: "Время события:",
            eventDescription: "Описание:",
            createEventBtn: "Создать событие",
            holidayTitle: "Название праздника:",
            holidayDate: "Дата:",
            holidayCountry: "Страна/регион:",
            holidayDescription: "Описание:",
            createHolidayBtn: "Создать праздник",
            birthdayName: "Имя:",
            birthdayDate: "День рождения:",
            birthdayDescription: "Описание:",
            createBirthdayBtn: "Создать день рождения",
            languageChanged: "Язык изменен.",
            noEvents: "События не найдены.",
            noBirthdays: "Дни рождения не найдены.",
            noHolidays: "Праздники не найдены.",
            noFavorites: "Нет избранного.",
            backupDownloaded: "Резервная копия загружена.",
            notificationsEnabled: "Уведомления включены.",
            notificationsDisabled: "Уведомления отключены.",
            notificationsDenied: "Уведомления отклонены.",
            addedToFavorites: "Добавлено в избранное!",
            selectModeEnabled: "Режим выбора включен. Нажмите на даты для выбора.",
            selectModeDisabled: "Режим выбора отключен.",
            welcome: "Добро пожаловать в Munetios Calendar! Много функций: события, праздники, задачи и др. Интерфейс современный и адаптивный. Делайте больше с Munetios Calendar.",
            noResults: 'Нет результатов для',
            resultsFor: 'Результаты для',
            tasks: "Задачи",
            calendar: "Календарь",
            allEvents: "Все события",
            birthdays: "Дни рождения",
            holidays: "Праздники",
            print: "Печать",
            share: "Поделиться",
            favorite: "Избранное",
            close: "Закрыть",
            select: "Выбрать",
            view: "Вид",
            month: "Месяц",
            day: "День",
            week: "Неделя",
            year: "Год",
            timeline: "Хронология",
            agenda: "Повестка дня"
            },
            ar: {
            createEvent: "إنشاء حدث جديد",
            createBirthday: "إنشاء عيد ميلاد جديد",
            createHoliday: "إنشاء عطلة جديدة",
            favorites: "المفضلة",
            settings: "الإعدادات",
            backup: "نسخ احتياطي واستعادة",
            eventTitle: "عنوان الحدث:",
            eventDate: "تاريخ الحدث:",
            eventTime: "وقت الحدث:",
            eventDescription: "الوصف:",
            createEventBtn: "إنشاء الحدث",
            holidayTitle: "اسم العطلة:",
            holidayDate: "التاريخ:",
            holidayCountry: "الدولة/المنطقة:",
            holidayDescription: "الوصف:",
            createHolidayBtn: "إنشاء عطلة",
            birthdayName: "الاسم:",
            birthdayDate: "عيد الميلاد:",
            birthdayDescription: "الوصف:",
            createBirthdayBtn: "إنشاء عيد ميلاد",
            languageChanged: "تم تغيير اللغة.",
            noEvents: "لم يتم العثور على أحداث.",
            noBirthdays: "لم يتم العثور على أعياد ميلاد.",
            noHolidays: "لم يتم العثور على عطلات.",
            noFavorites: "لا توجد مفضلات بعد.",
            backupDownloaded: "تم تنزيل النسخة الاحتياطية.",
            notificationsEnabled: "تم تفعيل الإشعارات.",
            notificationsDisabled: "تم تعطيل الإشعارات.",
            notificationsDenied: "تم رفض الإشعارات.",
            addedToFavorites: "تمت الإضافة إلى المفضلة!",
            selectModeEnabled: "تم تفعيل وضع التحديد. انقر على التواريخ للتحديد.",
            selectModeDisabled: "تم تعطيل وضع التحديد.",
            welcome: "مرحبًا بك في Munetios Calendar! ميزات رائعة مثل الأحداث والعطلات والمهام وغيرها. واجهة حديثة وسريعة الاستجابة. افعل المزيد مع Munetios Calendar.",
            noResults: 'لم يتم العثور على نتائج لـ',
            resultsFor: 'النتائج لـ',
            tasks: "المهام",
            calendar: "التقويم",
            allEvents: "جميع الأحداث",
            birthdays: "أعياد الميلاد",
            holidays: "العطلات",
            print: "طباعة",
            share: "مشاركة",
            favorite: "مفضلة",
            close: "إغلاق",
            select: "تحديد",
            view: "عرض",
            month: "شهر",
            day: "يوم",
            week: "أسبوع",
            year: "سنة",
            timeline: "الجدول الزمني",
            agenda: "جدول الأعمال"
            },
            hi: {
            createEvent: "नया इवेंट बनाएं",
            createBirthday: "नया जन्मदिन बनाएं",
            createHoliday: "नई छुट्टी बनाएं",
            favorites: "पसंदीदा",
            settings: "सेटिंग्स",
            backup: "बैकअप और पुनर्स्थापना",
            eventTitle: "इवेंट शीर्षक:",
            eventDate: "इवेंट तिथि:",
            eventTime: "इवेंट समय:",
            eventDescription: "विवरण:",
            createEventBtn: "इवेंट बनाएं",
            holidayTitle: "छुट्टी का नाम:",
            holidayDate: "तिथि:",
            holidayCountry: "देश/क्षेत्र:",
            holidayDescription: "विवरण:",
            createHolidayBtn: "छुट्टी बनाएं",
            birthdayName: "नाम:",
            birthdayDate: "जन्मदिन:",
            birthdayDescription: "विवरण:",
            createBirthdayBtn: "जन्मदिन बनाएं",
            languageChanged: "भाषा बदल गई।",
            noEvents: "कोई इवेंट नहीं मिला।",
            noBirthdays: "कोई जन्मदिन नहीं मिला।",
            noHolidays: "कोई छुट्टियाँ नहीं मिलीं।",
            noFavorites: "अभी तक कोई पसंदीदा नहीं।",
            backupDownloaded: "बैकअप डाउनलोड किया गया।",
            notificationsEnabled: "सूचनाएँ सक्षम की गईं।",
            notificationsDisabled: "सूचनाएँ अक्षम की गईं।",
            notificationsDenied: "सूचनाएँ अस्वीकृत की गईं।",
            addedToFavorites: "पसंदीदा में जोड़ा गया!",
            selectModeEnabled: "चयन मोड सक्षम है। चयन के लिए तिथियों पर क्लिक करें।",
            selectModeDisabled: "चयन मोड अक्षम है।",
            welcome: "Munetios Calendar में आपका स्वागत है! इवेंट, छुट्टियाँ, कार्य आदि जैसी शानदार सुविधाएँ। UI आधुनिक और उत्तरदायी है। Munetios Calendar के साथ और अधिक करें।",
            noResults: 'के लिए कोई परिणाम नहीं मिला',
            resultsFor: 'के लिए परिणाम',
            tasks: "कार्य",
            calendar: "कैलेंडर",
            allEvents: "सभी इवेंट",
            birthdays: "जन्मदिन",
            holidays: "छुट्टियाँ",
            print: "प्रिंट",
            share: "साझा करें",
            favorite: "पसंदीदा",
            close: "बंद करें",
            select: "चयन करें",
            view: "दृश्य",
            month: "महीना",
            day: "दिन",
            week: "सप्ताह",
            year: "वर्ष",
            timeline: "समयरेखा",
            agenda: "एजेंडा"
            },
                pt: {
                createEvent: "Criar novo evento",
                createBirthday: "Criar novo aniversário",
                createHoliday: "Criar novo feriado",
                favorites: "Favoritos",
                settings: "Configurações",
                backup: "Backup & Restaurar",
                eventTitle: "Título do evento:",
                eventDate: "Data do evento:",
                eventTime: "Hora do evento:",
                eventDescription: "Descrição:",
                createEventBtn: "Criar evento",
                holidayTitle: "Nome do feriado:",
                holidayDate: "Data:",
                holidayCountry: "País/Região:",
                holidayDescription: "Descrição:",
                createHolidayBtn: "Criar feriado",
                birthdayName: "Nome:",
                birthdayDate: "Aniversário:",
                birthdayDescription: "Descrição:",
                createBirthdayBtn: "Criar aniversário",
                languageChanged: "Idioma alterado.",
                noEvents: "Nenhum evento encontrado.",
                noBirthdays: "Nenhum aniversário encontrado.",
                noHolidays: "Nenhum feriado encontrado.",
                noFavorites: "Nenhum favorito ainda.",
                backupDownloaded: "Backup baixado.",
                notificationsEnabled: "Notificações ativadas.",
                notificationsDisabled: "Notificações desativadas.",
                notificationsDenied: "Notificações negadas.",
                addedToFavorites: "Adicionado aos favoritos!",
                selectModeEnabled: "Modo de seleção ativado. Clique nas datas para selecionar.",
                selectModeDisabled: "Modo de seleção desativado.",
                welcome: "Bem-vindo ao Munetios Calendar! Muitos recursos como eventos, feriados, tarefas, etc. Interface moderna e responsiva. Faça mais com Munetios Calendar.",
                noResults: 'Nenhum resultado encontrado para',
                resultsFor: 'Resultados para',
                tasks: "Tarefas",
                calendar: "Calendário",
                allEvents: "Todos os eventos",
                birthdays: "Aniversários",
                holidays: "Feriados",
                print: "Imprimir",
                share: "Compartilhar",
                favorite: "Favorito",
                close: "Fechar",
                select: "Selecionar",
                view: "Visualizar",
                month: "Mês",
                day: "Dia",
                week: "Semana",
                year: "Ano",
                timeline: "Linha do tempo",
                agenda: "Agenda"
                },
            }
            function applyTranslations(lang) {
                const t = translations[lang] || translations['en'];
                // Modal titles and buttons
                document.querySelector('#createEventModal h2').textContent = t.createEvent;
                document.querySelector('#createBirthdayModal h2').textContent = t.createBirthday;
                document.querySelector('#createHolidayModal h2').textContent = t.createHoliday;
                document.querySelector('#favoritesModal h2').textContent = t.favorites;
                document.querySelector('#settingsModal h2').textContent = t.settings;
                document.querySelector('.settings-content .btn').textContent = t.backup;

                // Event form labels and button
                document.querySelector('#eventForm label[for="eventTitle"]').textContent = t.eventTitle;
                document.querySelector('#eventForm label[for="eventDate"]').textContent = t.eventDate;
                document.querySelector('#eventForm label[for="eventTime"]').textContent = t.eventTime;
                document.querySelector('#eventForm label[for="eventDescription"]').textContent = t.eventDescription;
                document.querySelector('#eventForm button[type="submit"]').textContent = t.createEventBtn;

                // Birthday form labels and button
                document.querySelector('#birthdayForm label[for="birthdayName"]').textContent = t.birthdayName;
                document.querySelector('#birthdayForm label[for="birthdayDate"]').textContent = t.birthdayDate;
                document.querySelector('#birthdayForm label[for="birthdayDescription"]').textContent = t.birthdayDescription;
                document.querySelector('#birthdayForm button[type="submit"]').textContent = t.createBirthdayBtn;

                // Holiday form labels and button
                document.querySelector('#holidayForm label[for="holidayTitle"]').textContent = t.holidayTitle;
                document.querySelector('#holidayForm label[for="holidayDate"]').textContent = t.holidayDate;
                document.querySelector('#holidayForm label[for="holidayCountry"]').textContent = t.holidayCountry;
                document.querySelector('#holidayForm label[for="holidayDescription"]').textContent = t.holidayDescription;
                document.querySelector('#holidayForm button[type="submit"]').textContent = t.createHolidayBtn;

                // Settings modal labels
                document.querySelector('#settingsModal label[for="reduceTransparencyCheckbox"]').textContent = t.reduceTransparencyCheckbox || "Reduce Transparency";
                document.querySelector('#settingsModal label[for="notificationsCheckbox"]').textContent = t.notificationsCheckbox || "Enable Desktop Notifications";
                document.querySelector('#settingsModal label').textContent = t.settings;

                // Tabs
                document.querySelectorAll('.tabs .tab')[0].textContent = t.calendar;
                document.querySelectorAll('.tabs .tab')[1].textContent = t.tasks;

                // Events modal tabs
                document.getElementById('allEventsTab').textContent = t.allEvents;
                document.getElementById('birthdaysTab').textContent = t.birthdays;
                document.getElementById('holidaysTab').textContent = t.holidays;

                // Agenda/timeline/year view headers (if present)
                // You can add more translations for other UI elements as needed
            }

        languageSelect.onchange = function() {
            localStorage.setItem('language', languageSelect.value);
            applyTranslations(languageSelect.value);
            showToast('Language changed.');
        };

        // Apply translations on page load
        applyTranslations(languageSelect.value);

        // Notifications
        const notificationsCheckbox = document.getElementById('notificationsCheckbox');
        notificationsCheckbox.checked = localStorage.getItem('notificationsEnabled') === 'true';
        notificationsCheckbox.onchange = function() {
            localStorage.setItem('notificationsEnabled', notificationsCheckbox.checked);
            if (notificationsCheckbox.checked && Notification && Notification.permission !== 'granted') {
                Notification.requestPermission().then(function(permission) {
                    if (permission === 'granted') {
                        showToast('Notifications enabled.');
                    } else {
                        showToast('Notifications denied.');
                        notificationsCheckbox.checked = false;
                        localStorage.setItem('notificationsEnabled', 'false');
                    }
                });
            } else {
                showToast(notificationsCheckbox.checked ? 'Notifications enabled.' : 'Notifications disabled.');
            }
        };

        // Desktop notifications for events
        // Store notified event ids in localStorage to persist across reloads
        function getNotifiedEventIds() {
            try {
                return JSON.parse(localStorage.getItem('notifiedEventIds') || '[]');
            } catch {
                return [];
            }
        }
        function setNotifiedEventIds(ids) {
            localStorage.setItem('notifiedEventIds', JSON.stringify(ids));
        }

        function checkEventNotifications() {
            if (!('Notification' in window)) return;
            if (localStorage.getItem('notificationsEnabled') !== 'true') return;
            if (Notification.permission !== 'granted') return;

            const now = new Date();
            const nowStr = now.toISOString().slice(0,16); // yyyy-mm-ddThh:mm
            let notifiedIds = getNotifiedEventIds();

            events.forEach(ev => {
                if (!ev.date || !ev.time) return;
                // Only notify for events today and at the current minute
                const eventDateTime = `${ev.date}T${ev.time}`;
                const eventTime = new Date(eventDateTime);

                // Only notify if event is within the next minute and not already notified
                if (
                    Math.abs(eventTime.getTime() - now.getTime()) < 60000 &&
                    !notifiedIds.includes(ev.id)
                ) {
                    // Show notification
                    new Notification(ev.title || 'Munetios Calendar Event', {
                        body: (ev.desc ? ev.desc + '\n' : '') + `Time: ${ev.time}`,
                        icon: 'logo.png'
                    });
                    notifiedIds.push(ev.id);
                }
            });
            setNotifiedEventIds(notifiedIds);
        }
        // Check every 30 seconds
        setInterval(checkEventNotifications, 30000);

        // Backup & Restore Modal (functional, uses existing modal in HTML)
        // Show modal when clicking Backup & Restore button
        document.getElementById('backupRestoreBtn').onclick = function(e) {
            e.stopPropagation();
            document.getElementById('backupStatus').textContent = '';
            document.getElementById('backupModal').style.display = 'flex';
        };

        // Close modal
        document.getElementById('closeBackupModal').onclick = function() {
            document.getElementById('backupModal').style.display = 'none';
        };

        // Backup (Export)
        document.getElementById('backupBtn').onclick = function() {
            // Export as { events: [...] }
            let backupData = JSON.stringify({ events }, null, 2);
            let blob = new Blob([backupData], {type: 'application/json'});
            let url = URL.createObjectURL(blob);
            let a = document.createElement('a');
            a.href = url;
            a.download = 'munetios-calendar-backup.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            setTimeout(() => URL.revokeObjectURL(url), 1000);
            document.getElementById('backupStatus').textContent = 'Backup downloaded.';
            showToast('Backup downloaded.');
        };

        // Restore (Import) - supports any .json file with either array or {events:[]}
        document.getElementById('restoreBtn').onclick = function() {
            document.getElementById('restoreInput').value = '';
            document.getElementById('restoreInput').click();
        };
        document.getElementById('restoreInput').onchange = function(e) {
            const file = e.target.files[0];
            if (!file || !file.name.endsWith('.json')) {
            document.getElementById('backupStatus').textContent = 'Please select a .json file.';
            showToast('Please select a .json file.');
            return;
            }
            const reader = new FileReader();
            reader.onload = async function(ev) {
            try {
                let imported = JSON.parse(ev.target.result);
                // Accept either array or {events: [...]}
                if (Array.isArray(imported)) {
                imported = imported;
                } else if (imported && Array.isArray(imported.events)) {
                imported = imported.events;
                } else {
                throw new Error('Invalid backup format');
                }
                // Clear existing events and import
                const transaction = db.transaction(['events'], 'readwrite');
                const store = transaction.objectStore('events');
                store.clear().onsuccess = async function() {
                for (const event of imported) {
                    await new Promise(res => store.add(event).onsuccess = res);
                }
                await loadEvents();
                renderCalendar(currentYear, currentMonth);
                document.getElementById('backupStatus').textContent = 'Backup imported.';
                showToast('Backup imported.');
                };
            } catch (err) {
                document.getElementById('backupStatus').textContent = 'Import failed: Invalid file.';
                showToast('Import failed: Invalid file.');
            }
            };
            reader.readAsText(file);
        };



        // Help modal logic
        // Create help modal if not already present
        if (!document.getElementById('helpModal')) {
            const helpModal = document.createElement('div');
            helpModal.className = 'modal';
            helpModal.id = 'helpModal';
            helpModal.innerHTML = `
                <div class="modal-content liquid-glass" style="max-width: 480px;">
                    <span class="close" id="closeHelpModal" style="right:18px;top:18px;">&times;</span>
                    <h2 style="text-align:center;color:#a770ef;">Help &amp; About</h2>
                    <div style="margin:18px 0 24px 0;line-height:1.6;font-size:1.08em;color:#fff;">
                        <b>Munetios Calendar</b> is a modern, user-friendly calendar application designed to help you manage your schedule with ease.<br><br>
                        <b>Features:</b>
                        <ul style="margin:10px 0 18px 18px; color:#e0e0e0;">
                            <li>Events, holidays, birthdays (birthdays repeat every year)</li>
                            <li>Tasks integration</li>
                            <li>Liquid glass UI, fully responsive</li>
                            <li>Apps menu for quick access to Munetios apps</li>
                            <li>Backup &amp; restore, favorites, search, and more</li>
                        </ul>
                        <b>Need help?</b> Contact <a href="mailto:minecraftgamer97529@gmail.com" style="color:#a770ef;">minecraftgamer97529@gmail.com</a>
                    </div>
                    <div style="margin-top:18px;padding-top:12px;border-top:1px solid rgba(167,112,239,0.18);font-size:0.98em;color:#a770ef;">
                        <b>Version History</b>
                        <ul style="margin:8px 0 0 18px; color:#e0e0e0;">

                            <li><b>1.02</b> – New apps menu and made birthdays repeat in year</li>
                            <li><b>1.01</b> – Bug fixes and improvements</li>
                            <li><b>1.00</b> – Released</li>
                        </ul>
                    </div>
                </div>
            `;
            document.body.appendChild(helpModal);
            document.getElementById('closeHelpModal').onclick = function() {
                helpModal.style.display = 'none';
            };
        }

        // Show help modal on help icon click
        document.querySelector('.help-icon').addEventListener('click', function(e) {
            e.stopPropagation();
            document.getElementById('helpModal').style.display = 'flex';
        });

        // Events icon click: open events modal and show all events tab
        document.querySelector('.events-icon').addEventListener('click', function(e) {
            document.getElementById('eventsList').style.display = 'flex';
            showEventsTab('all');
            e.stopPropagation();
        });

        function showEventsTab(tab) {
            document.getElementById('allEventsContent').style.display = tab === 'all' ? 'block' : 'none';
            document.getElementById('birthdaysContent').style.display = tab === 'birthdays' ? 'block' : 'none';
            document.getElementById('holidaysContent').style.display = tab === 'holidays' ? 'block' : 'none';
            if (tab === 'all') renderAllEventsList();
            if (tab === 'birthdays') renderBirthdaysList();
            if (tab === 'holidays') renderHolidaysList();
        }
        document.getElementById('allEventsTab').onclick = function() { showEventsTab('all'); };
        document.getElementById('birthdaysTab').onclick = function() { showEventsTab('birthdays'); };
        document.getElementById('holidaysTab').onclick = function() { showEventsTab('holidays'); };

        // --- Edit/Delete Modal ---
        // Create modal for editing/deleting events
        let editEventModal = document.createElement('div');
        editEventModal.className = 'modal';
        editEventModal.id = 'editEventModal';
        editEventModal.innerHTML = `
            <div class="modal-content liquid-glass">
            <span class="close" id="closeEditEventModal">&times;</span>
            <h2>Edit Event</h2>
            <form id="editEventForm">
                <div id="editEventFields"></div>
                <button type="submit" class="btn">Save Changes</button>
                <button type="button" class="btn" id="deleteEventBtn" style="background:#e74c3c;margin-top:10px;">Delete</button>
            </form>
            </div>
        `;
        document.body.appendChild(editEventModal);

        document.getElementById('closeEditEventModal').onclick = function() {
            editEventModal.style.display = 'none';
        };

        let editingEventId = null;

        // Render event fields for edit modal
        function renderEditEventFields(ev) {
            const fields = document.getElementById('editEventFields');
            fields.innerHTML = '';
            if (ev.type === 'event') {
            fields.innerHTML = `
                <label for="editEventTitle">Title:</label>
                <input type="text" id="editEventTitle" value="${ev.title || ''}" required>
                <label for="editEventDate">Date:</label>
                <input type="date" id="editEventDate" value="${ev.date || ''}" required>
                <label for="editEventTime">Time:</label>
                <input type="time" id="editEventTime" value="${ev.time || ''}">
                <label for="editEventDesc">Description:</label>
                <textarea id="editEventDesc">${ev.desc || ''}</textarea>
            `;
            } else if (ev.type === 'birthday') {
            fields.innerHTML = `
                <label for="editBirthdayName">Name:</label>
                <input type="text" id="editBirthdayName" value="${ev.name || ''}" required>
                <label for="editBirthdayDate">Birthday:</label>
                <input type="date" id="editBirthdayDate" value="${ev.date || ''}" required>
                <label for="editBirthdayDesc">Description:</label>
                <textarea id="editBirthdayDesc">${ev.desc || ''}</textarea>
            `;
            } else if (ev.type === 'holiday') {
            fields.innerHTML = `
                <label for="editHolidayTitle">Title:</label>
                <input type="text" id="editHolidayTitle" value="${ev.title || ''}" required>
                <label for="editHolidayDate">Date:</label>
                <input type="date" id="editHolidayDate" value="${ev.date || ''}" required>
                <label for="editHolidayCountry">Country/Region:</label>
                <input type="text" id="editHolidayCountry" value="${ev.country || ''}" required>
                <label for="editHolidayDesc">Description:</label>
                <textarea id="editHolidayDesc">${ev.desc || ''}</textarea>
            `;
            }
        }

        // Save changes to event
        document.getElementById('editEventForm').onsubmit = async function(e) {
            e.preventDefault();
            if (editingEventId == null) return;
            let ev = events.find(ev => ev.id === editingEventId);
            if (!ev) return;
            let updated;
            if (ev.type === 'event') {
            updated = {
                ...ev,
                title: document.getElementById('editEventTitle').value.trim(),
                date: document.getElementById('editEventDate').value,
                time: document.getElementById('editEventTime').value,
                desc: document.getElementById('editEventDesc').value.trim()
            };
            } else if (ev.type === 'birthday') {
            updated = {
                ...ev,
                name: document.getElementById('editBirthdayName').value.trim(),
                date: document.getElementById('editBirthdayDate').value,
                desc: document.getElementById('editBirthdayDesc').value.trim()
            };
            } else if (ev.type === 'holiday') {
            updated = {
                ...ev,
                title: document.getElementById('editHolidayTitle').value.trim(),
                date: document.getElementById('editHolidayDate').value,
                country: document.getElementById('editHolidayCountry').value.trim(),
                desc: document.getElementById('editHolidayDesc').value.trim()
            };
            }
            // Update in IndexedDB
            const transaction = db.transaction(['events'], 'readwrite');
            const store = transaction.objectStore('events');
            store.put(updated).onsuccess = async function() {
            await loadEvents();
            renderAllEventsList();
            renderBirthdaysList();
            renderHolidaysList();
            renderCalendar(currentYear, currentMonth);
            editEventModal.style.display = 'none';
            showToast('Event updated.');
            };
        };

        // Delete event
        document.getElementById('deleteEventBtn').onclick = function() {
            if (editingEventId == null) return;
            // Show confirmation modal
            showDeleteConfirmModal(editingEventId);
        };

        // --- Delete Confirm Modal ---
        let deleteConfirmModal = document.createElement('div');
        deleteConfirmModal.className = 'modal';
        deleteConfirmModal.id = 'deleteConfirmModal';
        deleteConfirmModal.innerHTML = `
            <div class="modal-content liquid-glass">
            <span class="close" id="closeDeleteConfirmModal">&times;</span>
            <h2>Delete Event</h2>
            <p>Are you sure you want to delete this event?</p>
            <button class="btn" id="confirmDeleteBtn" style="background:#e74c3c;">Delete</button>
            <button class="btn" id="cancelDeleteBtn" style="margin-left:10px;">Cancel</button>
            </div>
        `;
        document.body.appendChild(deleteConfirmModal);

        document.getElementById('closeDeleteConfirmModal').onclick = function() {
            deleteConfirmModal.style.display = 'none';
        };
        document.getElementById('cancelDeleteBtn').onclick = function() {
            deleteConfirmModal.style.display = 'none';
        };

        let deleteEventId = null;
        function showDeleteConfirmModal(eventId) {
            deleteEventId = eventId;
            deleteConfirmModal.style.display = 'flex';
        }

        document.getElementById('confirmDeleteBtn').onclick = async function() {
            if (deleteEventId == null) return;
            const transaction = db.transaction(['events'], 'readwrite');
            const store = transaction.objectStore('events');
            store.delete(deleteEventId).onsuccess = async function() {
            await loadEvents();
            renderAllEventsList();
            renderBirthdaysList();
            renderHolidaysList();
            renderCalendar(currentYear, currentMonth);
            deleteConfirmModal.style.display = 'none';
            editEventModal.style.display = 'none';
            showToast('Event deleted.');
            };
        };

        // --- Render All Events List with Edit/Delete ---
        function renderAllEventsList() {
            const list = document.getElementById('allEventsList');
            list.innerHTML = '';
            if (!events.length) {
            list.innerHTML = '<li>No events found.</li>';
            return;
            }
            events.forEach(ev => {
            let li = document.createElement('li');
            li.style.padding = '8px 0';
            li.style.borderBottom = '1px solid rgba(167,112,239,0.09)';
            let text = '';
            if (ev.type === 'birthday') {
                text = `🎂 ${ev.name}'s Birthday (${ev.date})${ev.desc ? ' - ' + ev.desc : ''}`;
            } else if (ev.type === 'holiday') {
                text = `${ev.title} (${ev.country}) (${ev.date})${ev.desc ? ' - ' + ev.desc : ''}`;
            } else if (ev.type === 'event') {
                let timeStr = '';
                if (ev.time) {
                let [h, m] = ev.time.split(':');
                h = parseInt(h, 10);
                let ampm = h < 12 ? 'AM' : 'PM';
                let hour12 = h % 12 === 0 ? 12 : h % 12;
                timeStr = ` at ${hour12}:${m} ${ampm}`;
                }
                text = `${ev.title} (${ev.date})${timeStr}${ev.desc ? ' - ' + ev.desc : ''}`;
            }
            li.textContent = text;

            // Add edit button
            let editBtn = document.createElement('button');
            editBtn.textContent = 'Edit';
            editBtn.className = 'btn';
            editBtn.style.marginLeft = '10px';
            editBtn.style.padding = '4px 12px';
            editBtn.style.fontSize = '0.9em';
            editBtn.onclick = function(e) {
                editingEventId = ev.id;
                renderEditEventFields(ev);
                editEventModal.style.display = 'flex';
                e.stopPropagation();
            };
            li.appendChild(editBtn);

            // Add delete button
            let deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Delete';
            deleteBtn.className = 'btn';
            deleteBtn.style.marginLeft = '6px';
            deleteBtn.style.background = '#e74c3c';
            deleteBtn.style.color = '#fff';
            deleteBtn.style.padding = '4px 12px';
            deleteBtn.style.fontSize = '0.9em';
            deleteBtn.onclick = function(e) {
                editingEventId = ev.id;
                showDeleteConfirmModal(ev.id);
                e.stopPropagation();
            };
            li.appendChild(deleteBtn);

            list.appendChild(li);
            });
        }
        // Render birthdays list
        function renderBirthdaysList() {
            const list = document.getElementById('birthdaysList');
            list.innerHTML = '';
            const birthdays = events.filter(ev => ev.type === 'birthday');
            if (!birthdays.length) {
            list.innerHTML = '<li>No birthdays found.</li>';
            return;
            }
            birthdays.forEach(ev => {
            let li = document.createElement('li');
            li.style.padding = '8px 0';
            li.style.borderBottom = '1px solid rgba(167,112,239,0.09)';
            li.textContent = `🎂 ${ev.name}'s Birthday (${ev.date})${ev.desc ? ' - ' + ev.desc : ''}`;

            // Edit button
            let editBtn = document.createElement('button');
            editBtn.textContent = 'Edit';
            editBtn.className = 'btn';
            editBtn.style.marginLeft = '10px';
            editBtn.style.padding = '4px 12px';
            editBtn.style.fontSize = '0.9em';
            editBtn.onclick = function(e) {
                editingEventId = ev.id;
                renderEditEventFields(ev);
                editEventModal.style.display = 'flex';
                e.stopPropagation();
            };
            li.appendChild(editBtn);

            // Delete button
            let deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Delete';
            deleteBtn.className = 'btn';
            deleteBtn.style.marginLeft = '6px';
            deleteBtn.style.background = '#e74c3c';
            deleteBtn.style.color = '#fff';
            deleteBtn.style.padding = '4px 12px';
            deleteBtn.style.fontSize = '0.9em';
            deleteBtn.onclick = function(e) {
                editingEventId = ev.id;
                showDeleteConfirmModal(ev.id);
                e.stopPropagation();
            };
            li.appendChild(deleteBtn);

            list.appendChild(li);
            });
        }

        // Render holidays list
        function renderHolidaysList() {
            const list = document.getElementById('holidaysList');
            list.innerHTML = '';
            const holidays = events.filter(ev => ev.type === 'holiday');
            if (!holidays.length) {
            list.innerHTML = '<li>No holidays found.</li>';
            return;
            }
            holidays.forEach(ev => {
            let li = document.createElement('li');
            li.style.padding = '8px 0';
            li.style.borderBottom = '1px solid rgba(167,112,239,0.09)';
            li.textContent = `${ev.title} (${ev.country}) (${ev.date})${ev.desc ? ' - ' + ev.desc : ''}`;

            // Edit button
            let editBtn = document.createElement('button');
            editBtn.textContent = 'Edit';
            editBtn.className = 'btn';
            editBtn.style.marginLeft = '10px';
            editBtn.style.padding = '4px 12px';
            editBtn.style.fontSize = '0.9em';
            editBtn.onclick = function(e) {
                editingEventId = ev.id;
                renderEditEventFields(ev);
                editEventModal.style.display = 'flex';
                e.stopPropagation();
            };
            li.appendChild(editBtn);

            // Delete button
            let deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Delete';
            deleteBtn.className = 'btn';
            deleteBtn.style.marginLeft = '6px';
            deleteBtn.style.background = '#e74c3c';
            deleteBtn.style.color = '#fff';
            deleteBtn.style.padding = '4px 12px';
            deleteBtn.style.fontSize = '0.9em';
            deleteBtn.onclick = function(e) {
                editingEventId = ev.id;
                showDeleteConfirmModal(ev.id);
                e.stopPropagation();
            };
            li.appendChild(deleteBtn);

            list.appendChild(li);
            });
        }

        // Close events modal
        document.getElementById('closeEventsList').onclick = function() {
            document.getElementById('eventsList').style.display = 'none';
        };

        document.querySelectorAll('.tab').forEach((tabBtn, idx) => {
            tabBtn.addEventListener('click', function() {
                if (tabBtn.textContent.trim() === 'Tasks') {
                    document.querySelector('.calendar-content').style.display = 'none';
                    document.querySelector('.tasks-content').style.display = 'block';
                    window.location.hash = '#/tasks';
                } else {
                    document.querySelector('.calendar-content').style.display = 'block';
                    document.querySelector('.tasks-content').style.display = 'none';
                    window.location.hash = '';
                }
            });
        });

        // On page load, show tasks if hash is #/tasks
        if (window.location.hash === '#/tasks') {
            document.querySelector('.calendar-content').style.display = 'none';
            document.querySelector('.tasks-content').style.display = 'block';
        }



        /* --- Search Bar Functionality --- */

        // Create search results wrapper
        const searchResultsWrapper = document.createElement('div');
        searchResultsWrapper.id = 'searchResultsWrapper';
        searchResultsWrapper.style.position = 'absolute';
        searchResultsWrapper.style.top = '70px';
        searchResultsWrapper.style.left = '50%';
        searchResultsWrapper.style.transform = 'translateX(-50%)';
        searchResultsWrapper.style.background = 'linear-gradient(135deg, rgba(255,255,255,0.22) 0%, rgba(167,112,239,0.13) 100%)';
        searchResultsWrapper.style.borderRadius = '24px';
        searchResultsWrapper.style.boxShadow = '0 8px 32px 0 rgba(167,112,239,0.18), 0 1.5px 8px 0 rgba(255,255,255,0.12) inset';
        searchResultsWrapper.style.border = '1.5px solid rgba(167,112,239,0.28)';
        searchResultsWrapper.style.zIndex = '2000';
        searchResultsWrapper.style.padding = '18px 22px';
        searchResultsWrapper.style.minWidth = '320px';
        searchResultsWrapper.style.maxWidth = '670px';
        searchResultsWrapper.style.maxHeight = '60vh';
        searchResultsWrapper.style.overflowY = 'auto';
        searchResultsWrapper.style.display = 'none';
        document.body.appendChild(searchResultsWrapper);

        // Mobile search overlay
        const mobileSearchOverlay = document.createElement('div');
        mobileSearchOverlay.id = 'mobileSearchOverlay';
        mobileSearchOverlay.style.position = 'fixed';
        mobileSearchOverlay.style.top = '0';
        mobileSearchOverlay.style.left = '0';
        mobileSearchOverlay.style.width = '100vw';
        mobileSearchOverlay.style.height = '100vh';
        mobileSearchOverlay.style.background = 'rgba(39, 14, 51, 0.85)';
        mobileSearchOverlay.style.backdropFilter = 'blur(4px)';
        mobileSearchOverlay.style.zIndex = '3000';
        mobileSearchOverlay.style.display = 'none';
        mobileSearchOverlay.style.justifyContent = 'center';
        mobileSearchOverlay.style.alignItems = 'flex-start';
        mobileSearchOverlay.innerHTML = `
            <div style="width:100%;max-width:98vw;padding:24px 12px;">
                <div style="display:flex;align-items:center;gap:10px;">
                    <input type="text" id="mobileSearchInput" placeholder="Search events, birthdays and more" style="flex:1;padding:14px 18px;border-radius:18px;border:none;background:rgba(255,255,255,0.09);color:#fff;font-size:1.1em;">
                    <button id="closeMobileSearchBtn" style="background:#a770ef;color:#fff;border:none;border-radius:18px;padding:10px 18px;font-weight:bold;cursor:pointer;">Close</button>
                </div>
                <div id="mobileSearchResults" style="margin-top:18px;max-height:60vh;overflow-y:auto;"></div>
            </div>
        `;
        document.body.appendChild(mobileSearchOverlay);

        // Search logic
        function searchCalendar(query) {
            query = query.trim().toLowerCase();
            if (!query) return [];
            let results = [];

            // Search holidays
            const holidays = getHolidays(currentYear);
            Object.entries(holidays).forEach(([date, title]) => {
                if (title.toLowerCase().includes(query) || date.includes(query)) {
                    results.push({
                        type: 'holiday',
                        title,
                        date
                    });
                }
            });

            // Search events/birthdays/holidays in IndexedDB
            events.forEach(ev => {
                if (ev.type === 'event' && (ev.title.toLowerCase().includes(query) || (ev.desc && ev.desc.toLowerCase().includes(query)) || ev.date.includes(query))) {
                    results.push({
                        type: 'event',
                        title: ev.title,
                        date: ev.date,
                        time: ev.time,
                        desc: ev.desc
                    });
                } else if (ev.type === 'birthday' && (ev.name.toLowerCase().includes(query) || (ev.desc && ev.desc.toLowerCase().includes(query)) || ev.date.includes(query))) {
                    results.push({
                        type: 'birthday',
                        name: ev.name,
                        date: ev.date,
                        desc: ev.desc
                    });
                } else if (ev.type === 'holiday' && (ev.title.toLowerCase().includes(query) || (ev.desc && ev.desc.toLowerCase().includes(query)) || ev.date.includes(query))) {
                    results.push({
                        type: 'holiday',
                        title: ev.title,
                        date: ev.date,
                        country: ev.country,
                        desc: ev.desc
                    });
                }
            });

            return results;
        }

        // Render search results (desktop)
        function renderSearchResults(results, query) {
            if (!results.length) {
                searchResultsWrapper.innerHTML = `<div style="color:#fff;font-weight:bold;">No results found for "<span style="color:#a770ef">${query}</span>"</div>`;
            } else {
                searchResultsWrapper.innerHTML = `<div style="color:#a770ef;font-weight:bold;margin-bottom:10px;">Results for "<span style="color:#fff">${query}</span>":</div>` +
                    results.map(res => {
                        if (res.type === 'event') {
                            let timeStr = res.time ? ` (${res.time})` : '';
                            return `<div style="margin-bottom:10px;"><span style="color:#fff;font-weight:bold;">${res.title}${timeStr}</span> <span style="color:#a770ef;">${res.date}</span>${res.desc ? ' - ' + res.desc : ''}</div>`;
                        } else if (res.type === 'birthday') {
                            return `<div style="margin-bottom:10px;"><span style="color:#ffb347;font-weight:bold;">🎂 ${res.name}'s Birthday</span> <span style="color:#a770ef;">${res.date}</span>${res.desc ? ' - ' + res.desc : ''}</div>`;
                        } else if (res.type === 'holiday') {
                            return `<div style="margin-bottom:10px;"><span style="color:#a770ef;font-weight:bold;">${res.title}</span> <span style="color:#a770ef;">${res.date}</span>${res.country ? ' (' + res.country + ')' : ''}${res.desc ? ' - ' + res.desc : ''}</div>`;
                        }
                        return '';
                    }).join('');
            }
            searchResultsWrapper.style.display = 'block';
        }

        // Hide search results
        function hideSearchResults() {
            searchResultsWrapper.style.display = 'none';
        }

        // Desktop search bar input
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const query = e.target.value;
            if (query.trim().length === 0) {
                hideSearchResults();
                return;
            }
            const results = searchCalendar(query);
            renderSearchResults(results, query);
        });

        // Hide results when clicking outside
        document.addEventListener('click', function(e) {
            if (!searchResultsWrapper.contains(e.target) && e.target.id !== 'searchInput') {
                hideSearchResults();
            }
        });

        // --- Mobile search overlay logic ---
        document.getElementById('searchIconMobile').addEventListener('click', function(e) {
            e.stopPropagation();
            mobileSearchOverlay.style.display = 'flex';
            setTimeout(() => {
                document.getElementById('mobileSearchInput').focus();
            }, 100);
        });

        document.getElementById('closeMobileSearchBtn').addEventListener('click', function() {
            mobileSearchOverlay.style.display = 'none';
            document.getElementById('mobileSearchInput').value = '';
            document.getElementById('mobileSearchResults').innerHTML = '';
        });

        // Mobile search input
        document.getElementById('mobileSearchInput').addEventListener('input', function(e) {
            const query = e.target.value;
            const results = searchCalendar(query);
            const resultsDiv = document.getElementById('mobileSearchResults');
            if (!query.trim().length) {
                resultsDiv.innerHTML = '';
                return;
            }
            if (!results.length) {
                resultsDiv.innerHTML = `<div style="color:#fff;font-weight:bold;">No results found for "<span style="color:#a770ef">${query}</span>"</div>`;
            } else {
                resultsDiv.innerHTML = `<div style="color:#a770ef;font-weight:bold;margin-bottom:10px;">Results for "<span style="color:#fff">${query}</span>":</div>` +
                    results.map(res => {
                        if (res.type === 'event') {
                            let timeStr = res.time ? ` (${res.time})` : '';
                            return `<div style="margin-bottom:10px;"><span style="color:#fff;font-weight:bold;">${res.title}${timeStr}</span> <span style="color:#a770ef;">${res.date}</span>${res.desc ? ' - ' + res.desc : ''}</div>`;
                        } else if (res.type === 'birthday') {
                            return `<div style="margin-bottom:10px;"><span style="color:#ffb347;font-weight:bold;">🎂 ${res.name}'s Birthday</span> <span style="color:#a770ef;">${res.date}</span>${res.desc ? ' - ' + res.desc : ''}</div>`;
                        } else if (res.type === 'holiday') {
                            return `<div style="margin-bottom:10px;"><span style="color:#a770ef;font-weight:bold;">${res.title}</span> <span style="color:#a770ef;">${res.date}</span>${res.country ? ' (' + res.country + ')' : ''}${res.desc ? ' - ' + res.desc : ''}</div>`;
                        }
                        return '';
                    }).join('');
            }
        });

        // Hide mobile overlay on outside click
        mobileSearchOverlay.addEventListener('click', function(e) {
            if (e.target === mobileSearchOverlay) {
                mobileSearchOverlay.style.display = 'none';
                document.getElementById('mobileSearchInput').value = '';
                document.getElementById('mobileSearchResults').innerHTML = '';
            }
        });



        let selectMode = false;
        let selectedDates = [];

        const selectBtn = document.getElementById('selectDateCalendar');
        const newEventBtn = document.getElementById('newEvent');
        const printBtn = document.getElementById('printBtn');
        const shareBtn = document.getElementById('shareBtn');

        // Enter/exit select mode
        selectBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            selectMode = !selectMode;
            selectedDates = [];
            updateToolbarButtons();
            renderCalendar(currentYear, currentMonth);
            if (selectMode) {
                selectBtn.classList.add('active');
                showToast('Select mode enabled. Click dates to select.');
            } else {
                selectBtn.classList.remove('active');
                showToast('Select mode disabled.');
            }
        });

        // Patch renderCalendar to highlight/select dates in select mode
        const origRenderCalendar2 = renderCalendar;
        renderCalendar = function(year, month) {
            origRenderCalendar2(year, month);

            if (selectMode && currentView === 'Month') {
                const calendarEl = document.getElementById('calendar');
                const table = calendarEl.querySelector('table');
                if (!table) return;
                const rows = table.querySelectorAll('tbody tr');
                let date = 1;
                const today = new Date(year, month, 1);
                for (let i = 0; i < rows.length; i++) {
                    const cells = rows[i].children;
                    for (let j = 0; j < cells.length; j++) {
                        if (
                            (i === 0 && j < today.getDay()) ||
                            date > new Date(year, month + 1, 0).getDate()
                        ) {
                            // empty cell
                        } else {
                            const cell = cells[j];
                            const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(date).padStart(2,'0')}`;
                            cell.style.cursor = 'pointer';
                            if (selectedDates.includes(dateStr)) {
                                cell.style.background = 'rgba(167,112,239,0.38)';
                                cell.style.boxShadow = '0 0 0 3px #a770ef88';
                            }
                            cell.onclick = function(e) {
                                if (!selectMode) return;
                                if (selectedDates.includes(dateStr)) {
                                    selectedDates = selectedDates.filter(d => d !== dateStr);
                                } else {
                                    selectedDates.push(dateStr);
                                }
                                updateToolbarButtons();
                                renderCalendar(currentYear, currentMonth);
                                e.stopPropagation();
                            };
                            date++;
                        }
                    }
                }
            }
        };

        // Enable/disable toolbar buttons based on selection
        function updateToolbarButtons() {
            if (selectMode && selectedDates.length > 0) {
                newEventBtn.disabled = false;
                printBtn.disabled = false;
                shareBtn.disabled = false;
            } else {
                newEventBtn.disabled = true;
                printBtn.disabled = true;
                shareBtn.disabled = true;
            }
        }

        // New Event button: always open modal and pre-fill date if selected
        newEventBtn.onclick = function() {
            document.getElementById('createEventModal').style.display = 'flex';
            if (selectMode && selectedDates.length > 0) {
                if (selectedDates.length === 1) {
                    document.getElementById('eventDate').value = selectedDates[0];
                    document.getElementById('eventDescription').value = '';
                } else {
                    document.getElementById('eventDate').value = '';
                    document.getElementById('eventDescription').value =
                        'Selected dates: ' + selectedDates.join(', ');
                }
            } else {
                document.getElementById('eventDate').value = '';
                document.getElementById('eventDescription').value = '';
            }
        };

        // Print button: print selected date(s) events
        printBtn.onclick = function() {
            if (!selectMode || selectedDates.length === 0) return;
            let printContent = `<div style="font-family:Arial,sans-serif;color:#270e33;padding:24px;">
                <h2 style="color:#a770ef;">Munetios Calendar</h2>`;
            selectedDates.forEach(dateStr => {
                const eventsList = getEventsForDate(dateStr);
                printContent += `<h3>Date: ${dateStr}</h3><hr><ul>`;
                if (eventsList.length) {
                    eventsList.forEach(ev => {
                        if (ev.type === 'birthday') {
                            printContent += `<li>🎂 ${ev.name}'s Birthday${ev.desc ? ' - ' + ev.desc : ''}</li>`;
                        } else if (ev.type === 'holiday') {
                            printContent += `<li>${ev.title} (${ev.country})${ev.desc ? ' - ' + ev.desc : ''}</li>`;
                        } else {
                            let timeStr = '';
                            if (ev.time) {
                                let [h, m] = ev.time.split(':');
                                h = parseInt(h, 10);
                                let ampm = h < 12 ? 'AM' : 'PM';
                                let hour12 = h % 12 === 0 ? 12 : h % 12;
                                timeStr = ` at ${hour12}:${m} ${ampm}`;
                            }
                            printContent += `<li>${ev.title}${timeStr}${ev.desc ? ' - ' + ev.desc : ''}</li>`;
                        }
                    });
                } else {
                    printContent += '<li>No events or birthdays</li>';
                }
                printContent += '</ul>';
            });
            printContent += '</div>';
            let win = window.open('', '', 'width=700,height=900');
            win.document.write('<html><head><title>Print Dates</title></head><body>' + printContent + '</body></html>');
            win.document.close();
            win.focus();
            win.print();
        };

        // Share button: share link for selected date(s)
        shareBtn.onclick = function() {
            if (!selectMode || selectedDates.length === 0) return;
            let url = window.location.origin + window.location.pathname;
            let params = [];
            if (selectedDates.length === 1) {
                params.push(`createevent=event`);
                params.push(`date=${encodeURIComponent(selectedDates[0])}`);
            } else {
                params.push(`selectdates=${encodeURIComponent(selectedDates.join(','))}`);
            }
            url += '?' + params.join('&');
            if (navigator.share) {
                navigator.share({
                    title: 'Munetios Calendar',
                    text: `Selected dates: ${selectedDates.join(', ')}`,
                    url: url
                });
            } else {
                prompt('Copy this link to share selected dates:', url);
            }
        };

        // Exit select mode if view changes
        const origSelectView = selectView;
        selectView = function(view) {
            selectMode = false;
            selectedDates = [];
            updateToolbarButtons();
            selectBtn.classList.remove('active');
            origSelectView(view);
        };




    // Show context menu (create-wrapper) when clicking a date cell in Month view
    // Context menu for Month view date cells (.context-wrapper)
    document.getElementById('calendar').addEventListener('click', function(e) {
        if (currentView !== 'Month') return;

        let cell = e.target;
        while (cell && cell.tagName !== 'TD') {
            cell = cell.parentElement;
        }
        if (!cell) return;

        let dateDiv = cell.querySelector('div');
        if (!dateDiv || isNaN(parseInt(dateDiv.textContent))) return;

        let year = currentYear;
        let month = currentMonth;
        let date = parseInt(dateDiv.textContent);

        // Remove any previous context-wrapper before creating a new one
        let oldWrapper = document.querySelector('.context-wrapper');
        if (oldWrapper) {
            oldWrapper.parentNode.removeChild(oldWrapper);
        }

        let wrapper = document.createElement('div');
        wrapper.className = 'context-wrapper';
        wrapper.style.position = 'absolute';
        wrapper.style.minWidth = '180px';
        wrapper.style.background = 'linear-gradient(135deg, rgba(255,255,255,0.22) 0%, rgba(167,112,239,0.13) 100%)';
        wrapper.style.borderRadius = '24px';
        wrapper.style.boxShadow = '0 8px 32px 0 rgba(167,112,239,0.18), 0 1.5px 8px 0 rgba(255,255,255,0.12) inset';
        wrapper.style.border = '1.5px solid rgba(167,112,239,0.28)';
        wrapper.style.zIndex = '1200';
        wrapper.style.padding = '12px 10px';
        wrapper.style.display = 'flex';
        wrapper.style.flexDirection = 'column';
        wrapper.style.alignItems = 'stretch';
        document.body.appendChild(wrapper);

        wrapper.classList.add('active');
        let rect = cell.getBoundingClientRect();
        wrapper.style.top = (window.scrollY + rect.bottom + 8) + 'px';
        wrapper.style.left = (window.scrollX + rect.left) + 'px';

        // prefill selected date into hidden event form
        document.getElementById('eventDate').value = `${year}-${String(month+1).padStart(2,'0')}-${String(date).padStart(2,'0')}`;

        wrapper.innerHTML = `
            <div class="item">
            <button class="btn" id="printFromDate" title="Print" aria-label="Print">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                <path d="M6 9V4a2 2 0 012-2h8a2 2 0 012 2v5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M6 14h12v7H6v-7z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M6 18h12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <div class="toolbar-label">Print</div>
            </button>
            <button class="btn" id="shareFromDate" title="Share" aria-label="Share">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                <path d="M4 12v7a1 1 0 001 1h14a1 1 0 001-1v-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M12 16V4m0 0l-4 4m4-4l4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <div class="toolbar-label">Share</div>
            </button>
            <button class="btn" id="favoriteFromDate" title="Favorite" aria-label="Favorite">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <div class="toolbar-label">Favorite</div>
            </button>
            </div>
            <button class="btn" id="closeContextWrapperBtn" style="margin-top:12px;background:#a770ef;color:#fff;font-weight:bold;">Close</button>
        `;

wrapper.querySelector('#printFromDate').onclick = function() {
    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(date).padStart(2,'0')}`;
    const eventsList = getEventsForDate(dateStr);
    const holidays = getHolidays(year);
    let printContent = `
        <div style="font-family:Arial,sans-serif;color:#270e33;padding:24px;">
            <h2 style="color:#a770ef;">Munetios Calendar</h2>
            <h3>Date: ${dateStr}</h3>
            <hr>
            <h4>Holidays</h4>
            <ul>
            ${holidays[dateStr] ? `<li>${holidays[dateStr]}</li>` : '<li>No holidays</li>'}
            </ul>
            <h4>Events & Birthdays</h4>
            <ul>
            ${
                eventsList.length
                ? eventsList.map(ev => {
                    if (ev.type === 'birthday') {
                        return `<li>🎂 ${ev.name}'s Birthday${ev.desc ? ' - ' + ev.desc : ''}</li>`;
                    } else if (ev.type === 'holiday') {
                        return `<li>${ev.title} (${ev.country})${ev.desc ? ' - ' + ev.desc : ''}</li>`;
                    } else {
                        let timeStr = '';
                        if (ev.time) {
                            let [h, m] = ev.time.split(':');
                            h = parseInt(h, 10);
                            let ampm = h < 12 ? 'AM' : 'PM';
                            let hour12 = h % 12 === 0 ? 12 : h % 12;
                            timeStr = ` at ${hour12}:${m} ${ampm}`;
                        }
                        return `<li>${ev.title}${timeStr}${ev.desc ? ' - ' + ev.desc : ''}</li>`;
                    }
                }).join('')
                : '<li>No events or birthdays</li>'
            }
            </ul>
        </div>
    `;
    let win = window.open('', '', 'width=700,height=900');
    win.document.write('<html><head><title>Print Date</title></head><body>' + printContent + '</body></html>');
    win.document.close();
    win.focus();
    win.print();
    if (wrapper && wrapper.parentNode) {
        wrapper.parentNode.removeChild(wrapper);
    }
};

wrapper.querySelector('#shareFromDate').onclick = function() {
    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(date).padStart(2,'0')}`;
    const eventsList = getEventsForDate(dateStr);
    let url = window.location.origin + window.location.pathname;
    if (eventsList.length) {
        const ev = eventsList[0];
        let params = [];
        if (ev.type === 'birthday') {
            params.push(`createevent=birthday`);
            params.push(`title=${encodeURIComponent(ev.name + "'s Birthday")}`);
            params.push(`des=${encodeURIComponent(ev.desc || '')}`);
            params.push(`date=${encodeURIComponent(ev.date)}`);
        } else if (ev.type === 'holiday') {
            params.push(`createevent=holiday`);
            params.push(`title=${encodeURIComponent(ev.title)}`);
            params.push(`des=${encodeURIComponent(ev.desc || '')}`);
            params.push(`date=${encodeURIComponent(ev.date)}`);
        } else {
            params.push(`createevent=event`);
            params.push(`title=${encodeURIComponent(ev.title)}`);
            params.push(`des=${encodeURIComponent(ev.desc || '')}`);
            params.push(`time=${encodeURIComponent(ev.time || '')}`);
            params.push(`date=${encodeURIComponent(ev.date)}`);
        }
        url += '?' + params.join('&');
    } else {
        url += `?createevent=event&date=${encodeURIComponent(dateStr)}`;
    }
    if (navigator.share) {
        navigator.share({
            title: 'Munetios Calendar',
            text: `Create event for: ${dateStr}`,
            url: url
        });
    } else {
        prompt('Copy this link to create event:', url);
    }
    if (wrapper && wrapper.parentNode) {
        wrapper.parentNode.removeChild(wrapper);
    }
};

wrapper.querySelector('#favoriteFromDate').onclick = function() {
    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(date).padStart(2,'0')}`;
    const eventsList = getEventsForDate(dateStr);
    let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
    eventsList.forEach(ev => {
        if (!favorites.some(fav => fav.date === ev.date && fav.title === ev.title && fav.type === ev.type)) {
            favorites.push(ev);
        }
    });
    if (eventsList.length === 0) {
        favorites.push({ type: 'date', date: dateStr });
    }
    localStorage.setItem('favorites', JSON.stringify(favorites));
    showToast('Added to favorites!');
    updateFavoritesModal();
    if (wrapper && wrapper.parentNode) {
        wrapper.parentNode.removeChild(wrapper);
    }
};

wrapper.querySelector('#closeContextWrapperBtn').onclick = function() {
    if (wrapper && wrapper.parentNode) {
        wrapper.parentNode.removeChild(wrapper);
    }
};

        // Update favorites modal list
        function updateFavoritesModal() {
            const favoritesList = document.getElementById('favoritesList');
            favoritesList.innerHTML = '';
            let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
            if (favorites.length === 0) {
            favoritesList.innerHTML = '<li>No favorites yet.</li>';
            return;
            }
            favorites.forEach(fav => {
            let li = document.createElement('li');
            li.style.padding = '8px 0';
            li.style.borderBottom = '1px solid rgba(167,112,239,0.09)';
            if (fav.type === 'birthday') {
                li.textContent = `🎂 ${fav.name}'s Birthday (${fav.date})${fav.desc ? ' - ' + fav.desc : ''}`;
            } else if (fav.type === 'holiday') {
                li.textContent = `${fav.title} (${fav.country}) (${fav.date})${fav.desc ? ' - ' + fav.desc : ''}`;
            } else if (fav.type === 'event') {
                li.textContent = `${fav.title} (${fav.date})${fav.time ? ' at ' + fav.time : ''}${fav.desc ? ' - ' + fav.desc : ''}`;
            } else if (fav.type === 'date') {
                li.textContent = `Date: ${fav.date}`;
            }
            favoritesList.appendChild(li);
            });
        }

        // Show favorites modal when clicking favorites button
        document.getElementById('favorites').onclick = function() {
            updateFavoritesModal();
            document.getElementById('favoritesModal').style.display = 'flex';
        };

        // Close favorites modal
        document.getElementById('closeFavoritesModal').onclick = function() {
            document.getElementById('favoritesModal').style.display = 'none';
        };
        // Attach close button event immediately after rendering
        const closeBtn = wrapper.querySelector('#closeContextWrapperBtn');
        if (closeBtn) {
            closeBtn.onclick = function() {
                if (wrapper && wrapper.parentNode) {
                    wrapper.parentNode.removeChild(wrapper);
                }
            };
        }

        // Prevent propagation so outside click doesn't close wrapper immediately
        e.stopPropagation();
    });
    document.addEventListener('click', function(e) {
        // Close all modals if clicking outside modal-content
        document.querySelectorAll('.modal').forEach(function(modal) {
            if (modal.style.display === 'flex') {
                const content = modal.querySelector('.modal-content');
                if (content && !content.contains(e.target)) {
                    modal.style.display = 'none';
                }
            }
        });
    });

    // Make all .close buttons close their parent modal
    document.querySelectorAll('.modal .close').forEach(function(closeBtn) {
        closeBtn.onclick = function() {
            const modal = closeBtn.closest('.modal');
            if (modal) modal.style.display = 'none';
        };
    });
    document.getElementById('favorites').addEventListener('click', function(e) {
        e.stopPropagation();
        // Update favorites modal list before showing
        const favoritesList = document.getElementById('favoritesList');
        favoritesList.innerHTML = '';
        let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
        if (favorites.length === 0) {
            favoritesList.innerHTML = '<li>No favorites yet.</li>';
        } else {
            favorites.forEach(fav => {
                let li = document.createElement('li');
                li.style.padding = '8px 0';
                li.style.borderBottom = '1px solid rgba(167,112,239,0.09)';
                if (fav.type === 'birthday') {
                    li.textContent = `🎂 ${fav.name}'s Birthday (${fav.date})${fav.desc ? ' - ' + fav.desc : ''}`;
                } else if (fav.type === 'holiday') {
                    li.textContent = `${fav.title} (${fav.country}) (${fav.date})${fav.desc ? ' - ' + fav.desc : ''}`;
                } else if (fav.type === 'event') {
                    let timeStr = '';
                    if (fav.time) {
                        let [h, m] = fav.time.split(':');
                        h = parseInt(h, 10);
                        let ampm = h < 12 ? 'AM' : 'PM';
                        let hour12 = h % 12 === 0 ? 12 : h % 12;
                        timeStr = ` at ${hour12}:${m} ${ampm}`;
                    }
                    li.textContent = `${fav.title} (${fav.date})${timeStr}${fav.desc ? ' - ' + fav.desc : ''}`;
                } else if (fav.type === 'date') {
                    li.textContent = `Date: ${fav.date}`;
                }
                favoritesList.appendChild(li);
            });
        }
        document.getElementById('favoritesModal').style.display = 'flex';
    });
    // Reset create-wrapper position when closed
    document.querySelector('.create-wrapper').addEventListener('transitionend', function() {
        if (!this.classList.contains('active')) {
            this.style.top = '';
            this.style.left = '';
        }
    });
    // Toast notification system
    function showToast(message, options = {}) {
        // Remove any existing toast
        let oldToast = document.getElementById('customToast');
        if (oldToast) oldToast.remove();

        const toast = document.createElement('div');
        toast.id = 'customToast';
        toast.textContent = message;
        toast.style.position = 'fixed';
        toast.style.bottom = '32px';
        toast.style.left = '50%';
        toast.style.transform = 'translateX(-50%)';
        toast.style.background = 'linear-gradient(135deg, #a770ef 0%, #37066e 100%)';
        toast.style.color = '#fff';
        toast.style.padding = '16px 32px';
        toast.style.borderRadius = '24px';
        toast.style.boxShadow = '0 4px 24px rgba(167,112,239,0.18)';
        toast.style.fontWeight = 'bold';
        toast.style.fontSize = '1.05em';
        toast.style.zIndex = '9999';
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.4s cubic-bezier(0.4,0,0.2,1)';
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.style.opacity = '1';
        }, 10);

        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => {
                if (toast.parentNode) toast.parentNode.removeChild(toast);
            }, 400);
        }, options.duration || 2600);
    }
    // Use IndexedDB for events storage
    let db;
    let events = [];

    function openDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open('calendarDB', 1);
            request.onupgradeneeded = function(e) {
                db = e.target.result;
                if (!db.objectStoreNames.contains('events')) {
                    db.createObjectStore('events', { keyPath: 'id', autoIncrement: true });
                }
            };
            request.onsuccess = function(e) {
                db = e.target.result;
                resolve();
            };
            request.onerror = function(e) {
                reject(e);
            };
        });
    }

    function loadEvents() {
        return new Promise((resolve) => {
            const transaction = db.transaction(['events'], 'readonly');
            const store = transaction.objectStore('events');
            const request = store.getAll();
            request.onsuccess = function(e) {
                events = e.target.result || [];
                resolve();
            };
        });
    }

    function saveEvent(event) {
        return new Promise((resolve) => {
            const transaction = db.transaction(['events'], 'readwrite');
            const store = transaction.objectStore('events');
            store.add(event).onsuccess = resolve;
        });
    }

    function getEventsForDate(dateStr) {
        return events.filter(ev => ev.date === dateStr);
    }

    // Show create-wrapper on Create button click
    document.getElementById('createBtn').addEventListener('click', function(e) {
        e.stopPropagation();
        document.querySelector('.create-wrapper').classList.toggle('active');
    });

    // Hide create-wrapper when clicking outside
    document.addEventListener('click', function(e) {
        document.querySelector('.create-wrapper').classList.remove('active');
    });

    // Prevent closing when clicking inside
    document.querySelector('.create-wrapper').addEventListener('click', function(e) {
        e.stopPropagation();
    });

    // Show modals for event/birthday/holiday
    document.getElementById('createEventBtn').onclick = () => {
        document.getElementById('createEventModal').style.display = 'flex';
        document.querySelector('.create-wrapper').classList.remove('active');
    };
    document.getElementById('createBirthdayBtn').onclick = () => {
        document.getElementById('createBirthdayModal').style.display = 'flex';
        document.querySelector('.create-wrapper').classList.remove('active');
    };
    document.getElementById('createHolidayBtn').onclick = () => {
        document.getElementById('createHolidayModal').style.display = 'flex';
        document.querySelector('.create-wrapper').classList.remove('active');
    };

    // Close modals
    document.getElementById('closeModal').onclick = () => {
        document.getElementById('createEventModal').style.display = 'none';
    };
    document.getElementById('closeBirthdayModal').onclick = () => {
        document.getElementById('createBirthdayModal').style.display = 'none';
    };
    document.getElementById('closeHolidayModal').onclick = () => {
        document.getElementById('createHolidayModal').style.display = 'none';
    };

    // Event form submit
    document.getElementById('eventForm').onsubmit = async function(e) {
        e.preventDefault();
        const title = this.eventTitle.value.trim();
        const date = this.eventDate.value;
        const time = this.eventTime.value;
        const desc = this.eventDescription.value.trim();
        if (!title || !date) return;
        await saveEvent({
            type: 'event',
            title,
            date,
            time,
            desc
        });
        await loadEvents();
        this.reset();
        document.getElementById('createEventModal').style.display = 'none';
        renderCalendar(currentYear, currentMonth);
    };

    // Birthday form submit
    document.getElementById('birthdayForm').onsubmit = async function(e) {
        e.preventDefault();
        const name = this.birthdayName.value.trim();
        const date = this.birthdayDate.value;
        const desc = this.birthdayDescription.value.trim();
        if (!name || !date) return;
        await saveEvent({
            type: 'birthday',
            name,
            date,
            desc
        });
        await loadEvents();
        this.reset();
        document.getElementById('createBirthdayModal').style.display = 'none';
        renderCalendar(currentYear, currentMonth);
    };

    // Holiday form submit
    document.getElementById('holidayForm').onsubmit = async function(e) {
        e.preventDefault();
        const title = this.holidayTitle.value.trim();
        const date = this.holidayDate.value;
        const country = this.holidayCountry.value;
        const desc = this.holidayDescription.value.trim();
        if (!title || !date || !country) return;
        await saveEvent({
            type: 'holiday',
            title,
            date,
            country,
            desc
        });
        await loadEvents();
        this.reset();
        document.getElementById('createHolidayModal').style.display = 'none';
        renderCalendar(currentYear, currentMonth);
    };

    // Patch renderCalendar to show events under date in calendar and show event time in week/day view
    const origRenderCalendar = renderCalendar;
    renderCalendar = function(year, month) {
        origRenderCalendar(year, month);

        // Month view: show events under date
        if (currentView === 'Month') {
            const calendarEl = document.getElementById('calendar');
            const table = calendarEl.querySelector('table');
            if (!table) return;
            const rows = table.querySelectorAll('tbody tr');
            let date = 1;
            const today = new Date(year, month, 1);
            for (let i = 0; i < rows.length; i++) {
            const cells = rows[i].children;
            for (let j = 0; j < cells.length; j++) {
                if (
                (i === 0 && j < today.getDay()) ||
                date > new Date(year, month + 1, 0).getDate()
                ) {
                // empty cell
                } else {
                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(date).padStart(2,'0')}`;
                // Get events for this date, including birthdays that repeat every year
                const evs = events.filter(ev => {
                    if (ev.type === 'birthday') {
                    // Match MM-DD regardless of year
                    return ev.date && ev.date.slice(5) === dateStr.slice(5);
                    } else {
                    return ev.date === dateStr;
                    }
                });
                if (evs.length) {
                    evs.forEach(ev => {
                    const div = document.createElement('div');
                    div.style.fontSize = '0.85em';
                    div.style.marginTop = '2px';
                    div.style.color = ev.type === 'birthday' ? '#ffb347' : (ev.type === 'holiday' ? '#a770ef' : '#fff');
                    div.style.fontWeight = 'bold';
                    if (ev.type === 'birthday') {
                        div.textContent = `🎂 ${ev.name}'s Birthday`;
                    } else if (ev.type === 'holiday') {
                        div.textContent = `${ev.title} (${ev.country})`;
                    } else {
                        div.textContent = ev.title;
                        if (ev.time) {
                        let [h, m] = ev.time.split(':');
                        h = parseInt(h, 10);
                        let ampm = h < 12 ? 'AM' : 'PM';
                        let hour12 = h % 12 === 0 ? 12 : h % 12;
                        div.textContent += ` (${hour12}:${m} ${ampm})`;
                        }
                    }
                    cells[j].appendChild(div);
                    });
                }
                date++;
                }
            }
            }
        }

        // Day view: show events at correct time slot
        if (currentView === 'Day') {
            const calendarEl = document.getElementById('calendar');
            const table = calendarEl.querySelector('table');
            if (!table) return;
            const rows = table.querySelectorAll('tbody tr');
            const dateStr = `${currentDay.getFullYear()}-${String(currentDay.getMonth()+1).padStart(2,'0')}-${String(currentDay.getDate()).padStart(2,'0')}`;
            const evs = getEventsForDate(dateStr);
            if (evs.length) {
                rows.forEach(row => {
                    const timeCell = row.children[0];
                    const eventCell = row.children[1];
                    const hourText = timeCell.textContent;
                    evs.forEach(ev => {
                        // Match time (12-hour format)
                        if (ev.time) {
                            let [h, m] = ev.time.split(':');
                            h = parseInt(h, 10);
                            let ampm = h < 12 ? 'AM' : 'PM';
                            let hour12 = h % 12 === 0 ? 12 : h % 12;
                            let formatted = `${hour12}:00 ${ampm}`;
                            if (hourText === formatted) {
                                const div = document.createElement('div');
                                div.style.fontSize = '0.95em';
                                div.style.color = '#fff';
                                div.style.fontWeight = 'bold';
                                div.textContent = ev.title + (ev.time ? ` (${hour12}:${m} ${ampm})` : '');
                                eventCell.appendChild(div);
                            }
                        }
                    });
                });
            }
        }

        // Week view: show events at correct day/time slot
        if (currentView === 'Week') {
            const calendarEl = document.getElementById('calendar');
            const table = calendarEl.querySelector('table');
            if (!table) return;
            const rows = table.querySelectorAll('tbody tr');
            for (let rowIdx = 0; rowIdx < rows.length; rowIdx++) {
                const row = rows[rowIdx];
                const timeCell = row.children[0];
                const hourText = timeCell.textContent;
                for (let col = 1; col < row.children.length; col++) {
                    const cell = row.children[col];
                    // Get date for this cell
                    let weekStart = new Date(currentWeekStart);
                    let d = new Date(weekStart);
                    d.setDate(weekStart.getDate() + (col - 1));
                    const dateStr = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                    const evs = getEventsForDate(dateStr);
                    if (evs.length) {
                        evs.forEach(ev => {
                            if (ev.time) {
                                let [h, m] = ev.time.split(':');
                                h = parseInt(h, 10);
                                let ampm = h < 12 ? 'AM' : 'PM';
                                let hour12 = h % 12 === 0 ? 12 : h % 12;
                                let formatted = `${hour12}:00 ${ampm}`;
                                if (hourText === formatted) {
                                    const div = document.createElement('div');
                                    div.style.fontSize = '0.95em';
                                    div.style.color = '#fff';
                                    div.style.fontWeight = 'bold';
                                    div.textContent = ev.title + (ev.time ? ` (${hour12}:${m} ${ampm})` : '');
                                    cell.appendChild(div);
                                }
                            }
                        });
                    }
                }
            }
        }
    };

    // Initialize DB and load events before first render
    openDB().then(loadEvents).then(() => {
        renderCalendar(currentYear, currentMonth);
    });

        let today = new Date();
        let currentYear = today.getFullYear();
        let currentMonth = today.getMonth();
        let currentView = 'Month'; // Default view

        // Returns holidays for a given year for multiple countries, including some real-time calculation for dynamic holidays
        function getHolidays(year) {
            // Helper functions for dynamic holidays
            function nthWeekdayOfMonth(year, month, weekday, n) {
                // weekday: 0=Sun, 1=Mon, ..., 6=Sat
                let date = new Date(year, month, 1);
                let count = 0;
                while (date.getMonth() === month) {
                    if (date.getDay() === weekday) {
                        count++;
                        if (count === n) return date;
                    }
                    date.setDate(date.getDate() + 1);
                }
                return null;
            }
            function lastWeekdayOfMonth(year, month, weekday) {
                let date = new Date(year, month + 1, 0); // last day of month
                while (date.getDay() !== weekday) {
                    date.setDate(date.getDate() - 1);
                }
                return date;
            }
            // Calculate Easter Sunday (Western, Gregorian)
            function getEaster(year) {
                // Meeus/Jones/Butcher algorithm
                let f = Math.floor,
                    a = year % 19,
                    b = f(year / 100),
                    c = year % 100,
                    d = f(b / 4),
                    e = b % 4,
                    g = f((b + 8) / 25),
                    h = f((b - g + 1) / 3),
                    i = year % 4,
                    k = year % 7,
                    l = (19 * a + b - d - h + 15) % 30,
                    m = (32 + 2 * e + 2 * i - l - k) % 7,
                    n = f((a + 11 * l + 22 * m) / 451),
                    month = f((l + m - 7 * n + 114) / 31),
                    day = ((l + m - 7 * n + 114) % 31) + 1;
                return new Date(year, month - 1, day);
            }
            // Calculate Good Friday and Easter Monday
            let easter = getEaster(year);
            let goodFriday = new Date(easter);
            goodFriday.setDate(easter.getDate() - 2);
            let easterMonday = new Date(easter);
            easterMonday.setDate(easter.getDate() + 1);

            // US Holidays (dynamic for some, static for others)
            const us = {
                [`${year}-01-01`]: "New Year's Day (US)",
                [`${year}-01-16`]: "Martin Luther King Jr. Day (US)", // 3rd Monday in January (dynamic below)
                [`${year}-02-14`]: "Valentine's Day (US)",
                [`${year}-02-20`]: "Presidents' Day (US)", // 3rd Monday in February (dynamic below)
                [`${year}-02-22`]: "Washington's Birthday (US)",
                [`${year}-03-17`]: "St. Patrick's Day (US)",
                [`${year}-04-01`]: "April Fool's Day (US)",
                [`${year}-05-05`]: "Cinco de Mayo (US)",
                [`${year}-05-29`]: "Memorial Day (US)", // Last Monday in May (dynamic below)
                [`${year}-06-14`]: "Flag Day (US)",
                [`${year}-06-19`]: "Juneteenth National Independence Day (US)",
                [`${year}-07-04`]: "Independence Day (US)",
                [`${year}-09-01`]: "Labor Day (US)", // 1st Monday in September (dynamic below)
                [`${year}-09-11`]: "Patriot Day (US)",
                [`${year}-10-09`]: "Columbus Day (US)", // 2nd Monday in October (dynamic below)
                [`${year}-10-31`]: "Halloween (US)",
                [`${year}-11-10`]: "Veterans Day (US)", // Observed if 11th is Saturday
                [`${year}-11-11`]: "Veterans Day (US)",
                [`${year}-11-23`]: "Thanksgiving (US)", // 4th Thursday in November (dynamic below)
                [`${year}-12-07`]: "Pearl Harbor Remembrance Day (US)",
                [`${year}-12-24`]: "Christmas Eve (US)",
                [`${year}-12-25`]: "Christmas Day (US)",
                [`${year}-12-31`]: "New Year's Eve (US)"
            };
            // Dynamic US holidays
            let mlk = nthWeekdayOfMonth(year, 0, 1, 3); // 3rd Monday Jan
            if (mlk) us[mlk.toISOString().slice(0,10)] = "Martin Luther King Jr. Birthday (US)";
            let presidents = nthWeekdayOfMonth(year, 1, 1, 3); // 3rd Monday Feb
            if (presidents) us[presidents.toISOString().slice(0,10)] = "Presidents' Day (US)";
            let memorial = lastWeekdayOfMonth(year, 4, 1); // Last Monday May
            if (memorial) us[memorial.toISOString().slice(0,10)] = "Memorial Day (US)";
            let labor = nthWeekdayOfMonth(year, 8, 1, 1); // 1st Monday Sep
            if (labor) us[labor.toISOString().slice(0,10)] = "Labor Day (US)";
            let thanksgiving = nthWeekdayOfMonth(year, 10, 4, 4); // 4th Thursday Nov
            if (thanksgiving) us[thanksgiving.toISOString().slice(0,10)] = "Thanksgiving (US)";

            // UK Holidays (some dynamic, some static)
            const uk = {
                [`${year}-01-01`]: "New Year's Day (UK)",
                [`${year}-02-14`]: "Valentine's Day (UK)",
                [`${year}-03-01`]: "St David's Day (Wales)",
                [`${year}-03-17`]: "St Patrick's Day (Northern Ireland)",
                [`${year}-04-23`]: "St George's Day (England)",
                [`${year}-10-31`]: "Halloween (UK)",
                [`${year}-11-05`]: "Guy Fawkes Night (UK)",
                [`${year}-12-24`]: "Christmas Eve (UK)",
                [`${year}-12-25`]: "Christmas Day (UK)",
                [`${year}-12-26`]: "Boxing Day (UK)",
                [`${year}-12-31`]: "New Year's Eve (UK)"
            };
            // UK Early May Bank Holiday: first Monday in May
            let ukMay = nthWeekdayOfMonth(year, 4, 1, 1);
            if (ukMay) uk[ukMay.toISOString().slice(0,10)] = "Early May Bank Holiday (UK)";
            // UK Spring Bank Holiday: last Monday in May
            let ukSpring = lastWeekdayOfMonth(year, 4, 1);
            if (ukSpring) uk[ukSpring.toISOString().slice(0,10)] = "Spring Bank Holiday (UK)";
            // UK Summer Bank Holiday: last Monday in August
            let ukSummer = lastWeekdayOfMonth(year, 7, 1);
            if (ukSummer) uk[ukSummer.toISOString().slice(0,10)] = "Summer Bank Holiday (UK)";
            // Good Friday and Easter Monday (Western)
            uk[goodFriday.toISOString().slice(0,10)] = "Good Friday (UK)";
            uk[easterMonday.toISOString().slice(0,10)] = "Easter Monday (UK)";

            // Canada Holidays (some dynamic)
            const ca = {
                [`${year}-01-01`]: "New Year's Day (CA)",
                [`${year}-02-14`]: "Valentine's Day (CA)",
                [`${year}-07-01`]: "Canada Day (CA)",
                [`${year}-10-31`]: "Halloween (CA)",
                [`${year}-11-11`]: "Remembrance Day (CA)",
                [`${year}-12-24`]: "Christmas Eve (CA)",
                [`${year}-12-25`]: "Christmas Day (CA)",
                [`${year}-12-26`]: "Boxing Day (CA)",
                [`${year}-12-31`]: "New Year's Eve (CA)"
            };
            // Labor Day: first Monday in September
            let caLabor = nthWeekdayOfMonth(year, 8, 1, 1);
            if (caLabor) ca[caLabor.toISOString().slice(0,10)] = "Labor Day";
            // Thanksgiving: second Monday in October
            let caThanksgiving = nthWeekdayOfMonth(year, 9, 1, 2);
            if (caThanksgiving) ca[caThanksgiving.toISOString().slice(0,10)] = "Thanksgiving (CA)";
            // Good Friday and Easter Monday (CA)
            ca[goodFriday.toISOString().slice(0,10)] = "Good Friday (CA)";
            ca[easterMonday.toISOString().slice(0,10)] = "Easter Monday (CA)";

            // Australia Holidays (some dynamic)
            const au = {
                [`${year}-01-01`]: "New Year's Day (AU)",
                [`${year}-01-26`]: "Australia Day (AU)",
                [`${year}-03-08`]: "Labour Day (VIC)",
                [`${year}-04-25`]: "ANZAC Day (AU)",
                [`${year}-06-14`]: "Queen's Birthday (AU)",
                [`${year}-10-31`]: "Halloween (AU)",
                [`${year}-12-24`]: "Christmas Eve (AU)",
                [`${year}-12-25`]: "Christmas Day (AU)",
                [`${year}-12-26`]: "Boxing Day (AU)",
                [`${year}-12-31`]: "New Year's Eve (AU)"
            };
            // Good Friday and Easter Monday (AU)
            au[goodFriday.toISOString().slice(0,10)] = "Good Friday (AU)";
            au[easterMonday.toISOString().slice(0,10)] = "Easter Monday (AU)";

            // India Holidays (major national)
            const inHolidays = {
                [`${year}-01-01`]: "New Year's Day (IN)",
                [`${year}-01-26`]: "Republic Day (IN)",
                [`${year}-03-08`]: "Holi (IN)",
                [`${year}-08-15`]: "Independence Day (IN)",
                [`${year}-10-02`]: "Gandhi Jayanti (IN)",
                [`${year}-10-24`]: "Dussehra (IN)",
                [`${year}-11-12`]: "Diwali (IN)",
                [`${year}-12-25`]: "Christmas Day (IN)"
            };

            // France Holidays
            const fr = {
                [`${year}-01-01`]: "Jour de l'An (FR)",
                [`${year}-05-01`]: "Fête du Travail (FR)",
                [`${year}-07-14`]: "Fête Nationale (FR)",
                [`${year}-12-25`]: "Noël (FR)"
            };

            // Germany Holidays
            const de = {
                [`${year}-01-01`]: "Neujahr (DE)",
                [`${year}-10-03`]: "Tag der Deutschen Einheit (DE)",
                [`${year}-12-25`]: "Weihnachtstag (DE)",
                [`${year}-12-26`]: "Zweiter Weihnachtstag (DE)"
            };

            // China Holidays
            const cn = {
                [`${year}-01-01`]: "New Year's Day (CN)",
                [`${year}-05-01`]: "Labour Day (CN)",
                [`${year}-10-01`]: "National Day (CN)"
            };

            // Japan Holidays
            const jp = {
                [`${year}-01-01`]: "New Year's Day (JP)",
                [`${year}-02-11`]: "National Foundation Day (JP)",
                [`${year}-04-29`]: "Showa Day (JP)",
                [`${year}-05-03`]: "Constitution Memorial Day (JP)",
                [`${year}-05-04`]: "Greenery Day (JP)",
                [`${year}-05-05`]: "Children's Day (JP)",
                [`${year}-12-23`]: "Emperor's Birthday (JP)"
            };

            // Brazil Holidays
            const br = {
                [`${year}-01-01`]: "Ano Novo (BR)",
                [`${year}-09-07`]: "Independência do Brasil (BR)",
                [`${year}-12-25`]: "Natal (BR)"
            };

            // South Africa Holidays
            const za = {
                [`${year}-01-01`]: "New Year's Day (ZA)",
                [`${year}-03-21`]: "Human Rights Day (ZA)",
                [`${year}-04-27`]: "Freedom Day (ZA)",
                [`${year}-12-25`]: "Christmas Day (ZA)"
            };

            // Mexico Holidays
            const mx = {
                [`${year}-01-01`]: "Año Nuevo (MX)",
                [`${year}-09-16`]: "Día de la Independencia (MX)",
                [`${year}-12-25`]: "Navidad (MX)"
            };

            // Russia Holidays
            const ru = {
                [`${year}-01-01`]: "New Year's Day (RU)",
                [`${year}-05-09`]: "Victory Day (RU)",
                [`${year}-12-31`]: "New Year's Eve (RU)"
            };

            // South Korea Holidays
            const kr = {
                [`${year}-01-01`]: "New Year's Day (KR)",
                [`${year}-03-01`]: "Independence Movement Day (KR)",
                [`${year}-08-15`]: "Liberation Day (KR)",
                [`${year}-10-03`]: "National Foundation Day (KR)"
            };

            // Islamic holidays (approximate, for demonstration)
            // Eid al-Fitr (approx): May 1, Eid al-Adha (approx): June 28
            const islamic = {
                [`${year}-05-01`]: "Eid al-Fitr (Islamic)",
                [`${year}-06-28`]: "Eid al-Adha (Islamic)"
            };

            // Jewish holidays (approximate, for demonstration)
            // Passover (approx): April 22, Yom Kippur (approx): October 12
            const jewish = {
                [`${year}-04-22`]: "Passover (Jewish)",
                [`${year}-10-12`]: "Yom Kippur (Jewish)"
            };

            // Buddhist holidays (approximate, for demonstration)
            // Vesak (approx): May 23
            const buddhist = {
                [`${year}-05-23`]: "Vesak (Buddhist)"
            };

            // Christian holidays (Easter already calculated)
            const christian = {};
            christian[easter.toISOString().slice(0,10)] = "Easter Sunday (Christian)";

            // Add more countries/regions as needed...

            // Combine all holidays, merging multiple holidays on the same date
            const allHolidayObjs = [
                us, uk, ca, au, inHolidays, fr, de, cn, jp, br, za, mx, ru, kr,
                islamic, jewish, buddhist, christian
            ];
            const merged = {};
            allHolidayObjs.forEach(obj => {
                Object.entries(obj).forEach(([date, name]) => {
                    if (merged[date]) {
                        // Avoid duplicates
                        if (!merged[date].includes(name)) {
                            merged[date] += ' | ' + name;
                        }
                    } else {
                        merged[date] = name;
                    }
                });
            });
            return merged;
        }
        // For compatibility with existing code, alias getUSHolidays to getHolidays
        function getUSHolidays(year) {
            return getHolidays(year);
        }

        function selectView(view) {
            currentView = view;
            renderCalendar(currentYear, currentMonth);
            var dropdown = document.getElementById('viewDropdown');
            dropdown.style.display = 'none';
            document.getElementById('viewBtn').setAttribute('aria-expanded', false);
        }

        function renderCalendar(year, month) {
            const calendarEl = document.getElementById('calendar');
            calendarEl.innerHTML = '';

            const today = new Date();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);

            const monthNames = [
            'January', 'February', 'March', 'April', 'May', 'June',
            'July', 'August', 'September', 'October', 'November', 'December'
            ];
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const hourNames = Array.from({length: 24}, (_, i) => `${i}:00`);

            const holidays = getUSHolidays(year);
            // Use 12-hour time format for hours
            const hourNames12 = Array.from({length: 24}, (_, i) => {
            let hour = i % 12 === 0 ? 12 : i % 12;
            let ampm = i < 12 ? 'AM' : 'PM';
            return `${hour}:00 ${ampm}`;
            });

            if (currentView === 'Month') {
            calendarEl.style.height = '100%'; // Ensure calendar container is 100% height
            }

            if (currentView === 'Day') {
            // Day view: show time row and selected day
            const header = document.createElement('div');
            header.style.textAlign = 'center';
            header.style.fontWeight = 'bold';
            header.style.fontSize = '1.3em';
            header.style.marginBottom = '12px';
            header.textContent = currentDay.toLocaleDateString(undefined, {weekday:'long', year:'numeric', month:'long', day:'numeric'});
            calendarEl.appendChild(header);

            const table = document.createElement('table');
            table.style.width = '100%';
            table.style.borderCollapse = 'collapse';
            table.style.background = 'rgba(167,112,239,0.04)';
            table.style.border = '1.5px solid #a770ef44';

            const thead = document.createElement('thead');
            const trHead = document.createElement('tr');
            const thTime = document.createElement('th');
            thTime.textContent = 'Time';
            thTime.style.background = 'rgba(167,112,239,0.09)';
            thTime.style.width = '100px';
            thTime.style.border = '1px solid #a770ef44';
            trHead.appendChild(thTime);
            const thEvent = document.createElement('th');
            thEvent.textContent = 'Event';
            thEvent.style.background = 'rgba(167,112,239,0.09)';
            thEvent.style.border = '1px solid #a770ef44';
            trHead.appendChild(thEvent);
            thead.appendChild(trHead);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            hourNames12.forEach(hour => {
                const row = document.createElement('tr');
                const timeCell = document.createElement('td');
                timeCell.textContent = hour;
                timeCell.style.width = '100px';
                timeCell.style.padding = '8px';
                timeCell.style.background = 'rgba(167,112,239,0.09)';
                timeCell.style.fontWeight = 'bold';
                timeCell.style.border = '1px solid #a770ef44';
                const eventCell = document.createElement('td');
                eventCell.style.padding = '8px';
                eventCell.style.border = '1px solid #a770ef44';

                // Show holiday if selected day is a holiday
                const dateStr = `${currentDay.getFullYear()}-${String(currentDay.getMonth()+1).padStart(2,'0')}-${String(currentDay.getDate()).padStart(2,'0')}`;
                if (holidays[dateStr] && hour === '12:00 PM') {
                eventCell.innerHTML = `<span style="color:#a770ef;font-weight:bold;">${holidays[dateStr]}</span>`;
                } else {
                eventCell.textContent = '';
                }

                row.appendChild(timeCell);
                row.appendChild(eventCell);
                tbody.appendChild(row);
            });
            table.appendChild(tbody);
            calendarEl.appendChild(table);
            } else if (currentView === 'Week') {
            // Week view: row is time, columns are week days
            const header = document.createElement('div');
            header.style.textAlign = 'center';
            header.style.fontWeight = 'bold';
            header.style.fontSize = '1.3em';
            header.style.marginBottom = '12px';
            // Use currentWeekStart for navigation
            let weekStart = new Date(currentWeekStart);
            header.textContent = `Week of ${weekStart.toLocaleDateString(undefined, {month:'long', day:'numeric', year:'numeric'})}`;
            calendarEl.appendChild(header);

            const table = document.createElement('table');
            table.style.width = '100%';
            table.style.borderCollapse = 'collapse';
            table.style.background = 'rgba(167,112,239,0.04)';
            table.style.border = '1.5px solid #a770ef44';

            const thead = document.createElement('thead');
            const tr = document.createElement('tr');
            const thTime = document.createElement('th');
            thTime.textContent = 'Time';
            thTime.style.background = 'rgba(167,112,239,0.09)';
            thTime.style.width = '100px';
            thTime.style.border = '1px solid #a770ef44';
            tr.appendChild(thTime);
            for (let i = 0; i < 7; i++) {
                const d = new Date(weekStart);
                d.setDate(weekStart.getDate() + i);
                const th = document.createElement('th');
                th.textContent = `${dayNames[d.getDay()]} ${d.getDate()}`;
                th.style.background = 'rgba(167,112,239,0.09)';
                th.style.width = 'calc((100% - 100px) / 7)';
                th.style.border = '1px solid #a770ef44';
                tr.appendChild(th);
            }
            thead.appendChild(tr);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            hourNames12.forEach(hour => {
                const row = document.createElement('tr');
                const timeCell = document.createElement('td');
                timeCell.textContent = hour;
                timeCell.style.fontWeight = 'bold';
                timeCell.style.background = 'rgba(167,112,239,0.04)';
                timeCell.style.width = '100px';
                timeCell.style.border = '1px solid #a770ef44';
                row.appendChild(timeCell);
                for (let i = 0; i < 7; i++) {
                const cell = document.createElement('td');
                cell.style.background = 'rgba(167,112,239,0.02)';
                cell.style.width = 'calc((100% - 100px) / 7)';
                cell.style.height = '32px';
                cell.style.borderRadius = '6px';
                cell.style.transition = 'background 0.2s';
                cell.style.cursor = 'pointer';
                cell.style.border = '1px solid #a770ef44';

                // Show holiday if this day is a holiday
                const d = new Date(weekStart);
                d.setDate(weekStart.getDate() + i);
                const dateStr = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                if (holidays[dateStr] && hour === '12:00 PM') {
                    cell.innerHTML = `<span style="color:#a770ef;font-weight:bold;">${holidays[dateStr]}</span>`;
                } else {
                    cell.textContent = '';
                }

                row.appendChild(cell);
                }
                tbody.appendChild(row);
            });
            table.appendChild(tbody);
            calendarEl.appendChild(table);
            }
            // Remove duplicated Day and Week view rendering here.
            else if (currentView === 'Month') {
            // Month view (default)
            const header = document.createElement('div');
            header.style.textAlign = 'center';
            header.style.fontWeight = 'bold';
            header.style.fontSize = '1.3em';
            header.style.marginBottom = '12px';
            header.textContent = `${monthNames[month]} ${year}`;
            calendarEl.appendChild(header);

            const table = document.createElement('table');
            table.style.width = '100%';
            table.style.height = '100%';
            table.style.borderCollapse = 'collapse';
            table.style.background = 'none';
            table.style.color = '#fff';

            const thead = document.createElement('thead');
            const tr = document.createElement('tr');
            dayNames.forEach(day => {
                const th = document.createElement('th');
                th.textContent = day;
                th.style.padding = '8px 0';
                th.style.fontWeight = 'bold';
                th.style.background = 'rgba(167,112,239,0.09)';
                th.style.borderRadius = '8px';
                tr.appendChild(th);
            });
            thead.appendChild(tr);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            let date = 1;
            for (let i = 0; i < 6; i++) {
                const row = document.createElement('tr');
                row.style.height = 'calc(100% / 6)';
                for (let j = 0; j < 7; j++) {
                const cell = document.createElement('td');
                cell.style.padding = '10px 0';
                cell.style.textAlign = 'center';
                cell.style.borderRadius = '8px';
                cell.style.transition = 'background 0.2s';
                cell.style.cursor = 'pointer';
                cell.style.width = 'calc(100% / 7)';

                if (i === 0 && j < firstDay.getDay()) {
                    cell.textContent = '';
                } else if (date > lastDay.getDate()) {
                    cell.textContent = '';
                } else {
                    const dateDiv = document.createElement('div');
                    dateDiv.textContent = date;
                    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(date).padStart(2,'0')}`;
                    if (holidays[dateStr]) {
                    const holidayDiv = document.createElement('div');
                    holidayDiv.textContent = holidays[dateStr];
                    holidayDiv.style.fontSize = '0.85em';
                    holidayDiv.style.marginTop = '4px';
                    holidayDiv.style.color = '#a770ef';
                    holidayDiv.style.fontWeight = 'bold';
                    cell.appendChild(dateDiv);
                    cell.appendChild(holidayDiv);
                    } else {
                    cell.appendChild(dateDiv);
                    }
                    if (
                    date === today.getDate() &&
                    month === today.getMonth() &&
                    year === today.getFullYear()
                    ) {
                    cell.style.background = 'rgba(167,112,239,0.18)';
                    cell.style.fontWeight = 'bold';
                    cell.style.color = '#fff';
                    }
                    cell.addEventListener('mouseenter', function() {
                    cell.style.background = 'rgba(167,112,239,0.28)';
                    });
                    cell.addEventListener('mouseleave', function() {
                    if (
                        date === today.getDate() &&
                        month === today.getMonth() &&
                        year === today.getFullYear()
                    ) {
                        cell.style.background = 'rgba(167,112,239,0.18)';
                    } else {
                        cell.style.background = 'none';
                    }
                    });
                    date++;
                }
                row.appendChild(cell);
                }
                tbody.appendChild(row);
                if (date > lastDay.getDate()) break;
            }
            table.appendChild(tbody);
            calendarEl.appendChild(table);
            } else if (currentView === 'Year') {
            // Year view: show all months, wrap to multiple rows
            const header = document.createElement('div');
            header.style.textAlign = 'center';
            header.style.fontWeight = 'bold';
            header.style.fontSize = '1.3em';
            header.style.marginBottom = '12px';
            header.textContent = `${year}`;
            calendarEl.appendChild(header);

            const monthsGrid = document.createElement('div');
            monthsGrid.style.display = 'grid';
            monthsGrid.style.gridTemplateColumns = 'repeat(auto-fit, minmax(220px, 1fr))';
            monthsGrid.style.gap = '18px';

            for (let m = 0; m < 12; m++) {
                const monthBox = document.createElement('div');
                monthBox.style.background = 'rgba(167,112,239,0.09)';
                monthBox.style.borderRadius = '12px';
                monthBox.style.padding = '8px';
                monthBox.style.boxShadow = '0 2px 8px rgba(31,38,135,0.08)';
                monthBox.style.color = '#fff';

                const monthTitle = document.createElement('div');
                monthTitle.textContent = monthNames[m];
                monthTitle.style.fontWeight = 'bold';
                monthTitle.style.marginBottom = '6px';
                monthBox.appendChild(monthTitle);

                const table = document.createElement('table');
                table.style.width = '100%';
                table.style.borderCollapse = 'collapse';
                const thead = document.createElement('thead');
                const tr = document.createElement('tr');
                dayNames.forEach(day => {
                const th = document.createElement('th');
                th.textContent = day[0];
                th.style.fontSize = '0.85em';
                th.style.background = 'rgba(167,112,239,0.07)';
                tr.appendChild(th);
                });
                thead.appendChild(tr);
                table.appendChild(thead);

                const tbody = document.createElement('tbody');
                let firstDayMonth = new Date(year, m, 1);
                let lastDayMonth = new Date(year, m + 1, 0);
                let date = 1;
                for (let i = 0; i < 6; i++) {
                const row = document.createElement('tr');
                for (let j = 0; j < 7; j++) {
                    const cell = document.createElement('td');
                    cell.style.textAlign = 'center';
                    cell.style.fontSize = '0.85em';
                    cell.style.padding = '2px';
                    if (i === 0 && j < firstDayMonth.getDay()) {
                    cell.textContent = '';
                    } else if (date > lastDayMonth.getDate()) {
                    cell.textContent = '';
                    } else {
                    cell.textContent = date;
                    date++;
                    }
                    row.appendChild(cell);
                }
                tbody.appendChild(row);
                if (date > lastDayMonth.getDate()) break;
                }
                table.appendChild(tbody);
                monthBox.appendChild(table);
                monthsGrid.appendChild(monthBox);
            }
            calendarEl.appendChild(monthsGrid);
            } else if (currentView === 'Timeline') {
            // Timeline view: show all holidays for the year
            const header = document.createElement('div');
            header.style.textAlign = 'center';
            header.style.fontWeight = 'bold';
            header.style.fontSize = '1.3em';
            header.style.marginBottom = '12px';
            header.textContent = `Holidays Timeline ${year}`;
            calendarEl.appendChild(header);

            const list = document.createElement('ul');
            list.style.listStyle = 'none';
            list.style.padding = '0';
            list.style.margin = '0';
            Object.keys(holidays).sort().forEach(dateStr => {
                const li = document.createElement('li');
                li.style.padding = '8px 0';
                li.style.borderBottom = '1px solid rgba(167,112,239,0.09)';
                li.innerHTML = `<span style="font-weight:bold;color:#a770ef">${dateStr}</span> — ${holidays[dateStr]}`;
                list.appendChild(li);
            });
            calendarEl.appendChild(list);
            } else if (currentView === 'Agenda') {
            // Agenda view: show upcoming holidays/events for the month
            const header = document.createElement('div');
            header.style.textAlign = 'center';
            header.style.fontWeight = 'bold';
            header.style.fontSize = '1.3em';
            header.style.marginBottom = '12px';
            header.textContent = `Agenda for ${monthNames[month]} ${year}`;
            calendarEl.appendChild(header);

            const list = document.createElement('ul');
            list.style.listStyle = 'none';
            list.style.padding = '0';
            list.style.margin = '0';
            let found = false;
            Object.keys(holidays).sort().forEach(dateStr => {
                const d = new Date(dateStr);
                if (d.getFullYear() === year && d.getMonth() === month) {
                found = true;
                const li = document.createElement('li');
                li.style.padding = '8px 0';
                li.style.borderBottom = '1px solid rgba(167,112,239,0.09)';
                li.innerHTML = `<span style="font-weight:bold;color:#a770ef">${dateStr}</span> — ${holidays[dateStr]}`;
                list.appendChild(li);
                }
            });
            if (!found) {
                const li = document.createElement('li');
                li.textContent = 'No holidays/events this month.';
                list.appendChild(li);
            }
            calendarEl.appendChild(list);
            }
        }
        // Month navigation logic
        renderCalendar(currentYear, currentMonth);

        function toggleDropdown(e) {
            e.stopPropagation();
            var dropdown = document.getElementById('viewDropdown');
            var expanded = dropdown.style.display === 'block';
            dropdown.style.display = expanded ? 'none' : 'block';
            document.getElementById('viewBtn').setAttribute('aria-expanded', !expanded);
        }
        document.getElementById('viewBtn').addEventListener('click', toggleDropdown);

        // Hide dropdown when clicking outside
        document.addEventListener('click', function(e) {
            var dropdown = document.getElementById('viewDropdown');
            if (dropdown.style.display === 'block') {
                dropdown.style.display = 'none';
                document.getElementById('viewBtn').setAttribute('aria-expanded', false);
            }
        });

        // Prevent dropdown from closing when clicking inside
        document.getElementById('viewDropdown').addEventListener('click', function(e) {
            e.stopPropagation();
        });

        // Declare currentDay and currentWeekStart as global variables
        let currentDay = new Date(currentYear, currentMonth, today.getDate());
        let currentWeekStart = new Date(currentDay);
        currentWeekStart.setDate(currentDay.getDate() - currentDay.getDay());

        document.getElementById('arrowLeftBtn').addEventListener('click', function() {
            if (currentView === 'Month' || currentView === 'Agenda') {
                currentMonth--;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                }
                renderCalendar(currentYear, currentMonth);
            } else if (currentView === 'Year' || currentView === 'Timeline') {
                currentYear--;
                renderCalendar(currentYear, currentMonth);
            } else if (currentView === 'Day') {
                currentDay.setDate(currentDay.getDate() - 1);
                currentYear = currentDay.getFullYear();
                currentMonth = currentDay.getMonth();
                renderCalendar(currentYear, currentMonth);
            } else if (currentView === 'Week') {
                currentWeekStart.setDate(currentWeekStart.getDate() - 7);
                currentYear = currentWeekStart.getFullYear();
                currentMonth = currentWeekStart.getMonth();
                renderCalendar(currentYear, currentMonth);
            }
        });

        document.getElementById('arrowRightBtn2').addEventListener('click', function() {
            if (currentView === 'Month' || currentView === 'Agenda') {
                currentMonth++;
                if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                renderCalendar(currentYear, currentMonth);
            } else if (currentView === 'Year' || currentView === 'Timeline') {
                currentYear++;
                renderCalendar(currentYear, currentMonth);
            } else if (currentView === 'Day') {
                currentDay.setDate(currentDay.getDate() + 1);
                currentYear = currentDay.getFullYear();
                currentMonth = currentDay.getMonth();
                renderCalendar(currentYear, currentMonth);
            } else if (currentView === 'Week') {
                currentWeekStart.setDate(currentWeekStart.getDate() + 7);
                currentYear = currentWeekStart.getFullYear();
                currentMonth = currentWeekStart.getMonth();
                renderCalendar(currentYear, currentMonth);
            }
        });

        // Update currentDay/currentWeekStart when view changes
        function selectView(view) {
            currentView = view;
            if (view === 'Day') {
                currentDay = new Date(currentYear, currentMonth, today.getDate());
            }
            if (view === 'Week') {
                currentWeekStart = new Date(currentYear, currentMonth, today.getDate());
                currentWeekStart.setDate(currentWeekStart.getDate() - currentWeekStart.getDay());
            }
            renderCalendar(currentYear, currentMonth);
            var dropdown = document.getElementById('viewDropdown');
            dropdown.style.display = 'none';
            document.getElementById('viewBtn').setAttribute('aria-expanded', false);
        }
        document.addEventListener('DOMContentLoaded', function() {
            var todaySpan = document.getElementById('todayDate');
            if (todaySpan) {
                var today = new Date();
                var options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                todaySpan.textContent = today.toLocaleDateString(undefined, options);
            }
    
            // Check for ?createevent=... in URL and pre-fill/create event
            const params = new URLSearchParams(window.location.search);
            if (params.has('createevent')) {
                const type = params.get('createevent');
                if (type === 'event') {
                    document.getElementById('eventTitle').value = params.get('title') || '';
                    document.getElementById('eventDescription').value = params.get('des') || '';
                    document.getElementById('eventTime').value = params.get('time') || '';
                    document.getElementById('eventDate').value = params.get('date') || '';
                    document.getElementById('createEventModal').style.display = 'flex';
                } else if (type === 'birthday') {
                    document.getElementById('birthdayName').value = params.get('title') ? params.get('title').replace(/'s Birthday$/, '') : '';
                    document.getElementById('birthdayDescription').value = params.get('des') || '';
                    document.getElementById('birthdayDate').value = params.get('date') || '';
                    document.getElementById('createBirthdayModal').style.display = 'flex';
                } else if (type === 'holiday') {
                    document.getElementById('holidayTitle').value = params.get('title') || '';
                    document.getElementById('holidayDescription').value = params.get('des') || '';
                    document.getElementById('holidayDate').value = params.get('date') || '';
                    document.getElementById('createHolidayModal').style.display = 'flex';
                }
            }
        });
    </script>
</body>
</html>
